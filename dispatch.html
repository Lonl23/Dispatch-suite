<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dispatch ‚Äì Tableau de garde</title>
<style>
  :root{--bg:#071022;--panel:#0f1724;--line:#213243;--txt:#eef3fb;--mut:#9fb3d0}
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:Segoe UI,Inter,Arial,sans-serif}
  header{background:#111b2b;border-bottom:1px solid var(--line);padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
  header h1{margin:0;font-size:20px;color:#cfe1ff}
  header .actions button{background:#2f7bf6;border:0;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin:12px auto;width:92%;max-width:1200px}
  h2{margin:0 0 10px;color:#cfe1ff;font-size:18px}
  label{font-size:13px;color:var(--mut)}
  input,select,textarea{width:100%;box-sizing:border-box;padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:#081427;color:#fff}
  textarea{min-height:80px;resize:vertical}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--line);padding:6px;text-align:center;vertical-align:top}
  th{background:#13233b;color:#dbe7ff;font-size:13px}
  .mut{color:var(--mut);font-size:12px}
  .stats{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-top:10px}
  .stat{background:#102030;border:1px solid var(--line);border-radius:8px;padding:8px;text-align:center}
  .warn{color:#ffcc66;font-size:13px;margin:0 12px}
</style>
</head>
<body>

<!-- Guard simple : n√©cessite d‚Äô√™tre pass√© par index.html -->
<script>
(function(){
  if(!localStorage.getItem("dispatch_idToken")) location.href="index.html";
})();
</script>

<script src="store-bridge.js"></script>

<header>
  <h1>Tableau de garde ‚Äì Dispatch</h1>
  <div class="actions">
    <button id="paramBtn" type="button">Param√©trages</button>
  </div>
</header>

<p class="warn" id="roleWarn" style="display:none">
  ‚ö†Ô∏è Vous √™tes connect√© en lecture seule (non <b>centrale@acsrs.be</b>). Les changements peuvent √™tre refus√©s par la base.
</p>

<div class="card">
  <h2>R√¥les de commandement</h2>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px">
    <div><label>Officier de semaine</label><input data-role="officier_semaine"></div>
    <div><label>Officier de garde</label><input data-role="officier_garde"></div>
    <div><label>Responsable op√©rations</label><input data-role="responsable_operations"></div>
    <div><label>Chef de groupe</label><input data-role="chef_groupe"></div>
    <div><label>Chef de poste</label><input data-role="chef_poste"></div>
    <div><label>1er centraliste</label><input data-role="centraliste_1"></div>
    <div><label>2e centraliste</label><input data-role="centraliste_2"></div>
  </div>
</div>

<div class="card">
  <h2>Notes globales</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
    <div><label>üß∞ Mat√©riel √† r√©cup√©rer</label><textarea id="note_materiel"></textarea></div>
    <div><label>‚ÑπÔ∏è Informations & remarques</label><textarea id="note_infos"></textarea></div>
  </div>
  <p class="mut">Ces notes s‚Äôaffichent dans la banni√®re TV.</p>
</div>

<div class="card">
  <h2>V√©hicules</h2>
  <div style="overflow:auto;max-height:60vh">
    <table>
      <thead>
        <tr>
          <th>V√©hicule</th>
          <th>Attribution</th>
          <th>Chauffeur</th>
          <th>Soins</th>
          <th>3·µâ Homme</th>
          <th>Km</th>
          <th>Statut</th>
          <th>Commentaire</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="stats">
    <div class="stat">Disponibles<br><b id="cDispo">0</b></div>
    <div class="stat">Sortis<br><b id="cSorti">0</b></div>
    <div class="stat">R√©serve<br><b id="cReserve">0</b></div>
    <div class="stat">Indisponibles<br><b id="cIndispo">0</b></div>
  </div>
</div>

<script>
/* ============ Config / √©tat ============ */
const STORAGE_KEY = "dispatch_parc_vehicules";
const ATTRIBS = ["","LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8","TMS","PREV","OFF"];
const ORDER  = ["LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8","TMS","PREV","OFF"];
const rankMap = Object.fromEntries(ORDER.map((k,i)=>[k,i]));

let data = {};
let pollTimer = null;
let pollPaused = false;

const isCentral = (localStorage.getItem("dispatch_email")||"").toLowerCase()==="centrale@acsrs.be";
if(!isCentral) document.getElementById('roleWarn').style.display='block';

const $ = id => document.getElementById(id);

/* ============ Utils ============ */
function attribRank(str){ const k=(str||"").toUpperCase(); return k in rankMap?rankMap[k]:999; }
function sortVehsForDispatch(vehs){
  return (vehs||[]).slice().sort((a,b)=>{
    const da = data[a.id] || {};
    const db = data[b.id] || {};
    const aKey = (da.attribution || a.attrib || "").toUpperCase();
    const bKey = (db.attribution || b.attrib || "").toUpperCase();
    const ra = attribRank(aKey), rb = attribRank(bKey);
    if(ra!==rb) return ra-rb;
    return (a.id||"").localeCompare(b.id||"");
  });
}
function ensure(){
  if(!data || typeof data!=='object') data={};
  if(!data._settings) data._settings = { vehs: [] };
  if(!data._roles) data._roles = {
    officier_semaine:"", officier_garde:"", responsable_operations:"",
    chef_groupe:"", chef_poste:"", centraliste_1:"", centraliste_2:""
  };
  if(!data._notes) data._notes = { materiel:"", infos:"" };
  (data._settings.vehs||[]).forEach(v=>{
    if(!data[v.id]) data[v.id] = {
      XO:"", S:"", PS:"", km:"", statut:"Disponible", commentaire:"",
      attribution: v.attrib||"", plaque: v.plaque||"", name: v.name||v.id
    };
  });
}
function pausePolling(){ pollPaused = true; }
function resumePolling(){ pollPaused = false; }
function isEditingAField(){
  const ae = document.activeElement;
  return !!(ae && (ae.matches?.('input[data-v], select[data-v], textarea#note_materiel, textarea#note_infos, [data-role]')));
}

/* ============ Rendu ============ */
function renderAll(){ renderRoles(); renderNotes(); renderTable(); renderStats(); bindEditors(); }

function renderRoles(){
  document.querySelectorAll('[data-role]').forEach(inp=>{
    const k = inp.dataset.role;
    inp.value = data._roles[k] || "";
  });
}

function renderNotes(){
  $('note_materiel').value = data._notes.materiel || "";
  $('note_infos').value    = data._notes.infos    || "";
}

function renderTable(){
  const tb = $('tbody'); tb.innerHTML="";
  const vehsSorted = sortVehsForDispatch(data._settings.vehs || []);
  vehsSorted.forEach(v=>{
    const d = data[v.id];
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td><b>${d.name||v.id}</b><br><span class="mut">${d.plaque||""}</span></td>
        <td>
          <select data-v="${v.id}" data-k="attribution">
            ${ATTRIBS.map(a=>`<option ${a===(d.attribution||"")?"selected":""}>${a}</option>`).join("")}
          </select>
        </td>
        <td><input data-v="${v.id}" data-k="XO" value="${d.XO||""}" placeholder="Chauffeur"></td>
        <td><input data-v="${v.id}" data-k="S" value="${d.S||""}" placeholder="Soins"></td>
        <td><input data-v="${v.id}" data-k="PS" value="${d.PS||""}" placeholder="3e"></td>
        <td><input data-v="${v.id}" data-k="km" value="${d.km||""}" inputmode="numeric" placeholder="Km"></td>
        <td>
          <select data-v="${v.id}" data-k="statut">
            ${["Disponible","Sorti","R√©serve","Indisponible"].map(s=>`<option ${s===(d.statut||"")?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td><input data-v="${v.id}" data-k="commentaire" value="${d.commentaire||""}" placeholder="Remarque"></td>
      </tr>
    `);
  });
}

/* ============ Bindings anti-√©jection ============ */
function bindEditors(){
  // V√©hicules
  document.querySelectorAll('input[data-v],select[data-v]').forEach(el=>{
    el.onfocus = () => pausePolling();

    el.oninput = async ()=>{
      const id = el.dataset.v, k = el.dataset.k;
      if(k==="km") el.value = el.value.replace(/[^\d]/g,'');
      if(!data[id]) data[id]={};
      data[id][k] = el.value;
      try{ await saveKey(STORAGE_KEY, data); }catch(e){ console.warn("Save refus√©e/erreur:", e); }

      if(k !== "statut" && k !== "attribution"){
        renderStats(); // maj l√©g√®re uniquement
      }
    };

    el.onblur = ()=>{
      renderStats();
      // Si tri potentiellement affect√©, on rerend la table ici (pas pendant la frappe)
      const k = el.dataset.k;
      if(k==="statut" || k==="attribution"){
        renderTable();
        // rebinder car on a r√©inject√© le DOM de la table
        bindEditors();
      }
      setTimeout(()=>resumePolling(), 300);
    };
  });

  // R√¥les
  document.querySelectorAll('[data-role]').forEach(inp=>{
    inp.onfocus = pausePolling;
    inp.oninput = async e=>{
      const k = inp.dataset.role;
      if(!data._roles) data._roles = {};
      data._roles[k] = e.target.value;
      try{ await saveKey(STORAGE_KEY, data); }catch(e){ console.warn("Save refus√©e/erreur:", e); }
    };
    inp.onblur = ()=> setTimeout(()=>resumePolling(), 300);
  });

  // Notes
  ['note_materiel','note_infos'].forEach(id=>{
    const t = document.getElementById(id);
    if(!t) return;
    t.onfocus = pausePolling;
    t.oninput = async e=>{
      if(!data._notes) data._notes = {};
      data._notes[id==='note_materiel'?'materiel':'infos'] = e.target.value;
      try{ await saveKey(STORAGE_KEY, data); }catch(e){ console.warn("Save refus√©e/erreur:", e); }
    };
    t.onblur = ()=> setTimeout(()=>resumePolling(), 300);
  });
}

/* ============ Stats ============ */
function renderStats(){
  const list = (data._settings.vehs||[]).map(v=>data[v.id]);
  $('cDispo').textContent   = list.filter(x=>x.statut==="Disponible").length;
  $('cSorti').textContent   = list.filter(x=>x.statut==="Sorti").length;
  $('cReserve').textContent = list.filter(x=>x.statut==="R√©serve").length;
  $('cIndispo').textContent = list.filter(x=>x.statut==="Indisponible").length;
}

/* ============ Polling ‚Äúsafe‚Äù ============ */
async function safePoll(){
  if(pollPaused || isEditingAField()) return;
  const fresh = await readKey(STORAGE_KEY) || {};
  if(JSON.stringify(fresh)!==JSON.stringify(data)){
    data = fresh; ensure(); renderAll();
  }
}
function startPolling(){
  if(pollTimer) clearInterval(pollTimer);
  pollTimer = setInterval(safePoll, 5000);
}

/* ============ Boot ============ */
async function boot(){
  if(typeof readKey!=='function'){ alert("store-bridge.js manquant"); return; }
  data = await readKey(STORAGE_KEY) || {};
  ensure(); renderAll(); startPolling();
}
boot();

/* ============ Actions ============ */
document.getElementById("paramBtn").onclick = ()=> window.open("parametres.html","_blank");
</script>
</body>
</html>
