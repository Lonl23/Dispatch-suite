<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dispatch ‚Äì Tableau de garde</title>
<style>
  body {
    margin:0;
    font-family:Segoe UI,Inter,sans-serif;
    background:#0a0f16;
    color:#f1f5fa;
  }
  header {
    background:#111b2b;
    padding:10px 20px;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  header h1 { margin:0; font-size:26px; color:#cfe1ff; }
  header button {
    background:#3a8bf2;
    color:white;
    border:none;
    padding:6px 14px;
    border-radius:8px;
    cursor:pointer;
    font-size:16px;
  }
  main { padding:15px; }
  table {
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
    font-size:15px;
  }
  th,td {
    border:1px solid #1f2c3e;
    padding:6px;
    text-align:center;
  }
  th { background:#182030; }
  input, select, textarea {
    width:95%;
    background:#111b2b;
    color:#f1f5fa;
    border:1px solid #2a364d;
    border-radius:4px;
    padding:4px;
    font-size:14px;
  }
  textarea { height:60px; resize:none; }
  .notes {
    margin-top:20px;
    display:flex;
    gap:10px;
  }
  .notes div {
    flex:1;
    display:flex;
    flex-direction:column;
  }
  .notes label { margin-bottom:4px; font-weight:bold; }
  .roles {
    margin-top:15px;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
    gap:10px;
  }
  .roles div { display:flex; flex-direction:column; }
  .roles label { font-weight:bold; margin-bottom:4px; }
</style>
</head>
<body>
<script src="store-bridge.js"></script>

<header>
  <h1>Tableau de garde</h1>
  <button onclick="window.open('parametres.html','_blank')">Param√©trages</button>
</header>

<main>
  <div class="roles">
    <div><label>Officier de semaine</label><input data-rolekey="officier_semaine"></div>
    <div><label>Officier de garde</label><input data-rolekey="officier_garde"></div>
    <div><label>Responsable op√©rations</label><input data-rolekey="responsable_operations"></div>
    <div><label>Chef de groupe</label><input data-rolekey="chef_groupe"></div>
    <div><label>Chef de poste</label><input data-rolekey="chef_poste"></div>
    <div><label>1er centraliste</label><input data-rolekey="centraliste_1"></div>
    <div><label>2√®me centraliste</label><input data-rolekey="centraliste_2"></div>
  </div>

  <table id="dispatchTable">
    <thead>
      <tr>
        <th>V√©hicule</th>
        <th>Attribution</th>
        <th>Chauffeur</th>
        <th>Soins</th>
        <th>3·µâ homme</th>
        <th>Kilom√©trage</th>
        <th>Statut</th>
        <th>Commentaire</th>
      </tr>
    </thead>
    <tbody id="vehBody"></tbody>
  </table>

  <div class="notes">
    <div>
      <label>üß∞ Mat√©riel √† r√©cup√©rer</label>
      <textarea id="materiel"></textarea>
    </div>
    <div>
      <label>‚ÑπÔ∏è Informations et remarques</label>
      <textarea id="infos"></textarea>
    </div>
  </div>
</main>

<script>
const STORAGE_KEY = "dispatch_parc_vehicules";
let data = {};
let typingTimeout = null;
let isEditing = false;

/* Chargement initial */
async function refresh() {
  if (isEditing) return; // suspend la synchro pendant l'√©dition
  const d = await readKey(STORAGE_KEY) || {};
  data = d;
  ensure();
  renderRoles();
  renderVehs();
  renderNotes();
}

/* Cr√©ation si vide */
function ensure() {
  if (!data || typeof data !== 'object') data = {};
  if (!data._settings) data._settings = { vehs: [] };
  if (!data._roles) data._roles = {
    officier_semaine:"", officier_garde:"",
    responsable_operations:"", chef_groupe:"",
    chef_poste:"", centraliste_1:"", centraliste_2:""
  };
  if (!data._notes) data._notes = { materiel:"", infos:"" };
}

/* Sauvegarde */
async function save() {
  await saveKey(STORAGE_KEY, data);
}

/* R√¥les */
function renderRoles() {
  document.querySelectorAll('[data-rolekey]').forEach(inp=>{
    const k = inp.dataset.rolekey;
    inp.value = data._roles[k] || "";
    inp.oninput = async (e)=>{
      isEditing = true;
      clearTimeout(typingTimeout);
      data._roles[k] = e.target.value;
      await save();
      typingTimeout = setTimeout(()=>isEditing=false, 2000);
    };
  });
}

/* Notes */
function renderNotes() {
  document.getElementById("materiel").value = data._notes.materiel || "";
  document.getElementById("infos").value = data._notes.infos || "";

  document.getElementById("materiel").oninput = async (e)=>{
    isEditing = true;
    clearTimeout(typingTimeout);
    data._notes.materiel = e.target.value;
    await save();
    typingTimeout = setTimeout(()=>isEditing=false, 2000);
  };
  document.getElementById("infos").oninput = async (e)=>{
    isEditing = true;
    clearTimeout(typingTimeout);
    data._notes.infos = e.target.value;
    await save();
    typingTimeout = setTimeout(()=>isEditing=false, 2000);
  };
}

/* V√©hicules */
function renderVehs() {
  const tb = document.getElementById("vehBody");
  tb.innerHTML = "";
  const vehs = (data._settings?.vehs) || [];
  vehs.forEach(v=>{
    const d = data[v.id] || {};
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${d.name||v.id}</td>
      <td>${d.attribution||""}</td>
      <td><input data-id="${v.id}" data-f="XO" value="${d.XO||""}"></td>
      <td><input data-id="${v.id}" data-f="S" value="${d.S||""}"></td>
      <td><input data-id="${v.id}" data-f="PS" value="${d.PS||""}"></td>
      <td><input data-id="${v.id}" data-f="km" value="${d.km||""}" type="number" min="0"></td>
      <td>
        <select data-id="${v.id}" data-f="statut">
          ${["Disponible","Sorti","R√©serve","Indisponible"].map(s=>`<option ${s===(d.statut||"")?"selected":""}>${s}</option>`).join("")}
        </select>
      </td>
      <td><input data-id="${v.id}" data-f="commentaire" value="${d.commentaire||""}"></td>
    `;
    tb.appendChild(row);
  });

  tb.querySelectorAll("input,select").forEach(inp=>{
    inp.oninput = async (e)=>{
      isEditing = true;
      clearTimeout(typingTimeout);
      const id = e.target.dataset.id;
      const field = e.target.dataset.f;
      const val = e.target.value;
      if (!data[id]) data[id] = {};
      data[id][field] = val;
      await save();
      typingTimeout = setTimeout(()=>isEditing=false, 2000);
    };
  });
}

/* D√©marrage */
refresh();
setInterval(()=>{ if(!isEditing) refresh(); }, 5000);
</script>
</body>
</html>
