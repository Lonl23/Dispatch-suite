<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dispatch - Tableau de garde</title>
<style>
body {
  font-family: Arial, sans-serif;
  background: #0b0f14;
  color: #e6e6e6;
  margin: 0;
  padding: 0;
}
header {
  background: #1b2733;
  padding: 10px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
button {
  background: #2a80d8;
  border: none;
  color: #fff;
  padding: 6px 12px;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background: #3c92ed; }

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}
th, td {
  border: 1px solid #2d3a4a;
  padding: 6px;
  text-align: center;
}
th { background: #18222f; }

input, select, textarea {
  background: #141a22;
  border: 1px solid #333;
  color: #fff;
  border-radius: 4px;
  padding: 4px;
  width: 100%;
}

/* Modale Param√©trages */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
}
.modal.show { display: flex; }
.modal .box {
  background: #121821;
  padding: 20px;
  border-radius: 10px;
  width: 90%;
  max-width: 600px;
  color: #fff;
}
.modal .box h3 {
  margin-top: 0;
  text-align: center;
}
.modal input { width: 100%; margin-bottom: 6px; }
</style>
</head>

<body>
<header>
  <h2>üöë Dispatch ‚Äì Tableau de garde</h2>
  <button onclick="openSettings()">‚öôÔ∏è Param√©trages</button>
</header>

<main>
  <table id="vehTable">
    <thead>
      <tr>
        <th>V√©hicule</th>
        <th>Chauffeur</th>
        <th>Soins</th>
        <th>3·µâ homme</th>
        <th>Statut</th>
        <th>Commentaire</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<!-- MODALE PARAMETRAGES -->
<div id="modalSettings" class="modal">
  <div class="box">
    <h3>Param√©trages ‚Äì Gestion des v√©hicules</h3>
    <table id="vehSettings" style="width:100%;">
      <thead>
        <tr>
          <th>Nom</th>
          <th>Attribution</th>
          <th>Plaque</th>
          <th>Supprimer</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h4>Ajouter un v√©hicule</h4>
    <input id="nv_nom" placeholder="Nom du v√©hicule (ex: AS 55)">
    <input id="nv_attr" placeholder="Attribution (ex: LH1)">
    <input id="nv_plaq" placeholder="Plaque (ex: 1-ABC-123)">
    <button onclick="addVehicle()">Ajouter</button>
    <button onclick="closeSettings()">Fermer</button>
  </div>
</div>

<script src="store-bridge.js"></script>
<script>
const STORAGE_KEY = "dispatch_parc_vehicules";
let data = {};
let vehs = [];

// Lecture initiale depuis Firebase
(async ()=>{
  data = await readKey(STORAGE_KEY) || {};
  vehs = data._settings?.vehs || [];
  renderTable();
})();

// Sauvegarde auto
function save(){ saveKey(STORAGE_KEY, data); }

// --- Rendu du tableau principal ---
function renderTable(){
  const tb = document.querySelector("#vehTable tbody");
  tb.innerHTML = "";
  vehs.forEach(v=>{
    if(!data[v.id]) data[v.id]={XO:"",S:"",PS:"",statut:"Disponible",commentaire:""};
    const d = data[v.id];
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.id}</td>
      <td><input value="${d.XO}" onchange="d.XO=this.value;save();"></td>
      <td><input value="${d.S}" onchange="d.S=this.value;save();"></td>
      <td><input value="${d.PS}" onchange="d.PS=this.value;save();"></td>
      <td>
        <select onchange="d.statut=this.value;save();">
          ${["Disponible","R√©serve","Sorti","Indisponible"].map(s=>`<option ${d.statut===s?"selected":""}>${s}</option>`).join("")}
        </select>
      </td>
      <td><textarea onchange="d.commentaire=this.value;save();">${d.commentaire||""}</textarea></td>
    `;
    tb.appendChild(tr);
  });
}

// --- Modale ---
function openSettings(){ renderSettings(); document.getElementById("modalSettings").classList.add("show"); }
function closeSettings(){ document.getElementById("modalSettings").classList.remove("show"); }

// --- Rendu Param√©trages ---
function renderSettings(){
  const sb = document.querySelector("#vehSettings tbody");
  sb.innerHTML = "";
  vehs.forEach((v,i)=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${v.id}</td>
      <td>${v.attrib||""}</td>
      <td>${v.plaque||""}</td>
      <td><button onclick="delVehicle(${i})">üóëÔ∏è</button></td>
    `;
    sb.appendChild(tr);
  });
}

// --- Ajout/Suppression v√©hicules ---
function addVehicle(){
  const id = nv_nom.value.trim();
  if(!id) return alert("Nom du v√©hicule requis.");
  const attrib = nv_attr.value.trim();
  const plaque = nv_plaq.value.trim();
  if(vehs.find(v=>v.id===id)) return alert("Ce v√©hicule existe d√©j√† !");
  vehs.push({id,attrib,plaque});
  data._settings = {vehs};
  data[id]={XO:"",S:"",PS:"",statut:"Disponible",commentaire:""};
  save();
  renderSettings();
  renderTable();
  nv_nom.value=nv_attr.value=nv_plaq.value="";
}
function delVehicle(i){
  const v = vehs[i];
  if(!confirm("Supprimer " + v.id + " ?")) return;
  delete data[v.id];
  vehs.splice(i,1);
  data._settings={vehs};
  save();
  renderSettings();
  renderTable();
}
</script>
</body>
</html>
