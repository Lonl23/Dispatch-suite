<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch ‚Äì Tableau de garde</title>

<style>
:root {
  --bg:#071022;--panel:#0f1724;--line:#213243;
  --txt:#eef3fb;--mut:#9fb3d0;--accent:#2f7bf6;
}
body {
  background:var(--bg);
  color:var(--txt);
  font-family:"Segoe UI",Arial,sans-serif;
  margin:0;
  padding:0;
}
h1 {
  text-align:center;
  margin:20px 0;
}
section {
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  margin:12px auto;
  width:90%;
  max-width:1200px;
}
label {
  color:var(--mut);
  font-size:13px;
}
input,textarea,select {
  background:#081427;
  color:#fff;
  border:1px solid var(--line);
  border-radius:8px;
  padding:6px 8px;
  margin-bottom:8px;
  width:100%;
  font-size:14px;
}
textarea {
  resize:none;
}
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
}
th,td {
  border:1px solid var(--line);
  padding:8px;
  text-align:center;
}
th {
  background:#13233b;
}
.statusBox {
  display:flex;
  justify-content:space-evenly;
  margin-top:10px;
}
.statusBox div {
  flex:1;
  text-align:center;
  padding:8px;
  border-radius:8px;
  background:#102030;
  margin:0 4px;
  color:#fff;
  font-size:14px;
  font-weight:600;
}
@media (max-width:700px){
  table{font-size:12px}
  th,td{padding:6px}
}
</style>
</head>

<body>
<h1>Tableau de garde</h1>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<!-- üîê Garde d'acc√®s : redirection UNIQUEMENT si acc√®s direct sans login -->
<script>
(function ensureAuth(){
  const token = localStorage.getItem("dispatch_idToken");
  const cameFromIndex = localStorage.getItem("dispatch_logged_via_index");
  // Si pas de token OU pas pass√© par l'√©cran d'accueil => on renvoie vers index
  if(!token || !cameFromIndex){
    location.href = "index.html";
    return;
  }
})();
</script>

<!-- ==================== CONTENU PAGE ==================== -->

<section id="commandement">
  <h2>Postes de commandement</h2>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px;">
    <div>
      <label>Officier de semaine</label>
      <input id="off_sem" />
    </div>
    <div>
      <label>Officier de garde</label>
      <input id="off_gar" />
    </div>
    <div>
      <label>Chef de groupe</label>
      <input id="chef_grp" />
    </div>
    <div>
      <label>Chef de poste</label>
      <input id="chef_poste" />
    </div>
    <div>
      <label>Responsable des op√©rations</label>
      <input id="resp_op" />
    </div>
    <div>
      <label>1er centraliste</label>
      <input id="cent1" />
    </div>
    <div>
      <label>2e centraliste</label>
      <input id="cent2" />
    </div>
  </div>
</section>

<section id="notes">
  <h2>Notes globales</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
    <div>
      <label>Mat√©riel √† r√©cup√©rer</label>
      <textarea id="mat_recup" rows="3" placeholder="Ex: Oxyg√®ne, attelles..."></textarea>
    </div>
    <div>
      <label>Informations & remarques</label>
      <textarea id="infos" rows="3" placeholder="Ex: Route barr√©e rue X, travaux..."></textarea>
    </div>
  </div>
</section>

<section id="vehicules">
  <h2>V√©hicules</h2>

  <table id="tableVeh">
    <thead>
      <tr>
        <th>V√©hicule</th>
        <th>Attribution</th>
        <th>Chauffeur</th>
        <th>Soins</th>
        <th>3·µâ Homme</th>
        <th>Statut</th>
        <th>Commentaire</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="statusBox">
    <div id="nbDispo">Disponibles : 0</div>
    <div id="nbSortis">Sortis : 0</div>
    <div id="nbRes">R√©serve : 0</div>
    <div id="nbIndispo">Indisponibles : 0</div>
  </div>
</section>

<script>
// ==================== CONFIG FIREBASE ====================
const firebaseConfig = {
  apiKey: "AIzaSyCP6ZClAectP8OPneAeOYGYdRYO0CvnbnQ",
  authDomain: "racs-dispatch.firebaseapp.com",
  databaseURL: "https://racs-dispatch-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "racs-dispatch",
  storageBucket: "racs-dispatch.firebasestorage.app",
  messagingSenderId: "589135271261",
  appId: "1:589135271261:web:d080a5da49a061929b84b4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ==================== R√âF√âRENCES DB ====================
const refCmd   = db.ref("dispatch_commandement");
const refNotes = db.ref("dispatch_notes");
const refVeh   = db.ref("dispatch_parc_vehicules");

// ==================== MISE √Ä JOUR AUTOMATIQUE DES BLOCS ====================

// 1. Commandement
refCmd.on("value", snap => {
  const v = snap.val() || {};
  off_sem.value     = v.off_sem     || "";
  off_gar.value     = v.off_gar     || "";
  chef_grp.value    = v.chef_grp    || "";
  chef_poste.value  = v.chef_poste  || "";
  resp_op.value     = v.resp_op     || "";
  cent1.value       = v.cent1       || "";
  cent2.value       = v.cent2       || "";
});

// sauvegarde quand on change un champ dans la zone commandement
document.querySelectorAll("#commandement input").forEach(inp => {
  inp.addEventListener("change", () => {
    refCmd.update({
      off_sem:     off_sem.value,
      off_gar:     off_gar.value,
      chef_grp:    chef_grp.value,
      chef_poste:  chef_poste.value,
      resp_op:     resp_op.value,
      cent1:       cent1.value,
      cent2:       cent2.value
    });
  });
});

// 2. Notes globales
refNotes.on("value", snap => {
  const v = snap.val() || {};
  mat_recup.value = v.mat_recup || "";
  infos.value     = v.infos     || "";
});

document.querySelectorAll("#notes textarea").forEach(txt => {
  txt.addEventListener("change", () => {
    refNotes.update({
      mat_recup: mat_recup.value,
      infos:     infos.value
    });
  });
});

// 3. V√©hicules
refVeh.on("value", snap => {
  const tbody = document.querySelector("#tableVeh tbody");
  tbody.innerHTML = "";

  const vehData = snap.val() || {};
  let dispo=0, sorti=0, res=0, indispo=0;

  Object.entries(vehData).forEach(([id, v]) => {
    // v doit contenir : attribution, chauffeur, soigneur, h3, statut, commentaire
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${id}</td>
      <td><input value="${v.attribution||""}" data-key="${id}" data-field="attribution"></td>
      <td><input value="${v.chauffeur||""}" data-key="${id}" data-field="chauffeur"></td>
      <td><input value="${v.soigneur||""}" data-key="${id}" data-field="soigneur"></td>
      <td><input value="${v.h3||""}" data-key="${id}" data-field="h3"></td>
      <td>
        <select data-key="${id}" data-field="statut">
          <option ${v.statut==="Disponible"?"selected":""}>Disponible</option>
          <option ${v.statut==="Sorti"?"selected":""}>Sorti</option>
          <option ${v.statut==="R√©serve"?"selected":""}>R√©serve</option>
          <option ${v.statut==="Indisponible"?"selected":""}>Indisponible</option>
        </select>
      </td>
      <td><input value="${v.commentaire||""}" data-key="${id}" data-field="commentaire"></td>
    `;
    tbody.appendChild(tr);

    if(v.statut==="Disponible")      dispo++;
    else if(v.statut==="Sorti")      sorti++;
    else if(v.statut==="R√©serve")    res++;
    else if(v.statut==="Indisponible") indispo++;
  });

  nbDispo.textContent    = "Disponibles : "    + dispo;
  nbSortis.textContent   = "Sortis : "         + sorti;
  nbRes.textContent      = "R√©serve : "        + res;
  nbIndispo.textContent  = "Indisponibles : "  + indispo;
});

// quand on modifie une cellule du tableau v√©hicules -> on met √† jour firebase
document.addEventListener("change", e => {
  if(e.target && e.target.dataset && e.target.dataset.key){
    const vehId  = e.target.dataset.key;
    const field  = e.target.dataset.field;
    const value  = e.target.value;
    refVeh.child(vehId).update({ [field]: value });
  }
});
</script>

</body>
</html>
