<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dispatch – Tableau de garde</title>
<style>
body {
  margin: 0;
  font-family: "Segoe UI", Inter, sans-serif;
  background: #0a0f16;
  color: #f1f5fa;
}
header {
  background: #111b2b;
  padding: 10px 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 2px solid #1f2c3e;
}
header h1 {
  font-size: 22px;
  color: #cfe1ff;
  margin: 0;
}
header button {
  background: #2d63e2;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 6px;
  cursor: pointer;
}
header button:hover {
  background: #3a7bff;
}
main {
  padding: 12px;
}
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  background: #121b2a;
  border-radius: 8px;
  overflow: hidden;
}
th, td {
  padding: 8px;
  border-bottom: 1px solid #1f2c3e;
  text-align: center;
}
th {
  background: #1a2436;
  color: #9bb5d3;
}
td input, td select {
  background: #1a2335;
  border: 1px solid #2a3853;
  color: #f1f5fa;
  border-radius: 5px;
  padding: 4px 6px;
  width: 100%;
  box-sizing: border-box;
}
td input:focus, td select:focus {
  outline: 2px solid #3a8bf2;
}
textarea {
  width: 100%;
  height: 60px;
  border-radius: 6px;
  border: 1px solid #2a3853;
  background: #1a2335;
  color: #f1f5fa;
  resize: vertical;
  padding: 6px;
}
.role-box {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  background: #121b2a;
  padding: 10px;
  border-radius: 8px;
}
.role-box label {
  display: flex;
  flex-direction: column;
  font-size: 14px;
  color: #9bb5d3;
  width: 180px;
}
.role-box input {
  margin-top: 3px;
  background: #1a2335;
  border: 1px solid #2a3853;
  color: #f1f5fa;
  border-radius: 5px;
  padding: 4px 6px;
}
section.notes {
  margin-top: 16px;
}
h2 {
  color: #cfe1ff;
  font-size: 18px;
  margin-bottom: 6px;
}
footer {
  text-align: center;
  color: #9bb5d3;
  font-size: 13px;
  margin: 8px 0;
}
</style>
</head>
<body>

<header>
  <h1>Tableau de garde – Dispatch</h1>
  <div>
    <button id="paramBtn">Paramétrages</button>
  </div>
</header>

<main>
  <section class="roles">
    <h2>Rôles de commandement</h2>
    <div class="role-box" id="roleBox"></div>
  </section>

  <section class="vehicules">
    <h2>Véhicules</h2>
    <table>
      <thead>
        <tr>
          <th>Véhicule</th>
          <th>Attribution</th>
          <th>Chauffeur</th>
          <th>Soins</th>
          <th>3e Homme</th>
          <th>Kilométrage</th>
          <th>Statut</th>
          <th>Remarques</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <section class="notes">
    <h2>Matériel à récupérer</h2>
    <textarea id="materiel"></textarea>
    <h2>Informations et remarques</h2>
    <textarea id="infos"></textarea>
  </section>
</main>

<footer>
  &copy; Centrale – Système Dispatch ACSRS
</footer>

<script src="store-bridge.js"></script>
<script>
if (typeof readKey !== "function") alert("store-bridge.js introuvable");

const STORAGE_KEY = "dispatch_parc_vehicules";
let data = {};
let isEditing = false;
let typingTimer = null;

// ordre d’affichage
const ORDER = ["LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8","TMS","PREV","OFF"];
const rankMap = Object.fromEntries(ORDER.map((k,i)=>[k, i]));
function attribRank(str){
  const key = (str||"").toUpperCase();
  return key in rankMap ? rankMap[key] : 999;
}
function sortVehsForDispatch(vehs){
  return (vehs||[]).slice().sort((a,b)=>{
    const da = data[a.id] || {};
    const db = data[b.id] || {};
    const aKey = (da.attribution || a.attrib || "").toUpperCase();
    const bKey = (db.attribution || b.attrib || "").toUpperCase();
    const ra = attribRank(aKey), rb = attribRank(bKey);
    if (ra !== rb) return ra - rb;
    return (a.id||"").localeCompare(b.id||"");
  });
}

// liste des attributions disponibles
const ATTRIBS = ["","LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8","TMS","PREV","OFF"];

const roleLabels = {
  officier_semaine:"Officier de semaine",
  officier_garde:"Officier de garde",
  responsable_operations:"Resp. opérations",
  chef_groupe:"Chef de groupe",
  chef_poste:"Chef de poste",
  centraliste_1:"1er centraliste",
  centraliste_2:"2e centraliste"
};

// Chargement principal
async function load(){
  data = await readKey(STORAGE_KEY) || {};
  renderRoles();
  renderTable();
  renderNotes();
}

// Sauvegarde globale
async function save(){
  await saveKey(STORAGE_KEY, data);
}

// Rôles
function renderRoles(){
  const box = document.getElementById("roleBox");
  const roles = data._roles || {};
  box.innerHTML = Object.entries(roleLabels).map(([k,label])=>{
    const val = roles[k] || "";
    return `<label>${label}<input data-role="${k}" value="${val}" /></label>`;
  }).join("");

  box.querySelectorAll("input[data-role]").forEach(inp=>{
    inp.oninput = async ()=>{
      const k = inp.dataset.role;
      if(!data._roles) data._roles = {};
      data._roles[k] = inp.value;
      await save();
    };
  });
}

// Tableau véhicules
function renderTable(){
  const tb = document.querySelector("tbody");
  tb.innerHTML = "";
  const vehsSorted = sortVehsForDispatch(data._settings?.vehs || []);
  vehsSorted.forEach(v=>{
    const d = data[v.id] || {};
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td><b>${d.name||v.id}</b><br><span class="mut">${d.plaque||""}</span></td>
        <td>
          <select data-v="${v.id}" data-k="attribution">
            ${ATTRIBS.map(a=>`<option ${a===(d.attribution||"")?"selected":""}>${a}</option>`).join("")}
          </select>
        </td>
        <td><input data-v="${v.id}" data-k="XO" value="${d.XO||""}" placeholder="Chauffeur"></td>
        <td><input data-v="${v.id}" data-k="S" value="${d.S||""}" placeholder="Soins"></td>
        <td><input data-v="${v.id}" data-k="PS" value="${d.PS||""}" placeholder="3e homme"></td>
        <td><input data-v="${v.id}" data-k="km" value="${d.km||""}" inputmode="numeric" placeholder="Km"></td>
        <td>
          <select data-v="${v.id}" data-k="statut">
            ${["Disponible","Sorti","Réserve","Indisponible"].map(s=>`<option ${s===(d.statut||"")?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td><input data-v="${v.id}" data-k="commentaire" value="${d.commentaire||""}" placeholder="Remarque"></td>
      </tr>
    `);
  });

  document.querySelectorAll("input[data-v],select[data-v]").forEach(el=>{
    el.oninput = async ()=>{
      isEditing = true;
      clearTimeout(typingTimer);
      const id = el.dataset.v, k = el.dataset.k;
      if(k==="km") el.value = el.value.replace(/[^\d]/g,"");
      if(!data[id]) data[id] = {};
      data[id][k] = el.value;
      await save();
      typingTimer = setTimeout(()=>isEditing=false,1200);
    };
  });
}

// Notes
function renderNotes(){
  document.getElementById("materiel").value = data._notes?.materiel || "";
  document.getElementById("infos").value = data._notes?.infos || "";

  document.getElementById("materiel").oninput = async e=>{
    if(!data._notes) data._notes = {};
    data._notes.materiel = e.target.value;
    await save();
  };
  document.getElementById("infos").oninput = async e=>{
    if(!data._notes) data._notes = {};
    data._notes.infos = e.target.value;
    await save();
  };
}

// Redirection vers paramétrages
document.getElementById("paramBtn").onclick = ()=>{
  window.open("parametres.html", "_blank");
};

// Actualisation périodique
async function loop(){
  if(isEditing) return;
  await load();
}
setInterval(loop,5000);
load();
</script>
</body>
</html>
