<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dispatch ‚Äì Tableau de garde</title>

<style>
:root {
  --bg:#071022;--panel:#0f1724;--line:#213243;
  --txt:#eef3fb;--mut:#9fb3d0;--accent:#2f7bf6;--ok:#2e7d32;
}
body {
  background:var(--bg);
  color:var(--txt);
  font-family:"Segoe UI",Arial,sans-serif;
  margin:0;
  padding:0;
}
h1 {
  text-align:center;
  margin:20px 0;
  font-size:24px;
  font-weight:600;
  color:#cfe1ff;
}
section {
  background:var(--panel);
  border:1px solid var(--line);
  border-radius:12px;
  padding:12px;
  margin:12px auto;
  width:90%;
  max-width:1200px;
}
section h2 {
  margin:0 0 10px;
  font-size:18px;
  color:#cfe1ff;
  font-weight:600;
}
label {
  color:var(--mut);
  font-size:13px;
  font-weight:500;
}
input,textarea,select {
  background:#081427;
  color:#fff;
  border:1px solid var(--line);
  border-radius:8px;
  padding:6px 8px;
  margin-bottom:8px;
  width:100%;
  font-size:14px;
  box-sizing:border-box;
}
textarea {resize:none;}
table {
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
  font-size:14px;
  color:#fff;
}
th,td {
  border:1px solid var(--line);
  padding:8px;
  text-align:center;
  vertical-align:top;
}
th {
  background:#13233b;
  font-weight:600;
  font-size:13px;
  color:#dbe7ff;
  letter-spacing:.03em;
}
.statusBox {
  display:flex;
  flex-wrap:wrap;
  justify-content:space-evenly;
  gap:8px;
  margin-top:14px;
}
.statusBox div {
  flex:1;
  min-width:150px;
  text-align:center;
  padding:8px;
  border-radius:8px;
  background:#102030;
  border:1px solid #1f2c3e;
  font-size:14px;
  color:#fff;
}
@media(max-width:700px){
  section {width:94%}
  table {font-size:12px}
  th,td {padding:6px}
}
</style>
</head>

<body>
<h1>Tableau de garde</h1>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<!-- üîí S√©curit√© minimale : v√©rifie le token -->
<script>
(function ensureAuth(){
  const token = localStorage.getItem("dispatch_idToken");
  if(!token){
    location.href = "index.html";
    return;
  }
})();
</script>

<!-- R√¥les de commandement -->
<section id="commandement">
  <h2>Postes de commandement</h2>
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px;">
    <div><label>Officier de semaine</label><input id="off_sem" /></div>
    <div><label>Officier de garde</label><input id="off_gar" /></div>
    <div><label>Chef de groupe</label><input id="chef_grp" /></div>
    <div><label>Chef de poste</label><input id="chef_poste" /></div>
    <div><label>Responsable des op√©rations</label><input id="resp_op" /></div>
    <div><label>1er centraliste</label><input id="cent1" /></div>
    <div><label>2e centraliste</label><input id="cent2" /></div>
  </div>
</section>

<!-- Notes -->
<section id="notes">
  <h2>Notes globales</h2>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
    <div>
      <label>üß∞ Mat√©riel √† r√©cup√©rer</label>
      <textarea id="mat_recup" rows="4" placeholder="Ex: Oxyg√®ne, attelles..."></textarea>
    </div>
    <div>
      <label>‚ÑπÔ∏è Informations & remarques</label>
      <textarea id="infos" rows="4" placeholder="Ex: Route barr√©e, travaux..."></textarea>
    </div>
  </div>
</section>

<!-- V√©hicules -->
<section id="vehicules">
  <h2>V√©hicules</h2>
  <p style="color:#9fb3d0;font-size:13px;margin-top:0;margin-bottom:8px;">
    Les v√©hicules (nom, attribution, plaque) se g√®rent dans Param√©trages.
  </p>

  <table id="tableVeh">
    <thead>
      <tr>
        <th>V√©hicule</th>
        <th>Attribution</th>
        <th>Chauffeur</th>
        <th>Soins</th>
        <th>3·µâ Homme</th>
        <th>Statut</th>
        <th>Commentaire</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="statusBox">
    <div id="nbDispo">Disponibles : 0</div>
    <div id="nbSortis">Sortis : 0</div>
    <div id="nbRes">R√©serve : 0</div>
    <div id="nbIndispo">Indisponibles : 0</div>
  </div>
</section>

<script>
// ===========================
// 1. CONFIG FIREBASE
// ===========================
const firebaseConfig = {
  apiKey: "AIzaSyCP6ZClAectP8OPneAeOYGYdRYO0CvnbnQ",
  authDomain: "racs-dispatch.firebaseapp.com",
  databaseURL: "https://racs-dispatch-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "racs-dispatch",
  storageBucket: "racs-dispatch.firebasestorage.app",
  messagingSenderId: "589135271261",
  appId: "1:589135271261:web:d080a5da49a061929b84b4"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ===========================
// 2. R√©f√©rences dans la base
// ===========================
const refCmd   = db.ref("dispatch_commandement");
const refNotes = db.ref("dispatch_notes");
const refVeh   = db.ref("dispatch_parc_vehicules");

// ===========================
// 3. Charger les donn√©es
// ===========================
refCmd.on("value", snap=>{
  const v = snap.val() || {};
  off_sem.value     = v.off_sem     || "";
  off_gar.value     = v.off_gar     || "";
  chef_grp.value    = v.chef_grp    || "";
  chef_poste.value  = v.chef_poste  || "";
  resp_op.value     = v.resp_op     || "";
  cent1.value       = v.cent1       || "";
  cent2.value       = v.cent2       || "";
});

refNotes.on("value", snap=>{
  const v = snap.val() || {};
  mat_recup.value = v.mat_recup || "";
  infos.value     = v.infos     || "";
});

refVeh.on("value", snap=>{
  const tbody = document.querySelector("#tableVeh tbody");
  tbody.innerHTML = "";

  const all = snap.val() || {};
  let dispo=0, sorti=0, res=0, indispo=0;

  Object.entries(all).forEach(([vehId, info])=>{
    const d = info || {};
    if(d.statut === "Disponible")    dispo++;
    else if(d.statut === "Sorti")    sorti++;
    else if(d.statut === "R√©serve")  res++;
    else                              indispo++;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${vehId}${d.plaque ? `<br><span style="color:#9fb3d0;font-size:12px">${d.plaque}</span>` : ""}</td>
      <td><input value="${d.attribution||""}" data-key="${vehId}" data-field="attribution" /></td>
      <td><input value="${d.chauffeur||""}" data-key="${vehId}" data-field="chauffeur" /></td>
      <td><input value="${d.soigneur||""}" data-key="${vehId}" data-field="soigneur" /></td>
      <td><input value="${d.h3||""}" data-key="${vehId}" data-field="h3" /></td>
      <td>
        <select data-key="${vehId}" data-field="statut">
          <option ${d.statut==="Disponible"?"selected":""}>Disponible</option>
          <option ${d.statut==="Sorti"?"selected":""}>Sorti</option>
          <option ${d.statut==="R√©serve"?"selected":""}>R√©serve</option>
          <option ${d.statut==="Indisponible"?"selected":""}>Indisponible</option>
        </select>
      </td>
      <td><input value="${d.commentaire||""}" data-key="${vehId}" data-field="commentaire" /></td>
    `;
    tbody.appendChild(tr);
  });

  nbDispo.textContent    = "Disponibles : "    + dispo;
  nbSortis.textContent   = "Sortis : "         + sorti;
  nbRes.textContent      = "R√©serve : "        + res;
  nbIndispo.textContent  = "Indisponibles : "  + indispo;
});

// ===========================
// 4. Sauvegarde automatique
// ===========================
document.querySelectorAll("#commandement input").forEach(inp=>{
  inp.addEventListener("change", ()=>{
    refCmd.update({
      off_sem:     off_sem.value,
      off_gar:     off_gar.value,
      chef_grp:    chef_grp.value,
      chef_poste:  chef_poste.value,
      resp_op:     resp_op.value,
      cent1:       cent1.value,
      cent2:       cent2.value
    });
  });
});

document.querySelectorAll("#notes textarea").forEach(area=>{
  area.addEventListener("change", ()=>{
    refNotes.update({
      mat_recup: mat_recup.value,
      infos:     infos.value
    });
  });
});

document.addEventListener("change", e=>{
  if(!e.target.dataset || !e.target.dataset.key) return;
  const vehId = e.target.dataset.key;
  const field = e.target.dataset.field;
  const val   = e.target.value;
  refVeh.child(vehId).update({ [field]: val });
});
</script>

</body>
</html>
