<script>
// ====== CONFIG ======
const STORAGE_KEY = "dispatch_parc_vehicules";
const ATTRIBS = ["","LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8","Prev","LOG","TMS","OFF"];

let data = {};
let isEditing = false;
let typingTimer = null;

// ====== UTILS ======
const $ = (id)=>document.getElementById(id);
function ensure(){
  if(!data || typeof data!=='object') data = {};
  if(!data._settings) data._settings = { vehs: [] };
  if(!data._roles) data._roles = {
    officier_semaine:"", officier_garde:"",
    responsable_operations:"", chef_groupe:"",
    chef_poste:"", centraliste_1:"", centraliste_2:""
  };
  if(!data._notes) data._notes = { materiel:"", infos:"" };
  (data._settings.vehs||[]).forEach(v=>{
    if(!data[v.id]) data[v.id] = {
      XO:"", S:"", PS:"", km:"", statut:"Disponible", commentaire:"",
      attribution: v.attrib||"", plaque: v.plaque||"", name: v.name||v.id
    };
  });
}

function toast(msg){
  console.log("[DISPATCH]", msg);
}

// ====== RENDU ======
function renderAll(){ renderRoles(); renderNotes(); renderTable(); renderStats(); }

function renderRoles(){
  document.querySelectorAll('[data-role]').forEach(inp=>{
    const k=inp.dataset.role;
    inp.value = data._roles[k] || "";
    inp.oninput = async e=>{
      isEditing = true;
      clearTimeout(typingTimer);
      data._roles[k] = e.target.value;
      await save();
      typingTimer = setTimeout(()=>isEditing=false, 1200);
    };
  });
}

function renderNotes(){
  const nm = $('note_materiel'), ni = $('note_infos');
  if (!nm || !ni) return;
  nm.value = data._notes.materiel || "";
  ni.value = data._notes.infos    || "";
  nm.oninput = async e=>{ isEditing=true; clearTimeout(typingTimer); data._notes.materiel=e.target.value; await save(); typingTimer=setTimeout(()=>isEditing=false,1200); };
  ni.oninput = async e=>{ isEditing=true; clearTimeout(typingTimer); data._notes.infos   =e.target.value; await save(); typingTimer=setTimeout(()=>isEditing=false,1200); };
}

function renderTable(){
  const tb = $('tbody'); if(!tb){ console.warn("tbody introuvable"); return; }
  tb.innerHTML="";
  (data._settings.vehs||[]).forEach(v=>{
    const d = data[v.id] || {};
    tb.insertAdjacentHTML('beforeend', `
      <tr>
        <td><b>${d.name||v.id}</b><br><span class="mut">${d.plaque||""}</span></td>
        <td>
          <select data-v="${v.id}" data-k="attribution">
            ${ATTRIBS.map(a=>`<option ${a===(d.attribution||"")?"selected":""}>${a}</option>`).join("")}
          </select>
        </td>
        <td><input data-v="${v.id}" data-k="XO" value="${d.XO||""}" placeholder="Chauffeur"></td>
        <td><input data-v="${v.id}" data-k="S" value="${d.S||""}" placeholder="Soins"></td>
        <td><input data-v="${v.id}" data-k="PS" value="${d.PS||""}" placeholder="3e"></td>
        <td><input data-v="${v.id}" data-k="km" value="${d.km||""}" inputmode="numeric" placeholder="Km"></td>
        <td>
          <select data-v="${v.id}" data-k="statut">
            ${["Disponible","Sorti","R√©serve","Indisponible"].map(s=>`<option ${s===(d.statut||"")?"selected":""}>${s}</option>`).join("")}
          </select>
        </td>
        <td><input data-v="${v.id}" data-k="commentaire" value="${d.commentaire||""}" placeholder="Remarque"></td>
      </tr>
    `);
  });

  document.querySelectorAll('input[data-v],select[data-v]').forEach(el=>{
    el.oninput = async ()=>{
      isEditing = true; clearTimeout(typingTimer);
      const id = el.dataset.v, k = el.dataset.k;
      if(k==="km") el.value = el.value.replace(/[^\d]/g,'');
      if(!data[id]) data[id] = {};
      data[id][k] = el.value;
      await save(); renderStats();
      typingTimer = setTimeout(()=>isEditing=false, 1200);
    };
  });
}

function renderStats(){
  const cd=$('cDispo'), cs=$('cSorti'), cr=$('cReserve'), ci=$('cIndispo');
  const list=(data._settings.vehs||[]).map(v=>data[v.id] || {});
  if(cd) cd.textContent = list.filter(x=>x.statut==="Disponible").length;
  if(cs) cs.textContent = list.filter(x=>x.statut==="Sorti").length;
  if(cr) cr.textContent = list.filter(x=>x.statut==="R√©serve").length;
  if(ci) ci.textContent = list.filter(x=>x.statut==="Indisponible").length;
}

// ====== PERSISTANCE via store-bridge ======
if (typeof readKey !== 'function' || typeof saveKey !== 'function') {
  alert("store-bridge.js introuvable : impossible de lire/√©crire Firebase.");
}

async function save(){ await saveKey(STORAGE_KEY, data); }

// ====== LECTURE multi-sch√©mas ======
// Sch√©ma A (UNIFI√â) attendu : { _settings:{vehs:[...]}, _roles:{...}, _notes:{...}, <vehId>:{...} }
async function loadUnified(){
  const obj = await readKey(STORAGE_KEY) || {};
  // minimal pour le consid√©rer ‚Äúvalide‚Äù : pr√©sence de _settings.vehs (m√™me vide)
  if (obj && typeof obj==='object' && obj._settings && Array.isArray(obj._settings.vehs)) {
    return obj;
  }
  return null;
}

// Sch√©ma B (LEGACY) : tout est √©clat√© dans 3 cl√©s distinctes
//  - dispatch_commandement
//  - dispatch_notes
//  - dispatch_parc_vehicules (plateau des v√©hicules √† plat)
async function loadLegacy(){
  try{
    const legacyVeh   = await readKey("dispatch_parc_vehicules") || {};
    const legacyRoles = await readKey("dispatch_commandement") || {};
    const legacyNotes = await readKey("dispatch_notes") || {};
    // Si legacyVeh ressemble √† un objet avec des propri√©t√©s de v√©hicules (et PAS _settings)
    const keys = Object.keys(legacyVeh||{});
    const maybeVehs = keys.filter(k=>typeof (legacyVeh[k])==='object' && !k.startsWith('_'));
    if (maybeVehs.length===0) return null;

    // Construire data unifi√©e
    const vehsArr = maybeVehs.map(id=>{
      const d = legacyVeh[id] || {};
      return { id, name: d.name || id, attrib: d.attribution || "", plaque: d.plaque || "" };
    });

    const unified = {
      _settings: { vehs: vehsArr },
      _roles: {
        officier_semaine: legacyRoles.off_sem || "",
        officier_garde: legacyRoles.off_gar || "",
        responsable_operations: legacyRoles.resp_op || "",
        chef_groupe: legacyRoles.chef_grp || "",
        chef_poste: legacyRoles.chef_poste || "",
        centraliste_1: legacyRoles.cent1 || "",
        centraliste_2: legacyRoles.cent2 || ""
      },
      _notes: {
        materiel: legacyNotes.mat_recup || "",
        infos: legacyNotes.infos || ""
      }
    };

    // Injecter le d√©tail par v√©hicule
    maybeVehs.forEach(id=>{
      const d = legacyVeh[id] || {};
      unified[id] = {
        XO: d.chauffeur || "", S: d.soigneur || "", PS: d.h3 || "",
        km: d.km || "", statut: d.statut || "Disponible", commentaire: d.commentaire || "",
        attribution: d.attribution || "", plaque: d.plaque || "", name: d.name || id
      };
    });

    return unified;
  }catch(e){
    console.warn("loadLegacy error", e);
    return null;
  }
}

// ====== DEBUG WIDGET ======
(function debugWidget(){
  const btn = document.createElement('button');
  btn.textContent = "üîé Debug";
  btn.style.position='fixed'; btn.style.right='10px'; btn.style.bottom='70px';
  btn.style.zIndex='9999'; btn.style.background='#444'; btn.style.border='1px solid #777';
  btn.style.borderRadius='8px'; btn.style.padding='8px 10px'; btn.style.cursor='pointer';
  btn.onclick = async ()=>{
    try{
      const unified = await readKey(STORAGE_KEY);
      alert("Cl√© principale:\n" + JSON.stringify(unified, null, 2).slice(0, 5000));
    }catch(e){
      alert("Erreur lecture cl√© principale: " + e.message);
    }
  };
  document.body.appendChild(btn);
})();

// ====== BOOT ======
async function boot(){
  try{
    // 1) Tente sch√©ma UNIFI√â
    let got = await loadUnified();
    // 2) Sinon, tente sch√©ma LEGACY (et si trouv√©, on l‚Äô√©crit au bon format)
    if(!got){
      toast("Sch√©ma unifi√© vide -> tentative legacy");
      const legacy = await loadLegacy();
      if(legacy){
        toast("Legacy d√©tect√© -> migration en m√©moire (sans √©craser), affichage‚Ä¶");
        got = legacy;
        // On n‚Äô√©crase pas automatiquement la base, on affiche seulement.
        // Si tu veux ‚Äúupgrader‚Äù ta base au sch√©ma unifi√©, d√©commente la ligne ci-dessous:
        // await saveKey(STORAGE_KEY, got);
      }
    }
    // 3) Si toujours rien, on affiche un message
    if(!got){
      toast("Aucune donn√©e trouv√©e. V√©rifie l‚ÄôURL Firebase dans store-bridge.js et la cl√© utilis√©e par parametres.html");
      data = { _settings:{vehs:[]}, _roles:{}, _notes:{} };
    }else{
      data = got;
    }

    ensure(); renderAll();

    // Polling sans √©jecter l‚Äô√©dition
    setInterval(async ()=>{
      if(isEditing) return;
      const fresh = await readKey(STORAGE_KEY) || {};
      // Si sch√©ma inexistant mais legacy pr√©sent, recharge legacy comme fallback
      if(!fresh || !fresh._settings){
        const legacy = await loadLegacy();
        if(legacy) {
          data = legacy; ensure(); renderAll();
          return;
        }
      }
      if (JSON.stringify(fresh)!==JSON.stringify(data)){
        data = fresh; ensure(); renderAll();
      }
    }, 5000);

  }catch(e){
    console.error("BOOT ERROR", e);
    alert("Erreur de chargement. V√©rifie la console (F12) et l‚ÄôURL Firebase dans store-bridge.js.");
  }
}

boot();
</script>
