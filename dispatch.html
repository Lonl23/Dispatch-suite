<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Dispatch ‚Äì Tableau de garde</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="styles.css">
</head>
<body>
<!-- Garde d'acc√®s (login + mode) -->
<script src="auth-guard.js"></script>
<!-- Pont Apps Script -->
<script src="store-bridge.js"></script>

<div class="wrap" style="align-items:stretch;justify-content:flex-start;padding:16px;min-height:auto">
  <div style="width:100%;max-width:1400px;margin:0 auto">
    <div class="tv-header" style="position:sticky;top:0;z-index:5">
      <h1>Tableau de garde</h1>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn ghost" onclick="window.open('missions.html','_blank')">üìù Missions</button>
        <button class="btn ghost" onclick="window.open('tv-grid.html','_blank')">üì∫ TV V√©hicules</button>
        <button class="btn ghost" onclick="window.open('tv-missions.html','_blank')">üé• TV Missions</button>
        <button id="wakeBtn" class="btn ghost">üîÜ Anti-veille</button>
        <button class="btn" onclick="openSettings()">‚öôÔ∏è Param√©trages</button>
      </div>
    </div>

    <!-- Postes de commandement -->
    <div class="card" style="max-width:none;margin-top:16px">
      <h2>Postes de commandement</h2>
      <div class="grid3">
        <div><label>Officier de semaine</label><input data-rolekey="officier_semaine" type="text"></div>
        <div><label>Officier de garde</label><input data-rolekey="officier_garde" type="text"></div>
        <div><label>Responsable des op√©rations</label><input data-rolekey="responsable_operations" type="text"></div>
        <div><label>Chef de groupe</label><input data-rolekey="chef_groupe" type="text"></div>
        <div><label>Chef de poste</label><input data-rolekey="chef_poste" type="text"></div>
        <div><label>1er centraliste</label><input data-rolekey="centraliste_1" type="text"></div>
        <div><label>2e centraliste</label><input data-rolekey="centraliste_2" type="text"></div>
      </div>
    </div>

    <!-- Notes -->
    <div class="card" style="max-width:none;margin-top:16px">
      <h2>Notes globales</h2>
      <div class="grid2">
        <div>
          <label>Mat√©riel √† r√©cup√©rer</label>
          <textarea id="note_materiel" rows="5" placeholder="Ex: Oxym√®tre, attelles..."></textarea>
        </div>
        <div>
          <label>Informations & remarques</label>
          <textarea id="note_infos" rows="5" placeholder="Ex: Route barr√©e rue X, travaux..."></textarea>
        </div>
      </div>
      <p class="muted">Ces notes apparaissent dans la banni√®re TV (OUT / Mat√©riel / Infos).</p>
    </div>

    <!-- Statistiques -->
    <div class="card" style="max-width:none;margin-top:16px">
      <div class="grid4" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
        <div class="center"><div class="status dispo" style="display:block">Disponibles</div><h2 id="cDispo" style="margin:8px 0 0">0</h2></div>
        <div class="center"><div class="status sorti" style="display:block">Sortis</div><h2 id="cSorti" style="margin:8px 0 0">0</h2></div>
        <div class="center"><div class="status reserve" style="display:block">R√©serve</div><h2 id="cReserve" style="margin:8px 0 0">0</h2></div>
        <div class="center"><div class="status indispo" style="display:block">Indisponibles</div><h2 id="cIndispo" style="margin:8px 0 0">0</h2></div>
      </div>
    </div>

    <!-- Tableau -->
    <div class="card" style="max-width:none;margin-top:16px">
      <h2>V√©hicules</h2>
      <p class="muted">Ajoute des v√©hicules via <b>‚öôÔ∏è Param√©trages</b>. Attribution & Plaque se modifient uniquement dans Param√©trages.</p>
      <div style="overflow:auto">
        <table id="vehTable">
          <thead>
            <tr>
              <th>V√©hicule</th>
              <th>Chauffeur</th>
              <th>Soins</th>
              <th>3·µâ Homme</th>
              <th>Attribution</th>
              <th>Plaque</th>
              <th style="display:none">Km</th>
              <th style="display:none">Heure sortie</th>
              <th>Statut</th>
              <th>Commentaire</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- OUT -->
    <div class="card" style="max-width:none;margin-top:16px">
      <h2>V√©hicules OUT</h2>
      <div id="outList" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    </div>
  </div>
</div>

<!-- MODALE Param√©trages -->
<div id="modalSettings" class="modal hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:9999">
  <div class="card" style="max-width:900px;width:90%;max-height:90vh;overflow:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
      <h2 style="margin:0">Param√©trages</h2>
      <button class="btn ghost" onclick="closeSettings()">‚úñ</button>
    </div>
    <div class="sep"></div>

    <h3 style="margin-top:0">Ajouter un v√©hicule</h3>
    <div class="grid3">
      <div><label>Identifiant (ex. AS 55)</label><input id="nv_id" placeholder="AS 55"></div>
      <div><label>Nom affich√©</label><input id="nv_name" placeholder="Ambulance 55"></div>
      <div><label>Plaque</label><input id="nv_plate" placeholder="1-ABC-123"></div>
      <div>
        <label>Attribution</label>
        <select id="nv_attr">
          <option value=""></option>
          <option>LH1</option><option>LH2</option><option>LH3</option><option>LH4</option>
          <option>LH5</option><option>LH6</option><option>LH7</option><option>LH8</option>
          <option>Prev</option><option>LOG</option>
        </select>
      </div>
      <div style="align-self:end"><button class="btn" onclick="addVehicle()">‚ûï Ajouter</button></div>
    </div>

    <div class="sep"></div>
    <h3>V√©hicules configur√©s</h3>
    <div id="cfgGrid" class="grid3"></div>
    <div class="center" style="margin-top:10px">
      <button class="btn" onclick="saveSettings()">üíæ Enregistrer</button>
    </div>
  </div>
</div>

<!-- MODALE R√©-attribution LH -->
<div id="modalReassign" class="modal hidden" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:10000">
  <div class="card" style="max-width:600px;width:90%">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">R√©-attribuer <span id="rea_attrib">LH?</span></h2>
      <button class="btn ghost" onclick="cancelReassign()">‚úñ</button>
    </div>
    <p>Le v√©hicule <b id="rea_fromVeh">‚Äî</b> passe <b>Indisponible</b> avec l‚Äôattribution <b id="rea_attrib2">LH?</b>. Choisis un repreneur.</p>
    <input id="rea_search" placeholder="Rechercher un v√©hicule..." oninput="renderReassignCandidates()">
    <div id="rea_list" style="margin-top:8px;border:1px solid var(--line);border-radius:10px;max-height:50vh;overflow:auto"></div>
    <div class="center" style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn ghost" onclick="liberateOnly()">Lib√©rer sans r√©-attribuer</button>
      <button class="btn" onclick="confirmReassign()">Confirmer</button>
    </div>
  </div>
</div>

<script>
/* ========= Constantes ========= */
const STORAGE_KEY = "dispatch_parc_vehicules";
const SETTINGS_PWD = "Password01";
const LH_SET = new Set(["LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8"]);

let data = {}; // { _settings:{vehs:[{id,name,plaque,attrib}]}, "<vehId>":{ XO,S,PS,attribution,plaque,km,heure_sortie,statut,commentaire,name } }
let _rea = { fromVeh:null, attrib:"", selected:null, candidates:[] };

/* ========= Utils ========= */
const $ = (id)=>document.getElementById(id);
function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]);}

/* ========= Ensure ========= */
function ensure(){
  if(!data || typeof data!=='object') data = {};
  if(!data._settings) data._settings = { vehs: [] };       // <-- AUCUN pr√©-enregistrement
  if(!data._roles) data._roles = {};
  if(!data._notes) data._notes = { materiel:"", infos:"" };
  // cr√©e les fiches manquantes
  (data._settings.vehs||[]).forEach(v=>{
    if(!data[v.id]) data[v.id] = {
      XO:"", S:"", PS:"", attribution:(v.attrib||""), plaque:(v.plaque||""),
      km:"", heure_sortie:"", statut:"Disponible", commentaire:"", name:(v.name||v.id)
    };
  });
}

/* ========= Render ========= */
function renderAll(){ renderRoles(); renderNotes(); renderTable(); renderStats(); renderOut(); buildSettingsGrid(); }

function renderRoles(){
  document.querySelectorAll('[data-rolekey]').forEach(inp=>{
    const k=inp.dataset.rolekey;
    inp.value = data._roles[k] || "";
    inp.oninput = async e => { data._roles[k]=e.target.value; await save(); };
  });
}

function renderNotes(){
  $('note_materiel').value = data._notes.materiel || "";
  $('note_infos').value    = data._notes.infos || "";
  $('note_materiel').oninput = async e => { data._notes.materiel=e.target.value; await save(); };
  $('note_infos').oninput    = async e => { data._notes.infos=e.target.value; await save(); };
}

function renderTable(){
  const tb = $('tbody'); tb.innerHTML = "";
  (data._settings.vehs||[]).forEach(v=>{
    const d = data[v.id];
    tb.insertAdjacentHTML("beforeend", `
      <tr>
        <td><b>${esc(d.name||v.id)}</b></td>
        <td><input data-v="${esc(v.id)}" data-k="XO" value="${esc(d.XO||"")}"></td>
        <td><input data-v="${esc(v.id)}" data-k="S" value="${esc(d.S||"")}"></td>
        <td><input data-v="${esc(v.id)}" data-k="PS" value="${esc(d.PS||"")}"></td>
        <td class="muted">${esc(d.attribution||"‚Äî")}</td>
        <td class="muted">${esc(d.plaque||"‚Äî")}</td>
        <td style="display:none"><input data-v="${esc(v.id)}" data-k="km" value="${esc(d.km||"")}"></td>
        <td style="display:none"><input data-v="${esc(v.id)}" data-k="heure_sortie" value="${esc(d.heure_sortie||"")}"></td>
        <td>
          <select data-v="${esc(v.id)}" data-k="statut">
            <option ${d.statut==="Disponible"?"selected":""}>Disponible</option>
            <option ${d.statut==="Sorti"?"selected":""}>Sorti</option>
            <option ${d.statut==="R√©serve"?"selected":""}>R√©serve</option>
            <option ${d.statut==="Indisponible"?"selected":""}>Indisponible</option>
          </select>
        </td>
        <td><input data-v="${esc(v.id)}" data-k="commentaire" value="${esc(d.commentaire||"")}"></td>
      </tr>
    `);
  });

  document.querySelectorAll('input[data-v], select[data-v]').forEach(el=>{
    el.oninput = async (e)=>{
      const vid = el.dataset.v, key = el.dataset.k;
      const oldStat = data[vid]?.statut;
      data[vid][key] = el.value;
      await save(); renderStats(); renderOut();

      // Si passage √† Indisponible avec LH => modale r√©attribution
      if(key==="statut" && el.value==="Indisponible" && oldStat!=="Indisponible"){
        const attrib = (data[vid]?.attribution||"").toUpperCase();
        if(LH_SET.has(attrib)) openReassignModal(vid, attrib);
      }
    };
  });
}

function renderStats(){
  const list = (data._settings.vehs||[]).map(v=>data[v.id]);
  $('cDispo').textContent   = list.filter(v=>v.statut==="Disponible").length;
  $('cSorti').textContent   = list.filter(v=>v.statut==="Sorti").length;
  $('cReserve').textContent = list.filter(v=>v.statut==="R√©serve").length;
  $('cIndispo').textContent = list.filter(v=>v.statut==="Indisponible").length;
}

function renderOut(){
  const box = $('outList'); box.innerHTML="";
  (data._settings.vehs||[]).forEach(v=>{
    const d=data[v.id];
    if(d.statut==="Indisponible"){
      const chip = document.createElement('div');
      chip.className = "tv-item";
      chip.innerHTML = `<strong>${esc(d.name||v.id)}</strong>
        <small>${d.attribution?`[${esc(d.attribution)}] `:""}${d.commentaire?esc(d.commentaire):""}</small>`;
      box.appendChild(chip);
    }
  });
}

/* ========= Param√©trages ========= */
function openSettings(){
  const pwd = prompt("Mot de passe Param√©trages :");
  if(pwd !== SETTINGS_PWD) return alert("Mot de passe incorrect.");
  $('modalSettings').classList.remove('hidden');
  buildSettingsGrid();
}
function closeSettings(){ $('modalSettings').classList.add('hidden'); }

function buildSettingsGrid(){
  const g = $('cfgGrid'); if(!g) return;
  g.innerHTML = "";
  (data._settings.vehs||[]).forEach(v=>{
    const d=data[v.id];
    const card = document.createElement('div');
    card.className = "card";
    card.style.padding = "12px";
    card.innerHTML = `
      <div class="muted" style="margin-bottom:6px"><b>${esc(v.id)}</b></div>
      <label>Nom affich√©</label><input data-id="${esc(v.id)}" data-f="name" value="${esc(d.name||v.id)}">
      <label>Plaque</label><input data-id="${esc(v.id)}" data-f="plaque" value="${esc(d.plaque||"")}">
      <label>Attribution</label>
      <select data-id="${esc(v.id)}" data-f="attribution">
        ${["","LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8","Prev","LOG"].map(a=>`<option ${a===(d.attribution||"")?"selected":""}>${a}</option>`).join("")}
      </select>
      <div class="sep"></div>
      <button class="btn danger" onclick="removeVehicle('${esc(v.id)}')">üóëÔ∏è Supprimer</button>
    `;
    g.appendChild(card);
  });
}

async function saveSettings(){
  // r√©cup√®re les inputs de la grille
  document.querySelectorAll('#cfgGrid [data-id]').forEach(inp=>{
    const id = inp.dataset.id;
    const f  = inp.dataset.f;
    const val = inp.value;
    if(!data[id]) data[id]={};
    data[id][f] = val;
    // miroir settings
    const sv = (data._settings.vehs||[]).find(v=>v.id===id);
    if(sv){
      if(f==="name") sv.name = val;
      if(f==="plaque") sv.plaque = val;
      if(f==="attribution") sv.attrib = val;
    }
  });

  enforceLHUnicity(); // garde LH uniques
  await save();
  renderAll();
  alert("Param√®tres enregistr√©s.");
}

async function addVehicle(){
  const id = $('nv_id').value.trim();
  const name = $('nv_name').value.trim() || id;
  const plate = $('nv_plate').value.trim();
  const attr = $('nv_attr').value;

  if(!id) return alert("Identifiant requis.");
  if((data._settings.vehs||[]).find(v=>v.id===id)) return alert("Ce v√©hicule existe d√©j√†.");

  data._settings.vehs.push({ id, name, plaque:plate, attrib:attr });
  data[id] = {
    XO:"", S:"", PS:"", attribution:attr, plaque:plate,
    km:"", heure_sortie:"", statut:"Disponible", commentaire:"", name
  };
  enforceLHUnicity();
  await save();
  $('nv_id').value=''; $('nv_name').value=''; $('nv_plate').value=''; $('nv_attr').value='';
  buildSettingsGrid(); renderAll();
  alert("V√©hicule ajout√©.");
}

async function removeVehicle(id){
  if(!confirm(`Supprimer le v√©hicule ${id} ?`)) return;
  // retire des settings
  data._settings.vehs = (data._settings.vehs||[]).filter(v=>v.id!==id);
  // retire la fiche
  delete data[id];
  await save();
  buildSettingsGrid(); renderAll();
}

/* ========= LH unicit√© & r√©-attribution ========= */
function enforceLHUnicity(){
  const seen = {};
  (data._settings.vehs||[]).forEach(v=>{
    const a=(data[v.id]?.attribution||"").toUpperCase();
    if(LH_SET.has(a)){
      if(seen[a]) data[v.id].attribution=""; else seen[a]=v.id;
      // Miroir settings
      const sv = data._settings.vehs.find(x=>x.id===v.id);
      if(sv) sv.attrib = data[v.id].attribution;
    }
  });
}

function openReassignModal(fromVeh, attrib){
  _rea = { fromVeh, attrib, selected:null, candidates: (data._settings.vehs||[]).map(v=>v.id).filter(id=>id!==fromVeh && (data[id]?.statut||"Disponible")!=="Indisponible") };
  $('rea_fromVeh').textContent = fromVeh;
  $('rea_attrib').textContent = attrib;
  $('rea_attrib2').textContent = attrib;
  $('rea_search').value = "";
  renderReassignCandidates();
  $('modalReassign').classList.remove('hidden');
}
function renderReassignCandidates(){
  const box = $('rea_list'); box.innerHTML = "";
  const q = ($('rea_search').value||"").toLowerCase();
  const items = _rea.candidates.map(id=>{
    const d=data[id]||{}; const hasOther = LH_SET.has((d.attribution||"").toUpperCase()) && (d.attribution||"").toUpperCase()!==_rea.attrib;
    return { id, name:d.name||id, stat:d.statut||"Disponible", attrib:d.attribution||"", disabled:hasOther };
  }).filter(x=> (x.id+" "+x.name+" "+x.stat+" "+x.attrib).toLowerCase().includes(q));

  if(!items.length){ box.innerHTML = `<div class="muted" style="padding:10px">Aucun candidat‚Ä¶</div>`; return; }

  items.forEach(x=>{
    const row = document.createElement('label');
    row.className = "tv-item";
    row.style.cursor = x.disabled ? 'not-allowed':'pointer';
    row.style.opacity = x.disabled ? .6 : 1;
    row.innerHTML = `
      <input type="radio" name="rea_choice" value="${esc(x.id)}" ${x.disabled?'disabled':''}
             onchange="_rea.selected=this.value" style="margin-right:8px">
      <div><strong>${esc(x.name)}</strong> <small>(${esc(x.id)}) ‚Äî Statut: ${esc(x.stat)} ‚Äî Attrib: ${esc(x.attrib||"‚Äî")}${x.disabled?` (porte d√©j√† ${esc(x.attrib)})`:''}</small></div>
    `;
    box.appendChild(row);
  });
}
function cancelReassign(){ $('modalReassign').classList.add('hidden'); _rea={fromVeh:null,attrib:"",selected:null,candidates:[]}; }
async function liberateOnly(){
  if(!_rea.fromVeh) return cancelReassign();
  data[_rea.fromVeh].attribution="";
  const sv = data._settings.vehs.find(v=>v.id===_rea.fromVeh); if(sv) sv.attrib="";
  await save(); renderAll(); cancelReassign();
  alert("Attribution lib√©r√©e.");
}
async function confirmReassign(){
  if(!_rea.selected) return alert("S√©lectionne un v√©hicule repreneur.");
  // supprime cette LH partout
  (data._settings.vehs||[]).forEach(v=>{
    if((data[v.id]?.attribution||"").toUpperCase()===_rea.attrib.toUpperCase()){
      data[v.id].attribution=""; const sv=data._settings.vehs.find(x=>x.id===v.id); if(sv) sv.attrib="";
    }
  });
  // lib√®re sur l'indispo
  if(data[_rea.fromVeh]){ data[_rea.fromVeh].attribution=""; const sv=data._settings.vehs.find(x=>x.id===_rea.fromVeh); if(sv) sv.attrib=""; }
  // assigne
  if(!data[_rea.selected]) data[_rea.selected]={};
  data[_rea.selected].attribution=_rea.attrib;
  const sv2=data._settings.vehs.find(x=>x.id===_rea.selected); if(sv2) sv2.attrib=_rea.attrib;

  await save(); renderAll(); cancelReassign();
  alert(`${_rea.attrib} est maintenant attribu√© √† ${_rea.selected}.`);
}

/* ========= Anti-veille ========= */
(()=>{
  let wakeLock=null, enabled=false; const btn=$('wakeBtn');
  function setBtn(on){ enabled=on; if(btn){ btn.textContent = on?"üîÜ Veille d√©sactiv√©e (cliquer pour stopper)":"üîÜ Anti-veille"; btn.classList.toggle('success',on);} }
  async function request(){
    if('wakeLock' in navigator && navigator.wakeLock?.request){
      try{ wakeLock = await navigator.wakeLock.request('screen'); setBtn(true); wakeLock.addEventListener('release',()=>{ if(enabled) onVisible(); }); return; }catch{}
    }
    alert("Si l'√©cran se met en veille, active le plein √©cran (F11) et v√©rifie les param√®tres d'alimentation.");
  }
  async function release(){ try{ await wakeLock?.release(); }catch{} wakeLock=null; setBtn(false); }
  async function toggle(){ if(enabled) await release(); else await request(); }
  async function onVisible(){ if(document.visibilityState==='visible' && enabled && 'wakeLock' in navigator) try{ await request(); }catch{} }
  btn?.addEventListener('click', toggle); document.addEventListener('visibilitychange', onVisible);
})();

/* ========= Persistance ========= */
async function save(){ await saveKey(STORAGE_KEY, data); }

/* ========= Boot ========= */
(async ()=>{
  data = await readKey(STORAGE_KEY);
  ensure(); renderAll();
})();
</script>
</body>
</html>
