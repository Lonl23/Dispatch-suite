<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Dispatch – Tableau de garde</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{--bg:#0b0f14;--panel:#121821;--line:#223044;--text:#e8eef5;--muted:#93a7bf;--accent:#3a8bf2;--danger:#e74c3c;--ok:#2e7d32}
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Arial,sans-serif}
  .header{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:#121821;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:5}
  .header h1{margin:0;font-size:22px;color:#cfe1ff}
  .btn{background:#3a8bf2;border:0;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700;text-decoration:none;display:inline-block}
  .container{max-width:1200px;margin:12px auto;padding:0 12px}
  .card{background:#121821;border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
  .muted{color:var(--muted);font-size:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
  input,select,textarea{width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid #2c3d52;background:#0f1520;color:#fff}
  textarea{min-height:96px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:6px 8px;text-align:left;vertical-align:top}
  th{background:#182030;font-size:12px;letter-spacing:.4px;position:sticky;top:0}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:#0f1520;border:1px solid #2c3d52;border-radius:999px;padding:6px 10px}
  .status{display:inline-block;padding:4px 8px;border-radius:8px;font-weight:700;font-size:12px}
  .s-dispo{background:#2e7d32}.s-sorti{background:#3a8bf2}.s-res{background:#f4b400;color:#000}.s-indispo{background:#e74c3c}

  /* Modale (ré-attribution) */
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:9000}
  .modal.show{display:flex}
  .modal .box{background:#121821;border:1px solid #223044;border-radius:12px;padding:14px;max-width:640px;width:95%;max-height:85vh;overflow:auto}
  body.modal-open{overflow:hidden}

  @media (max-width: 768px){
    .header h1{font-size:18px}
    h3{font-size:18px}
    .grid2,.grid3{grid-template-columns:1fr;gap:10px}
    th,td{font-size:14px}
    .modal .box{max-width:520px;width:96%}
  }
</style>
</head>
<body>

<!-- Bridge Firebase (assure-toi que store-bridge.js contient l’URL de ta base) -->
<script src="store-bridge.js" defer></script>

<div class="header">
  <h1>Tableau de garde</h1>
  <div>
    <!-- Ouvre Paramétrages dans un nouvel onglet -->
    <a href="parametres.html" target="_blank" class="btn">⚙️ Paramétrages</a>
  </div>
</div>

<div class="container">

  <!-- Rôles -->
  <div class="card">
    <h3 style="margin:0 0 8px">Postes de commandement</h3>
    <div class="grid3">
      <div><label>Officier de semaine</label><input data-rolekey="officier_semaine"></div>
      <div><label>Officier de garde</label><input data-rolekey="officier_garde"></div>
      <div><label>Responsable des opérations</label><input data-rolekey="responsable_operations"></div>
      <div><label>Chef de groupe</label><input data-rolekey="chef_groupe"></div>
      <div><label>Chef de poste</label><input data-rolekey="chef_poste"></div>
      <div><label>1er centraliste</label><input data-rolekey="centraliste_1"></div>
      <div><label>2e centraliste</label><input data-rolekey="centraliste_2"></div>
    </div>
  </div>

  <!-- Notes -->
  <div class="card">
    <h3 style="margin:0 0 8px">Notes globales</h3>
    <div class="grid2">
      <div><label>Matériel à récupérer</label><textarea id="note_materiel" placeholder="Ex: Oxymètre, attelles..."></textarea></div>
      <div><label>Informations & remarques</label><textarea id="note_infos" placeholder="Ex: Route barrée rue X, travaux..."></textarea></div>
    </div>
    <p class="muted">Ces notes apparaîtront dans la bannière TV (OUT / Matériel / Infos).</p>
  </div>

  <!-- Stats -->
  <div class="card">
    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;text-align:center">
      <div><div class="status s-dispo">Disponibles</div><div id="cDispo" style="font-size:20px;margin-top:6px">0</div></div>
      <div><div class="status s-sorti">Sortis</div><div id="cSorti" style="font-size:20px;margin-top:6px">0</div></div>
      <div><div class="status s-res">Réserve</div><div id="cReserve" style="font-size:20px;margin-top:6px">0</div></div>
      <div><div class="status s-indispo">Indisponibles</div><div id="cIndispo" style="font-size:20px;margin-top:6px">0</div></div>
    </div>
  </div>

  <!-- Tableau -->
  <div class="card">
    <h3 style="margin:0 0 8px">Véhicules</h3>
    <p class="muted">Ajoute/modifie les véhicules dans <b>Paramétrages</b> (nouvel onglet).</p>
    <div style="overflow:auto; max-height:60vh;">
      <table>
        <thead>
          <tr>
            <th>Véhicule</th>
            <th>Chauffeur</th>
            <th>Soins</th>
            <th>3ᵉ Homme</th>
            <th>Km</th>
            <th>Heure sortie</th>
            <th>Statut</th>
            <th>Commentaire</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- OUT -->
  <div class="card">
    <h3 style="margin:0 0 8px">Véhicules OUT</h3>
    <div id="outList" class="chips"></div>
  </div>

</div>

<!-- MODALE Ré-attribution LH -->
<div id="modalReassign" class="modal">
  <div class="box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 style="margin:0">Ré-attribuer <span id="rea_attrib">LH?</span></h3>
      <button class="btn" onclick="cancelReassign()">✖</button>
    </div>
    <p>Le véhicule <b id="rea_fromVeh">—</b> passe <b>Indisponible</b> avec l’attribution <b id="rea_attrib2">LH?</b>. Choisis un repreneur (LH uniques).</p>
    <input id="rea_search" placeholder="Rechercher un véhicule..." oninput="renderReassignCandidates()">
    <div id="rea_list" style="margin-top:8px;border:1px solid var(--line);border-radius:10px;max-height:50vh;overflow:auto"></div>
    <div style="text-align:right;margin-top:8px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" onclick="liberateOnly()">Libérer sans ré-attribuer</button>
      <button class="btn" onclick="confirmReassign()">Confirmer</button>
    </div>
  </div>
</div>

<script>
/* Catcher d’erreurs pour diagnostiquer vite */
window.onerror = function (msg, src, line, col, err) {
  console.error("JS Error:", msg, "at", src, line+":"+col, err);
  alert("Erreur JS: " + msg);
};

/* Fallback si store-bridge.js manquant */
if (typeof readKey !== 'function' || typeof saveKey !== 'function') {
  console.warn("store-bridge.js introuvable -> fallback localStorage");
  window.readKey = async (k)=>{ try{return JSON.parse(localStorage.getItem(k)||"{}");}catch{return{}} };
  window.saveKey = async (k,o)=>{ localStorage.setItem(k, JSON.stringify(o||{})); };
}

const STORAGE_KEY = "dispatch_parc_vehicules";
const LH_SET = new Set(["LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8"]);
let data = {};
let _rea = { fromVeh:null, attrib:"", selected:null, candidates:[] };

const $ = (id)=>document.getElementById(id);
function esc(s){return String(s??"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]);}

/* Modales (ré-attribution) */
function showModal(id){
  const el = document.getElementById(id);
  if(!el) return;
  document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show'));
  el.classList.add('show');
  document.body.classList.add('modal-open');
}
function hideModal(id){
  const el = document.getElementById(id);
  if(!el) return;
  el.classList.remove('show');
  if(document.querySelectorAll('.modal.show').length===0){
    document.body.classList.remove('modal-open');
  }
}
document.addEventListener('click', (e)=>{
  const m = e.target.closest('.modal');
  if(m && m.classList.contains('show') && !e.target.closest('.box')){
    hideModal(m.id);
  }
});

/* Ensure */
function ensure(){
  if(!data || typeof data!=='object') data = {};
  if(!data._settings) data._settings = { vehs: [] };
  if(!data._roles) data._roles = {};
  if(!data._notes) data._notes = { materiel:"", infos:"" };
  (data._settings.vehs||[]).forEach(v=>{
    if(!data[v.id]) data[v.id] = {
      XO:"",S:"",PS:"",attribution:v.attrib||"",plaque:v.plaque||"",
      km:"",heure_sortie:"",statut:"Disponible",commentaire:"",name:v.name||v.id
    };
  });
}

/* Render */
function renderAll(){ renderRoles(); renderNotes(); renderTable(); renderStats(); renderOut(); }

function renderRoles(){
  document.querySelectorAll('[data-rolekey]').forEach(inp=>{
    const k=inp.dataset.rolekey;
    inp.value = data._roles[k] || "";
    inp.oninput = async e=>{ data._roles[k]=e.target.value; await save(); };
  });
}
function renderNotes(){
  $('note_materiel').value = data._notes.materiel||"";
  $('note_infos').value = data._notes.infos||"";
  $('note_materiel').oninput = async e=>{ data._notes.materiel=e.target.value; await save(); };
  $('note_infos').oninput = async e=>{ data._notes.infos=e.target.value; await save(); };
}

function renderTable(){
  const tb=$('tbody'); tb.innerHTML="";
  (data._settings.vehs||[]).forEach(v=>{
    const d=data[v.id];
    tb.insertAdjacentHTML('beforeend',`
      <tr>
        <td><b>${esc(d.name||v.id)}</b><br><span class="muted">${d.attribution?`Attrib: ${esc(d.attribution)} — `:""}${d.plaque?`Plaque: ${esc(d.plaque)}`:""}</span></td>
        <td><input data-v="${esc(v.id)}" data-k="XO" value="${esc(d.XO||"")}" placeholder="Chauffeur"></td>
        <td><input data-v="${esc(v.id)}" data-k="S" value="${esc(d.S||"")}" placeholder="Soins"></td>
        <td><input data-v="${esc(v.id)}" data-k="PS" value="${esc(d.PS||"")}" placeholder="3ᵉ homme"></td>
        <td><input data-v="${esc(v.id)}" data-k="km" value="${esc(d.km||"")}" placeholder="km (num.)"></td>
        <td><input data-v="${esc(v.id)}" data-k="heure_sortie" value="${esc(d.heure_sortie||"")}" placeholder="HH:MM"></td>
        <td>
          <select data-v="${esc(v.id)}" data-k="statut">
            <option ${d.statut==="Disponible"?"selected":""}>Disponible</option>
            <option ${d.statut==="Sorti"?"selected":""}>Sorti</option>
            <option ${d.statut==="Réserve"?"selected":""}>Réserve</option>
            <option ${d.statut==="Indisponible"?"selected":""}>Indisponible</option>
          </select>
        </td>
        <td><input data-v="${esc(v.id)}" data-k="commentaire" value="${esc(d.commentaire||"")}" placeholder="Remarque…"></td>
      </tr>
    `);
  });

  document.querySelectorAll('input[data-v],select[data-v]').forEach(el=>{
    el.oninput = async ()=>{
      const id=el.dataset.v, k=el.dataset.k;
      const oldStat=data[id]?.statut;

      if(k==="km") el.value = el.value.replace(/[^\d]/g,'');
      data[id][k]=el.value;

      // Auto-heure de sortie si passe "Sorti" et heure vide
      if(k==="statut" && el.value==="Sorti" && !data[id].heure_sortie){
        const d=new Date(); const hh=String(d.getHours()).padStart(2,"0"), mm=String(d.getMinutes()).padStart(2,"0");
        data[id].heure_sortie = `${hh}:${mm}`;
      }

      await save(); renderStats(); renderOut();

      // Ré-attribution si Indisponible et portait une LH
      if(k==="statut" && el.value==="Indisponible" && oldStat!=="Indisponible"){
        const a=(data[id]?.attribution||"").toUpperCase();
        if(LH_SET.has(a)) openReassignModal(id,a);
      }
    };
  });
}
function renderStats(){
  const list=(data._settings.vehs||[]).map(v=>data[v.id]);
  $('cDispo').textContent = list.filter(v=>v.statut==="Disponible").length;
  $('cSorti').textContent = list.filter(v=>v.statut==="Sorti").length;
  $('cReserve').textContent = list.filter(v=>v.statut==="Réserve").length;
  $('cIndispo').textContent = list.filter(v=>v.statut==="Indisponible").length;
}
function renderOut(){
  const box=$('outList'); box.innerHTML="";
  (data._settings.vehs||[]).forEach(v=>{
    const d=data[v.id];
    if(d.statut==="Indisponible"){
      const div=document.createElement('div');
      div.className="chip";
      div.innerHTML = `<b>${esc(d.name||v.id)}</b> ${d.attribution?`<span style="color:#ffec99">[${esc(d.attribution)}]</span>`:""} ${d.commentaire?`— ${esc(d.commentaire)}`:""}`;
      box.appendChild(div);
    }
  });
}

/* LH unicité + ré-attribution */
function enforceLHUnicity(){
  const seen={};
  (data._settings.vehs||[]).forEach(v=>{
    const a=(data[v.id]?.attribution||"").toUpperCase();
    if(LH_SET.has(a)){ if(seen[a]) data[v.id].attribution=""; else seen[a]=v.id; }
    const sv=(data._settings.vehs||[]).find(x=>x.id===v.id); if(sv) sv.attrib=data[v.id].attribution||"";
  });
}

function openReassignModal(fromVeh, attrib){
  _rea={fromVeh, attrib, selected:null,
        candidates:(data._settings.vehs||[]).map(v=>v.id)
          .filter(id=>id!==fromVeh && (data[id]?.statut||"Disponible")!=="Indisponible")};
  $('rea_fromVeh').textContent=fromVeh; $('rea_attrib').textContent=attrib; $('rea_attrib2').textContent=attrib;
  $('rea_search').value=""; renderReassignCandidates(); showModal('modalReassign');
}
function renderReassignCandidates(){
  const box=$('rea_list'); box.innerHTML="";
  const q=($('rea_search').value||"").toLowerCase();
  const items=_rea.candidates.map(id=>{
    const d=data[id]||{}; const other = LH_SET.has((d.attribution||"").toUpperCase()) && (d.attribution||"").toUpperCase()!==_rea.attrib;
    return {id,name:d.name||id,stat:d.statut||"Disponible",attrib:d.attribution||"",disabled:other};
  }).filter(x=>(x.id+" "+x.name+" "+x.stat+" "+x.attrib).toLowerCase().includes(q));
  if(!items.length){ box.innerHTML=`<div class="muted" style="padding:10px">Aucun candidat…</div>`; return; }
  items.forEach(x=>{
    const row=document.createElement('label'); row.style.display="block"; row.style.padding="8px"; row.style.borderBottom="1px solid var(--line)";
    row.style.cursor=x.disabled?'not-allowed':'pointer'; row.style.opacity=x.disabled?.6:1;
    row.innerHTML = `<input type="radio" name="rea_choice" value="${esc(x.id)}" ${x.disabled?'disabled':''} onchange="_rea.selected=this.value" style="margin-right:8px">
                     <b>${esc(x.name)}</b> <span class="muted">(${esc(x.id)}) — Statut: ${esc(x.stat)} — Attrib: ${esc(x.attrib||"—")}${x.disabled?` (porte déjà ${esc(x.attrib)})`:''}</span>`;
    box.appendChild(row);
  });
}
function cancelReassign(){ hideModal('modalReassign'); _rea={fromVeh:null,attrib:"",selected:null,candidates:[]}; }
async function liberateOnly(){
  if(!_rea.fromVeh) return cancelReassign();
  data[_rea.fromVeh].attribution=""; const sv=(data._settings.vehs||[]).find(x=>x.id===_rea.fromVeh); if(sv) sv.attrib="";
  await save(); renderAll(); cancelReassign(); alert("Attribution libérée.");
}
async function confirmReassign(){
  if(!_rea.selected) return alert("Sélectionne un véhicule repreneur.");

  // Retire l’attribution des autres véhicules qui la portent
  (data._settings.vehs||[]).forEach(v=>{
    if((data[v.id]?.attribution||"").toUpperCase()===_rea.attrib.toUpperCase()){
      data[v.id].attribution="";
      const sv=(data._settings.vehs||[]).find(x=>x.id===v.id);
      if(sv) sv.attrib="";
    }
  });

  // Libère sur le véhicule indisponible
  if(data[_rea.fromVeh]){
    data[_rea.fromVeh].attribution="";
    const sv=(data._settings.vehs||[]).find(x=>x.id===_rea.fromVeh);
    if(sv) sv.attrib="";
  }

  // Assigne au repreneur
  if(!data[_rea.selected]) data[_rea.selected]={};
  data[_rea.selected].attribution=_rea.attrib;
  const sv2=(data._settings.vehs||[]).find(x=>x.id===_rea.selected);
  if(sv2) sv2.attrib=_rea.attrib;

  await save();
  renderAll();
  cancelReassign();
  alert(`${_rea.attrib} est maintenant attribué à ${_rea.selected}.`);
}

/* Persistance */
async function save(){ await saveKey(STORAGE_KEY, data); }

/* Boot */
(async()=>{
  data = await readKey(STORAGE_KEY);
  ensure(); renderAll();
})();
</script>
</body>
</html>
