<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tableau des missions</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
  :root{
    --bg:#0a0f16;--panel:#121821;--line:#1f2c3e;
    --text:#f1f5fa;
    --muted:#9bb5d3;
    --depart:#f0c000;--surplace:#ff9800;--route:#2196f3;
    --hopital:#9c27b0;--retour:#2e7d32;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Segoe UI,Inter,system-ui,sans-serif;overflow:hidden;}
  .layout{display:grid;grid-template-columns:1fr 2fr;height:100vh}
  .missions{background:#0f1624;border-right:2px solid #223146;overflow-y:auto;padding:10px;}
  .map{position:relative}
  #map{height:100%;width:100%}

  .mission{border:1px solid #223146;border-radius:8px;padding:8px;margin-bottom:8px;background:#121e31;display:flex;flex-direction:column;gap:4px;}
  .mission .header{display:flex;justify-content:space-between;align-items:center;}
  .mission .num{font-size:20px;font-weight:800;color:#cfe1ff;}
  .mission .type{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;}
  .mission .statut{font-size:13px;font-weight:700;}
  .mission .loc{font-size:14px;color:#b8c9e0;}
  .mission .equip{font-size:13px;color:#9bb5d3;}
  .mission .time{font-size:12px;color:#8394aa;}
  .mission.depart{border-left:4px solid var(--depart);}
  .mission.surplace{border-left:4px solid var(--surplace);}
  .mission.route{border-left:4px solid var(--route);}
  .mission.hopital{border-left:4px solid var(--hopital);}
  .mission.retour{border-left:4px solid var(--retour);}
</style>
</head>
<body>
<script src="store-bridge.js"></script>

<div class="layout">
  <div class="missions" id="missionList">Chargement des missions…</div>
  <div class="map"><div id="map"></div></div>
</div>

<script>
if(typeof readKey!=='function'){ alert("store-bridge.js manquant"); }

const KEY="missions_actives";
let map,baseMarker,markers={};
const basePos=[50.730713,4.494666]; // Avenue René Soyer 3, 1310 La Hulpe

// Initialisation carte
function initMap(){
  map=L.map('map',{zoomControl:false}).setView(basePos,12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:18,attribution:'© OpenStreetMap'
  }).addTo(map);
  baseMarker=L.marker(basePos,{title:"Base – La Hulpe"}).addTo(map);
}

// Traduction statut -> classe couleur
function statutClass(s){
  switch(s){
    case "Départ": return "depart";
    case "Sur place": return "surplace";
    case "En route vers l'hôpital": return "route";
    case "À l'hôpital": return "hopital";
    case "Retour disponible":
    case "Retour indisponible": return "retour";
    default: return "";
  }
}

// Attribution des numéros fixes
let nextNum=1;
let numMap={}; // missionID -> numéro

function assignNumbers(missions){
  const used=new Set(Object.values(numMap));
  missions.forEach(m=>{
    if(!numMap[m.id]){
      // cherche un numéro libre le plus petit
      let n=1;while(used.has(n))n++;
      numMap[m.id]=n;used.add(n);
    }
  });
  // supprime les numéros des missions clôturées
  const ids=new Set(missions.map(m=>m.id));
  for(const id in numMap){
    if(!ids.has(id)) delete numMap[id];
  }
}

function renderMissions(data){
  const list = Object.entries(data).filter(([id,m])=>!id.startsWith("_"))
                .map(([id,m])=>({...m,id}));
  assignNumbers(list);
  // tri : plus récente en haut
  list.sort((a,b)=> (b.timestamp||0) - (a.timestamp||0));

  const container=document.getElementById("missionList");
  if(list.length===0){ container.textContent="Aucune mission en cours."; return; }

  container.innerHTML=list.map(m=>{
    const c=statutClass(m.statut);
    const loc=m.localite ? `${m.code_postal||''} ${m.localite}`.trim() : "—";
    const equip=m.equipage||m.vehicule||"";
    const h=new Date(m.timestamp||Date.now()).toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
    return `<div class="mission ${c}">
      <div class="header">
        <div class="num">#${numMap[m.id]}</div>
        <div class="type">${m.type||"Mission"}</div>
      </div>
      <div class="statut">${m.statut||"—"}</div>
      <div class="loc">${loc}</div>
      ${equip?`<div class="equip">${equip}</div>`:""}
      <div class="time">${h}</div>
    </div>`;
  }).join("");

  updateMap(list);
}

function updateMap(list){
  // supprime anciens marqueurs
  Object.values(markers).forEach(m=>map.removeLayer(m));
  markers={};
  list.forEach(m=>{
    if(!m.lat||!m.lon) return;
    const color = (()=>{
      switch(m.statut){
        case "Départ": return "gold";
        case "Sur place": return "orange";
        case "En route vers l'hôpital": return "deepskyblue";
        case "À l'hôpital": return "violet";
        case "Retour disponible":
        case "Retour indisponible": return "limegreen";
        default: return "red";
      }
    })();
    const icon=L.divIcon({className:"",html:`<div style="background:${color};border:2px solid #fff;border-radius:50%;width:14px;height:14px"></div>`});
    markers[m.id]=L.marker([m.lat,m.lon],{icon,title:`#${numMap[m.id]} ${m.type||''}`}).addTo(map);
  });
}

async function refresh(){
  try{
    const data = await readKey(KEY)||{};
    renderMissions(data);
  }catch(e){ console.error(e); }
}

initMap();
refresh();
setInterval(refresh,5000);
</script>
</body>
</html>
