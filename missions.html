<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Missions — Édition</title>
<style>
  :root{ --bg:#0b0f14; --panel:#121821; --line:#223044; --txt:#e8eef5; --mut:#9fb2c9; --acc:#3a8bf2; }
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,Segoe UI,Arial,sans-serif}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0d131c;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:20px;color:#cfe1ff}
  .wrap{display:grid;grid-template-columns:420px 1fr;gap:12px;padding:12px;min-height:calc(100vh - 58px)}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  h2{margin:0 0 10px;color:#cfe1ff;font-size:18px}
  label{font-size:13px;color:var(--mut)}
  input,select,textarea{width:100%;box-sizing:border-box;padding:8px;border-radius:8px;border:1px solid var(--line);background:#0b1626;color:#fff}
  textarea{min-height:80px;resize:vertical}
  .row{display:grid;gap:10px}
  .row2{grid-template-columns:1fr 1fr}
  .row3{grid-template-columns:1fr 1fr 1fr}
  .mut{color:var(--mut);font-size:12px}
  .btn{background:#2f7bf6;border:0;color:#fff;border-radius:8px;padding:10px 12px;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .renforts table{width:100%;border-collapse:collapse}
  .renforts th,.renforts td{border:1px solid var(--line);padding:6px;text-align:left;font-size:14px;vertical-align:top}
  .list{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .mission{background:#0f1724;border:1px solid var(--line);border-radius:12px;padding:12px}
  .bad{color:#ffb3b3}
</style>
</head>
<body>

<!-- Auth guard -->
<script>
(function(){
  if(!localStorage.getItem("dispatch_idToken")) location.href="index.html";
})();
</script>

<script src="store-bridge.js"></script>

<header>
  <h1>Missions — Édition</h1>
  <div id="saveState" class="mut">Connecté</div>
</header>

<div class="wrap">
  <!-- Colonne gauche : création/édition -->
  <div class="card">
    <h2>Créer une mission</h2>
    <div class="row row2">
      <div>
        <label>Type</label>
        <select id="m_type">
          <option value="112">112</option>
          <option value="TMS">TMS</option>
        </select>
      </div>
      <div>
        <label>Véhicule</label>
        <input id="m_veh" placeholder="AS 55">
      </div>
      <div>
        <label>Attribution</label>
        <input id="m_attr" placeholder="LH1 / TMS / PREV / OFF">
      </div>
      <div id="blk_retour_prevus" style="display:none">
        <label>Retour avec patient prévu (TMS)</label>
        <select id="m_retour_prevus">
          <option value="false">Non</option>
          <option value="true">Oui</option>
        </select>
      </div>
    </div>

    <div id="blk_112" class="row row2" style="margin-top:10px">
      <div>
        <label>CU112</label>
        <input id="m_centrale" placeholder="Liège / Namur ...">
      </div>
      <div>
        <label>Numéro 112 (4 derniers)</label>
        <input id="m_num112" inputmode="numeric" maxlength="4" placeholder="1234">
      </div>
    </div>

    <div class="card" style="margin-top:10px;background:#0f1724">
      <h2 style="font-size:16px">Lieu de PEC (TMS)</h2>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
        <label><input type="radio" name="pecType" value="dom" checked> Domicile</label>
        <label><input type="radio" name="pecType" value="str"> Hôpital / MR(S)</label>
      </div>
      <div id="pec_dom" class="row row2">
        <div><label>Rue</label><input id="pec_rue"></div>
        <div><label>N°</label><input id="pec_num"></div>
        <div><label>CP</label><input id="pec_cp" list="cpOptions"></div>
        <div><label>Localité</label><input id="pec_ville" list="villeOptions"></div>
      </div>

      <div id="pec_str" style="display:none">
        <div class="row">
          <div>
            <label>Recherche structure</label>
            <input id="pec_hop_search" list="pecHopList" placeholder="CHU / Clinique ...">
            <datalist id="pecHopList"></datalist>
            <small class="mut">Recherche Internet (OSM). Tape au moins 3 caractères.</small>
          </div>
        </div>
        <div class="row row2" style="margin-top:6px">
          <div><label>Nom</label><input id="pec_hop_name" readonly></div>
          <div><label>Adresse</label><input id="pec_hop_addr" readonly></div>
          <div><label>CP</label><input id="pec_cp2"></div>
          <div><label>Localité</label><input id="pec_ville2"></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:10px;background:#0f1724">
      <h2 style="font-size:16px">Destination (112 & TMS)</h2>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
        <label><input type="radio" name="destType" value="dom" checked> Domicile</label>
        <label><input type="radio" name="destType" value="str"> Hôpital / MR(S)</label>
      </div>
      <div id="dest_dom" class="row row2">
        <div><label>Rue</label><input id="dest_rue"></div>
        <div><label>N°</label><input id="dest_num"></div>
        <div><label>CP</label><input id="dest_cp" list="cpOptions"></div>
        <div><label>Localité</label><input id="dest_ville" list="villeOptions"></div>
      </div>

      <div id="dest_str" style="display:none">
        <div class="row">
          <div>
            <label>Recherche structure</label>
            <input id="dest_hop_search" list="destHopList" placeholder="Saint-Luc / Erasme ...">
            <datalist id="destHopList"></datalist>
            <small class="mut">Recherche Internet (OSM). Tape au moins 3 caractères.</small>
          </div>
        </div>
        <div class="row row2" style="margin-top:6px">
          <div><label>Nom</label><input id="dest_hop_name" readonly></div>
          <div><label>Adresse</label><input id="dest_hop_addr" readonly></div>
          <div><label>CP</label><input id="dest_cp2"></div>
          <div><label>Localité</label><input id="dest_ville2"></div>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:10px">
      <div>
        <label>Commentaire mission</label>
        <textarea id="m_comment" placeholder="Infos complémentaires..."></textarea>
      </div>
    </div>

    <div class="card renforts" style="margin-top:10px;background:#0f1724">
      <h2 style="font-size:16px">Renforts</h2>
      <table>
        <thead>
          <tr>
            <th>Service</th>
            <th>Commentaire</th>
            <th>Statut d’appel</th>
            <th>Sur place</th>
          </tr>
        </thead>
        <tbody id="renforts_tbody"></tbody>
      </table>
      <small class="mut">Statut d’appel: Appelé / Confirmé / Refusé / En route / Non dispo — Sur place: Inconnu / Oui / Non</small>
    </div>

    <div style="margin-top:12px;display:flex;gap:8px;justify-content:flex-end">
      <button class="btn" id="btnCreate">Créer la mission</button>
    </div>
  </div>

  <!-- Colonne droite : missions actives -->
  <div class="card">
    <h2>Missions en cours</h2>
    <div id="list" class="list"></div>
  </div>
</div>

<!-- Datalists CP/Ville (ODWB index si tu l’utilises déjà) -->
<datalist id="cpOptions"></datalist>
<datalist id="villeOptions"></datalist>

<script>
/* ---------- Constantes ---------- */
const MISSIONS_KEY = "dispatch_missions";
const SERVICES = ["Pompiers","RACS","SMUR","Ambu 112","Police"];
const APPEL_STATI = ["","Appelé","Confirmé","Refusé","En route","Non dispo"];
const SUR_PLACE_STATI = ["","Inconnu","Oui","Non"];

/* ---------- État local ---------- */
let MISSIONS = {};
let saving = false;

/* ---------- Utils ---------- */
const $ = id => document.getElementById(id);
const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const nowISO = ()=> {
  const d=new Date(), z2=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${z2(d.getMonth()+1)}-${z2(d.getDate())} ${z2(d.getHours())}:${z2(d.getMinutes())}:${z2(d.getSeconds())}`;
};

/* ---------- Rendu Renforts (form) ---------- */
function renderRenfortsForm(){
  const tb = $('renforts_tbody'); tb.innerHTML="";
  SERVICES.forEach(s=>{
    const row = document.createElement('tr');
    row.innerHTML = `
      <td><b>${s}</b></td>
      <td><textarea data-r="${s}" data-k="comment" placeholder="Commentaire..."></textarea></td>
      <td>
        <select data-r="${s}" data-k="appel">
          ${APPEL_STATI.map(v=>`<option value="${v}">${v||"-"}</option>`).join("")}
        </select>
      </td>
      <td>
        <select data-r="${s}" data-k="sur_place">
          ${SUR_PLACE_STATI.map(v=>`<option value="${v}">${v||"-"}</option>`).join("")}
        </select>
      </td>
    `;
    tb.appendChild(row);
  });
}

/* ---------- Recherche hôpital (OSM Nominatim) | attachable ---------- */
function attachHospitalSearch(searchId, listId, outNameId, outAddrId, outCPId, outVilleId){
  const NOM_URL = "https://nominatim.openstreetmap.org/search";
  const input = $(searchId), dlist = $(listId);
  const outName = $(outNameId), outAddr = $(outAddrId);
  const outCP = outCPId? $(outCPId): null;
  const outVille = outVilleId? $(outVilleId): null;

  const mem = new Map();
  function formatDisplay(r){
    const name = r.display_name?.split(",")[0] || r.name || "Structure";
    const a = r.address || {};
    const rue = [a.road,a.house_number].filter(Boolean).join(" ");
    const cp  = a.postcode || "";
    const city= a.city || a.town || a.village || a.municipality || "";
    const line = [rue,cp,city].filter(Boolean).join(", ");
    return { name, line, cp, city };
  }
  const doSearch = async ()=>{
    const q = input.value.trim();
    if(q.length<3){ dlist.innerHTML=""; return; }
    if(mem.has(q.toLowerCase())){ render(mem.get(q.toLowerCase())); return; }
    const url = `${NOM_URL}?format=jsonv2&addressdetails=1&countrycodes=be&limit=20&q=${encodeURIComponent(q+" hospital clinic clinique hopital centre hospitalier CHU UZ")}`;
    try{
      const res = await fetch(url, { cache:"no-store" });
      const arr = await res.json();
      const items = arr.map(r=>{
        const f = formatDisplay(r);
        return { k:String(r.place_id), name:f.name, line:f.line, cp:f.cp, city:f.city };
      });
      mem.set(q.toLowerCase(), items);
      render(items);
    }catch(e){ dlist.innerHTML=""; }
  };
  const render = (items)=>{
    dlist.innerHTML = items.map(it=>`<option value="${esc(it.name)} — ${esc(it.line)}" data-k="${esc(it.k)}"></option>`).join("");
  };
  const onChoose = ()=>{
    const val = input.value.trim().toLowerCase();
    let choice=null;
    for(const items of mem.values()){
      const found = items.find(it => (`${it.name} — ${it.line}`).toLowerCase()===val || it.name.toLowerCase()===val);
      if(found){ choice=found; break; }
    }
    if(!choice){ outName.value = input.value; outAddr.value=""; return; }
    outName.value = choice.name;
    outAddr.value = choice.line || "";
    if(outCP && choice.cp) outCP.value = choice.cp;
    if(outVille && choice.city) outVille.value = choice.city;
  };

  input.addEventListener('input', ()=>{ clearTimeout(input._t); input._t=setTimeout(doSearch,300); });
  input.addEventListener('change', onChoose);
  input.addEventListener('blur', onChoose);
}

/* ---------- Toggle PEC/Dest DOM/STR ---------- */
function bindToggles(){
  document.querySelectorAll('input[name="pecType"]').forEach(r=>{
    r.onchange = ()=>{
      $('pec_dom').style.display = (r.value==='dom')?'grid':'none';
      $('pec_str').style.display = (r.value==='str')?'block':'none';
    };
  });
  document.querySelectorAll('input[name="destType"]').forEach(r=>{
    r.onchange = ()=>{
      $('dest_dom').style.display = (r.value==='dom')?'grid':'none';
      $('dest_str').style.display = (r.value==='str')?'block':'none';
    };
  });
}

/* ---------- Création mission ---------- */
async function createMissionFromForm(){
  if(saving) return;
  const type = $('m_type').value;
  const veh  = $('m_veh').value.trim();
  if(!veh){ alert("Véhicule requis"); return; }
  const m = {
    id: `M${Date.now()}`,
    type,
    veh,
    attr: $('m_attr').value.trim() || "",
    statuts: {},
    metrics: {},
    comment: $('m_comment').value.trim() || "",
    renforts: {},

    // TMS spécifique
    retour_prevus: (type==='TMS' ? ($('m_retour_prevus').value==='true') : undefined),

    // PEC
    pec: (()=>{
      const kind = document.querySelector('input[name="pecType"]:checked')?.value || 'dom';
      if(type!=='TMS'){ return null; }
      if(kind==='dom'){
        return { type:'dom', rue:$('pec_rue').value.trim(), num:$('pec_num').value.trim(), cp:$('pec_cp').value.trim(), ville:$('pec_ville').value.trim() };
      }else{
        return { type:'str', name:$('pec_hop_name').value.trim(), addr:$('pec_hop_addr').value.trim(), cp:$('pec_cp2').value.trim(), ville:$('pec_ville2').value.trim() };
      }
    })(),

    // Destination
    destination: (()=>{
      const kind = document.querySelector('input[name="destType"]:checked')?.value || 'dom';
      if(kind==='dom'){
        return { type:'dom', rue:$('dest_rue').value.trim(), num:$('dest_num').value.trim(), cp:$('dest_cp').value.trim(), ville:$('dest_ville').value.trim() };
      }else{
        return { type:'str', name:$('dest_hop_name').value.trim(), addr:$('dest_hop_addr').value.trim(), cp:$('dest_cp2').value.trim(), ville:$('dest_ville2').value.trim() };
      }
    })()
  };

  if(type==='112'){
    m.centrale = $('m_centrale').value.trim();
    m.num112   = $('m_num112').value.trim();
    m.statuts["Appel"] = nowISO(); // création
  }

  // Renforts
  SERVICES.forEach(s=>{
    const comment = (document.querySelector(`textarea[data-r="${s}"][data-k="comment"]`)?.value||"").trim();
    const appel   = (document.querySelector(`select[data-r="${s}"][data-k="appel"]`)?.value||"").trim();
    const surp    = (document.querySelector(`select[data-r="${s}"][data-k="sur_place"]`)?.value||"").trim();
    if(comment || appel || surp){
      m.renforts[s] = { comment, appel_status:appel, sur_place:surp };
    }
  });

  try{
    saving = true; $('saveState').textContent="Sauvegarde…";
    await patchKey(`${MISSIONS_KEY}/${m.id}`, m);
    $('saveState').textContent="Sauvegardé ✔︎";
    MISSIONS[m.id]=m;
    renderList();
  }catch(e){
    $('saveState').innerHTML=`<span class="bad">Erreur de sauvegarde</span>`;
    console.error(e);
  }finally{ saving=false; setTimeout(()=>$('saveState').textContent="Connecté", 1500); }
}

/* ---------- Liste missions actives (aperçu) ---------- */
function renderList(){
  const cont = $('list'); cont.innerHTML = "";
  const arr = Object.values(MISSIONS).filter(x=>!x.done);
  // tri par date de création/id
  arr.sort((a,b)=> (b.id||"").localeCompare(a.id||""));

  arr.forEach(m=>{
    const div = document.createElement('div');
    div.className="mission";
    const renfBadges = Object.entries(m.renforts||{}).map(([k,v])=>{
      const a = v.appel_status?`<span class="mut">• ${esc(v.appel_status)}</span>`:"";
      const s = v.sur_place?`<span class="mut">• SP:${esc(v.sur_place)}</span>`:"";
      const c = v.comment?`<div class="mut">${esc(v.comment)}</div>`:"";
      return `<div><b>${esc(k)}</b> ${a} ${s}${c}</div>`;
    }).join("");

    const destText = m.destination
      ? (m.destination.type==='str'
          ? `[STR] ${esc(m.destination.name||"")} — ${esc(m.destination.addr||"")} ${esc(m.destination.cp||"")} ${esc(m.destination.ville||"")}`
          : `[DOM] ${esc(m.destination.rue||"")} ${esc(m.destination.num||"")} ${esc(m.destination.cp||"")} ${esc(m.destination.ville||"")}`)
      : "-";

    const pecText = (m.type==='TMS' && m.pec)
      ? (m.pec.type==='str'
          ? `[STR] ${esc(m.pec.name||"")} — ${esc(m.pec.addr||"")} ${esc(m.pec.cp||"")} ${esc(m.pec.ville||"")}`
          : `[DOM] ${esc(m.pec.rue||"")} ${esc(m.pec.num||"")} ${esc(m.pec.cp||"")} ${esc(m.pec.ville||"")}`)
      : "-";

    div.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:start">
        <div>
          <div><b>${esc(m.veh||"-")}</b> ${m.attr?`<span class="mut">[${esc(m.attr)}]</span>`:""} — ${esc(m.type)}</div>
          ${m.type==='TMS' ? `<div class="mut" style="margin-top:2px">PEC: ${pecText}</div>`:""}
          <div class="mut" style="margin-top:2px">Destination: ${destText}</div>
          ${m.comment?`<div class="mut" style="margin-top:6px">💬 ${esc(m.comment)}</div>`:""}
        </div>
        <div style="text-align:right">
          ${m.type==='112'
            ? `<div class="mut">CU112: ${esc(m.centrale||"-")} • N° ${esc(m.num112||"-")}</div>`
            : (m.retour_prevus===true ? `<div class="mut">Retour patient: Oui</div>`:`<div class="mut">Retour patient: Non</div>`)}
        </div>
      </div>
      ${renfBadges?`<div style="margin-top:8px">${renfBadges}</div>`:""}
    `;
    cont.appendChild(div);
  });

  if(!arr.length) cont.innerHTML = `<div class="mut">Aucune mission en cours</div>`;
}

/* ---------- Chargement + polling ---------- */
async function loadAll(){
  try{
    MISSIONS = await readKey(MISSIONS_KEY) || {};
  }catch(e){
    console.warn("Lecture missions KO", e);
    MISSIONS = {};
  }
  renderList();
}

/* ---------- Bind UI ---------- */
$('m_type').onchange = ()=>{
  const t = $('m_type').value;
  $('blk_112').style.display = (t==='112')?'grid':'none';
  $('blk_retour_prevus').style.display = (t==='TMS')?'block':'none';
};

$('btnCreate').onclick = createMissionFromForm;

/* Toggles PEC/Dest */
bindToggles();

/* Renforts form */
renderRenfortsForm();

/* Hôpital search attach (PEC & DEST) */
attachHospitalSearch('pec_hop_search','pecHopList','pec_hop_name','pec_hop_addr','pec_cp2','pec_ville2');
attachHospitalSearch('dest_hop_search','destHopList','dest_hop_name','dest_hop_addr','dest_cp2','dest_ville2');

/* Boot */
(async function(){
  await loadAll();
  setInterval(loadAll, 5000);
})();
</script>

</body>
</html>
