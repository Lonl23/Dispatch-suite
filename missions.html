<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Missions en cours</title>
<style>
:root{
  --bg:#0b0f14;--panel:#121821;--line:#223044;
  --text:#e8eef5;--muted:#93a7bf;--accent:#3a8bf2;--danger:#e74c3c;--ok:#27ae60;
}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Arial,sans-serif;}
h1{margin:16px;font-size:24px}
.toolbar{display:flex;gap:8px;margin:0 16px}
button{background:var(--accent);border:0;border-radius:8px;padding:8px 14px;color:#fff;cursor:pointer;font-weight:600}
button.secondary{background:#607d8b}
button.ghost{background:#0f1520;border:1px solid #2c3d52}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;margin:16px;padding:16px}
label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
input,select,textarea{width:100%;padding:6px;border-radius:6px;border:1px solid #2c3d52;background:#0f1520;color:#fff;box-sizing:border-box}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
th{background:#182030}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
fieldset{border:1px solid #2c3d52;border-radius:8px;margin-top:10px;padding:10px}
legend{color:var(--accent)}
.status-btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.status-btns button{flex:1;min-width:140px;background:#0f1520;border:1px solid #2c3d52}
.status-btns button.active{background:var(--accent)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2c3d52;font-size:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:900px){ .row{grid-template-columns:1fr} }
.small{font-size:12px;color:#cfe1ff}
.renforts{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}
.renforts label{margin:0;font-size:13px;color:#e8eef5;display:flex;gap:6px;align-items:center}
.thin{font-weight:400;opacity:.9}
.subgrid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media (max-width:1100px){ .subgrid{grid-template-columns:1fr} }
.help{font-size:12px;color:#9fb2c9}
</style>
</head>
<body>
<h1>Gestion des missions</h1>

<div class="toolbar">
  <button class="ghost" onclick="window.open('dispatch.html','_blank')">‚Ü©Ô∏è Retour dispatch</button>
  <button class="ghost" onclick="window.open('missions-passees.html','_blank')">üìö Missions pass√©es</button>
</div>

<div class="panel">
  <h2>Nouvelle mission</h2>
  <div class="grid">
    <div><label>V√©hicule</label><select id="mVeh"></select></div>
    <div><label>Attribution</label><input id="mAttr" readonly></div>
    <div>
      <label>Type</label>
      <select id="mType">
        <option value="">‚Äî</option><option>TMS</option><option>112</option><option>Pr√©vention</option><option>Logistique</option>
      </select>
    </div>
    <div id="zone112" style="display:none">
      <label>Centrale 112</label>
      <select id="mCentrale">
        <option value="">‚Äî</option><option>Mons</option><option>Namur</option><option>Arlon</option><option>Li√®ge</option><option>Leuven</option><option>Bruxelles</option><option>Autres</option>
      </select>
      <label>Num√©ro mission (4 derniers)</label>
      <input id="mNum112" maxlength="4" placeholder="xxxx">
      <label>D√©part</label>
      <select id="mDepart"><option>Normal</option><option>M√©dical</option></select>
    </div>
  </div>

  <label>Motif du transport</label>
  <input id="mMotif" placeholder="Ex: Malaise, dialyse, transfert‚Ä¶">

  <label>Commentaire mission</label>
  <textarea id="mComment" placeholder="Infos compl√©mentaires utiles √† la centrale / √©quipage‚Ä¶"></textarea>

  <fieldset>
    <legend>Adresse (lieu d‚Äôappel)</legend>
    <div class="grid">
      <div><label>Rue</label><input id="mRue"></div>
      <div><label>Num√©ro / Bo√Æte</label><input id="mNum"></div>
      <div><label>Code postal</label><input id="mCP" maxlength="4"></div>
      <div><label>Localit√©</label><input id="mLocalite" placeholder="Auto si CP connu"></div>
    </div>
  </fieldset>

  <fieldset id="pecField" style="display:none">
    <legend>PEC (TMS)</legend>
    <div class="help">Lieu de prise en charge (TMS) : Domicile ou Structure (H√¥pital/MR(S))</div>
    <div class="renforts" style="margin-top:6px">
      <label><input type="radio" name="pecType" value="dom" checked> Domicile</label>
      <label><input type="radio" name="pecType" value="str"> H√¥pital / MR(S)</label>
    </div>
    <div id="pec_dom" class="grid" style="margin-top:6px">
      <div><label>Rue</label><input id="pec_rue"></div>
      <div><label>N¬∞</label><input id="pec_num"></div>
      <div><label>CP</label><input id="pec_cp" maxlength="4" list="cpOptions"></div>
      <div><label>Localit√©</label><input id="pec_ville" list="villeOptions"></div>
    </div>
    <div id="pec_str" style="display:none;margin-top:6px">
      <div><label>Recherche structure</label><input id="pec_hop_search" list="pecHopList" placeholder="CHU / Clinique ‚Ä¶"><datalist id="pecHopList"></datalist></div>
      <div class="grid" style="margin-top:6px">
        <div><label>Nom s√©lectionn√©</label><input id="pec_hop_name" readonly></div>
        <div><label>Adresse</label><input id="pec_hop_addr" readonly></div>
        <div><label>CP</label><input id="pec_cp2"></div>
        <div><label>Localit√©</label><input id="pec_ville2"></div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Destination (112 & TMS)</legend>
    <div class="help">Domicile ou Structure (H√¥pital/MR(S)) ‚Äî recherche Internet disponible</div>
    <div class="renforts" style="margin-top:6px">
      <label><input type="radio" name="destType" value="dom" checked> Domicile</label>
      <label><input type="radio" name="destType" value="str"> H√¥pital / MR(S)</label>
    </div>
    <div id="dest_dom" class="grid" style="margin-top:6px">
      <div><label>Rue</label><input id="dest_rue"></div>
      <div><label>N¬∞</label><input id="dest_num"></div>
      <div><label>CP</label><input id="dest_cp" maxlength="4" list="cpOptions"></div>
      <div><label>Localit√©</label><input id="dest_ville" list="villeOptions"></div>
    </div>
    <div id="dest_str" style="display:none;margin-top:6px">
      <div><label>Recherche structure</label><input id="dest_hop_search" list="destHopList" placeholder="Saint-Luc / Erasme ‚Ä¶"><datalist id="destHopList"></datalist></div>
      <div class="grid" style="margin-top:6px">
        <div><label>Nom s√©lectionn√©</label><input id="dest_hop_name" readonly></div>
        <div><label>Adresse</label><input id="dest_hop_addr" readonly></div>
        <div><label>CP</label><input id="dest_cp2"></div>
        <div><label>Localit√©</label><input id="dest_ville2"></div>
      </div>
    </div>
  </fieldset>

  <fieldset>
    <legend>Renforts</legend>
    <div class="renforts">
      <span class="thin">Raccourcis :</span>
      <label><input type="checkbox" id="rfPompiers"> Pompiers</label>
      <label><input type="checkbox" id="rfPolice"> Police</label>
      <label><input type="checkbox" id="rfSmur"> SMUR</label>
      <label><input type="checkbox" id="rfAmbu112"> Ambu 112</label>
      <label><input type="checkbox" id="rfRacs"> RACS</label>
    </div>
    <div class="subgrid" style="margin-top:10px">
      <div>
        <h4>Pompiers</h4>
        <label>Statut d‚Äôappel</label>
        <select id="rf_p_appel"><option></option><option>Appel√©</option><option>Confirm√©</option><option>Refus√©</option><option>En route</option><option>Non dispo</option></select>
        <label>Sur place</label>
        <select id="rf_p_sp"><option></option><option>Inconnu</option><option>Oui</option><option>Non</option></select>
        <label>Commentaire</label>
        <textarea id="rf_p_com"></textarea>
      </div>
      <div>
        <h4>RACS</h4>
        <label>Statut d‚Äôappel</label>
        <select id="rf_r_appel"><option></option><option>Appel√©</option><option>Confirm√©</option><option>Refus√©</option><option>En route</option><option>Non dispo</option></select>
        <label>Sur place</label>
        <select id="rf_r_sp"><option></option><option>Inconnu</option><option>Oui</option><option>Non</option></select>
        <label>Commentaire</label>
        <textarea id="rf_r_com"></textarea>
      </div>
      <div>
        <h4>SMUR</h4>
        <label>Statut d‚Äôappel</label>
        <select id="rf_s_appel"><option></option><option>Appel√©</option><option>Confirm√©</option><option>Refus√©</option><option>En route</option><option>Non dispo</option></select>
        <label>Sur place</label>
        <select id="rf_s_sp"><option></option><option>Inconnu</option><option>Oui</option><option>Non</option></select>
        <label>Commentaire</label>
        <textarea id="rf_s_com"></textarea>
      </div>
      <div>
        <h4>Ambu 112</h4>
        <label>Statut d‚Äôappel</label>
        <select id="rf_a_appel"><option></option><option>Appel√©</option><option>Confirm√©</option><option>Refus√©</option><option>En route</option><option>Non dispo</option></select>
        <label>Sur place</label>
        <select id="rf_a_sp"><option></option><option>Inconnu</option><option>Oui</option><option>Non</option></select>
        <label>Commentaire</label>
        <textarea id="rf_a_com"></textarea>
      </div>
      <div>
        <h4>Police</h4>
        <label>Statut d‚Äôappel</label>
        <select id="rf_pol_appel"><option></option><option>Appel√©</option><option>Confirm√©</option><option>Refus√©</option><option>En route</option><option>Non dispo</option></select>
        <label>Sur place</label>
        <select id="rf_pol_sp"><option></option><option>Inconnu</option><option>Oui</option><option>Non</option></select>
        <label>Commentaire</label>
        <textarea id="rf_pol_com"></textarea>
      </div>
    </div>
  </fieldset>

  <div class="small" id="kmHint" style="margin-top:6px;opacity:.9"></div>

  <div style="text-align:right;margin-top:10px">
    <button onclick="startMission()">D√©marrer la mission</button>
  </div>
</div>

<div class="panel">
  <h2>Missions en cours</h2>
  <div id="activeMissions"></div>
</div>

<div class="panel">
  <div class="row" style="align-items:center">
    <h2 style="margin:0">Missions du jour</h2>
    <div style="text-align:right">
      <button class="secondary" onclick="deleteSelectedDone()">üóë Supprimer la s√©lection (Admin)</button>
    </div>
  </div>
  <table id="tableDone">
    <thead>
      <tr>
        <th style="width:32px"></th>
        <th>V√©hicule</th><th>Attribution</th><th>Type</th><th>Motif</th>
        <th>Renforts</th><th>Œî km</th><th>Heures par statut</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- R√©f√©rentiel CP -> Ville (rapide ; garde si pas d‚ÄôODWB complet) -->
<script type="application/json" id="postalData">
{
  "1000":"Bruxelles","1310":"La Hulpe","1300":"Wavre","1330":"Rixensart","1340":"Ottignies",
  "1050":"Ixelles","1180":"Uccle","4020":"Li√®ge","4000":"Li√®ge","5000":"Namur","7000":"Mons"
}
</script>

<script>
/* ================== Cl√©s de stockage ================== */
const DISPATCH_KEY="dispatch_parc_vehicules";
const MISSIONS_KEY="dispatch_missions";
const MISSIONS_ARCHIVE_KEY="dispatch_missions_archive";
const ADMIN_PASSWORD="Admin01";

/* ================== Etats ================== */
let dispatchData={}, missions={}, archive={};

/* ================== Status ================== */
const FLOW = ["D√©part","Sur place","En charge","Arriv√© h√¥pital","Retour dispo","Rentr√© base"];
const EXTRAS = ["D√©vi√©","Mise indispo","Annul√© par CU112","Retour au poste"];
const CLOSE_GUARDS = new Set(["D√©vi√©","Mise indispo","Retour au poste"]);

/* ================== Utils ================== */
function loadAll(){
  dispatchData=JSON.parse(localStorage.getItem(DISPATCH_KEY)||"{}");
  missions=JSON.parse(localStorage.getItem(MISSIONS_KEY)||"{}");
  archive=JSON.parse(localStorage.getItem(MISSIONS_ARCHIVE_KEY)||"{}");
}
function saveMissions(){ localStorage.setItem(MISSIONS_KEY, JSON.stringify(missions)); }
function saveArchive(){ localStorage.setItem(MISSIONS_ARCHIVE_KEY, JSON.stringify(archive)); }
function saveDispatch(){ localStorage.setItem(DISPATCH_KEY, JSON.stringify(dispatchData)); }
function now(){ return new Date(); }
function todayKey(){ const d=now(); const z=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function hhmm(d){ const z=n=>String(n).padStart(2,"0"); return `${z(d.getHours())}:${z(d.getMinutes())}`; }
function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ================== CP -> Ville ================== */
let CP_MAP = {};
(function initCP(){
  try{ CP_MAP = JSON.parse(document.getElementById('postalData').textContent||"{}"); }catch{ CP_MAP = {}; }
  document.getElementById('mCP').addEventListener('input', e=>{
    const cp = (e.target.value||"").trim();
    if (CP_MAP[cp]) document.getElementById('mLocalite').value = CP_MAP[cp];
  });
  ["pec_cp","dest_cp"].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.addEventListener('input', ev=>{
      const cp=(ev.target.value||"").trim();
      const outId = id==="pec_cp" ? "pec_ville" : "dest_ville";
      if(CP_MAP[cp]) document.getElementById(outId).value = CP_MAP[cp];
    });
  });
})();

/* ================== Km d√©part auto (plaque) ================== */
function getPlateByVeh(v){ return dispatchData?.[v]?.plaque || ""; }
function bestKmForPlate(plaque){
  let best = 0;
  if (!plaque) return best;
  const vehs = (dispatchData._settings?.vehs||[]).map(v=>v.id);
  vehs.forEach(id=>{
    const d=dispatchData[id]; if(d && d.plaque===plaque){
      const k=parseInt(d.km||"0",10); if(!isNaN(k) && k>best) best=k;
    }
  });
  Object.values(missions||{}).forEach(m=>{
    if(m && m.done && m.plaque===plaque){
      const k=parseInt(m.kmRet||m.kmret||"0",10); if(!isNaN(k) && k>best) best=k;
    }
  });
  Object.values(archive||{}).forEach(m=>{
    if(m && m.plaque===plaque){
      const k=parseInt(m.kmRet||m.kmret||"0",10); if(!isNaN(k) && k>best) best=k;
    }
  });
  return best;
}

/* ================== UI Nouvelle mission ================== */
function populateVeh(){
  const sel=document.getElementById('mVeh'); sel.innerHTML="<option value=''>‚Äî</option>";
  const settings = dispatchData._settings?.vehs || [];
  settings.forEach(v=>{ sel.insertAdjacentHTML("beforeend",`<option value="${esc(v.id)}">${esc(v.id)}</option>`); });
}
document.getElementById('mVeh').addEventListener('change', ()=>{
  const id = document.getElementById('mVeh').value;
  const d = dispatchData[id];
  const attr = d ? (d.attribution||"") : "";
  document.getElementById('mAttr').value = attr;
  const plate = getPlateByVeh(id);
  const best = bestKmForPlate(plate);
  document.getElementById('kmHint').textContent = plate ? `Km d√©part sugg√©r√© pour ${plate} : ${best}` : "";
});
document.getElementById('mType').addEventListener('change', ()=>{
  const is112 = document.getElementById('mType').value==="112";
  document.getElementById('zone112').style.display = is112? "block":"none";
  document.getElementById('pecField').style.display = (document.getElementById('mType').value==="TMS")? "block":"none";
});

/* ================== Renforts checkboxes -> objets d√©taill√©s ================== */
function readRenfortsForm(){
  const obj={};
  const setBlock=(key, checked, appelId, spId, comId)=>{
    const r={
      enabled: !!checked,
      appel: (document.getElementById(appelId)?.value||""),
      sur_place: (document.getElementById(spId)?.value||""),
      comment: (document.getElementById(comId)?.value||"").trim()
    };
    if(checked || r.appel || r.sur_place || r.comment) obj[key]=r;
  };
  setBlock("Pompiers", document.getElementById('rfPompiers').checked, 'rf_p_appel','rf_p_sp','rf_p_com');
  setBlock("RACS",     document.getElementById('rfRacs').checked,     'rf_r_appel','rf_r_sp','rf_r_com');
  setBlock("SMUR",     document.getElementById('rfSmur').checked,     'rf_s_appel','rf_s_sp','rf_s_com');
  setBlock("Ambu 112", document.getElementById('rfAmbu112').checked,  'rf_a_appel','rf_a_sp','rf_a_com');
  setBlock("Police",   document.getElementById('rfPolice').checked,   'rf_pol_appel','rf_pol_sp','rf_pol_com');
  return obj;
}

/* ================== Cr√©ation ================== */
function startMission(){
  const veh = document.getElementById('mVeh').value;
  if(!veh) return alert("Choisis un v√©hicule.");
  const attr = document.getElementById('mAttr').value || "";
  const type = document.getElementById('mType').value || "";
  const motif= document.getElementById('mMotif').value.trim();
  if(!motif) return alert("Motif requis.");

  const plaque = getPlateByVeh(veh);
  const kmStart = bestKmForPlate(plaque);

  // PEC (TMS)
  let pec = null;
  if(type==="TMS"){
    const pecType = document.querySelector('input[name="pecType"]:checked')?.value || 'dom';
    pec = (pecType==='dom')
      ? { type:'dom', rue:val('pec_rue'), num:val('pec_num'), cp:val('pec_cp'), ville:val('pec_ville') }
      : { type:'str', name:val('pec_hop_name'), addr:val('pec_hop_addr'), cp:val('pec_cp2'), ville:val('pec_ville2') };
  }

  // Destination (tous types)
  const destType = document.querySelector('input[name="destType"]:checked')?.value || 'dom';
  const destination = (destType==='dom')
    ? { type:'dom', rue:val('dest_rue'), num:val('dest_num'), cp:val('dest_cp'), ville:val('dest_ville') }
    : { type:'str', name:val('dest_hop_name'), addr:val('dest_hop_addr'), cp:val('dest_cp2'), ville:val('dest_ville2') };

  const renforts = readRenfortsForm();

  const mission = {
    id: String(Date.now()),
    day: todayKey(),
    veh, attr, type, motif,
    plaque,
    comment: document.getElementById('mComment').value.trim() || "",
    renforts,
    centrale: (document.getElementById('mCentrale').value||""),
    num112: (document.getElementById('mNum112').value||""),
    depart112: (document.getElementById('mDepart').value||""),
    adresse: {
      rue: val('mRue'), num: val('mNum'), cp: val('mCP'), ville: val('mLocalite')
    },
    pec,
    destination,
    statuts: { "D√©part": hhmm(now()) },
    kmDep: kmStart ? String(kmStart) : "",
    kmRet: "",
    done: false
  };
  missions[mission.id] = mission;

  // v√©hicule -> Sorti
  if(!dispatchData[veh]) dispatchData[veh]={};
  dispatchData[veh].statut = "Sorti";
  saveMissions(); saveDispatch();

  renderActive(); alert("Mission d√©marr√©e.");
}
function val(id){ return (document.getElementById(id)?.value||"").trim(); }

/* ================== Recherche h√¥pital (OSM Nominatim) ================== */
function attachHospitalSearch(searchId, listId, outNameId, outAddrId, outCPId, outVilleId){
  const NOM_URL="https://nominatim.openstreetmap.org/search";
  const input=document.getElementById(searchId), dlist=document.getElementById(listId);
  const outName=document.getElementById(outNameId), outAddr=document.getElementById(outAddrId);
  const outCP=outCPId?document.getElementById(outCPId):null;
  const outVille=outVilleId?document.getElementById(outVilleId):null;
  const mem=new Map();

  function fmt(r){
    const name=r.display_name?.split(",")[0]||r.name||"Structure";
    const a=r.address||{};
    const rue=[a.road,a.house_number].filter(Boolean).join(" ");
    const cp=a.postcode||"";
    const city=a.city||a.town||a.village||a.municipality||"";
    const line=[rue,cp,city].filter(Boolean).join(", ");
    return {name,line,cp,city};
  }
  const doSearch=async()=>{
    const q=input.value.trim();
    if(q.length<3){ dlist.innerHTML=""; return; }
    const key=q.toLowerCase();
    if(mem.has(key)){ render(mem.get(key)); return; }
    const url=`${NOM_URL}?format=jsonv2&addressdetails=1&countrycodes=be&limit=20&q=${encodeURIComponent(q+" hospital clinic clinique hopital centre hospitalier CHU UZ")}`;
    try{
      const res=await fetch(url,{cache:"no-store"});
      const arr=await res.json();
      const items=arr.map(r=>{const f=fmt(r);return {k:String(r.place_id),name:f.name,line:f.line,cp:f.cp,city:f.city};});
      mem.set(key,items); render(items);
    }catch{ dlist.innerHTML=""; }
  };
  const render=(items)=>{ dlist.innerHTML=items.map(it=>`<option value="${esc(it.name)} ‚Äî ${esc(it.line)}"></option>`).join(""); };
  const choose=()=>{
    const val=(input.value||"").trim().toLowerCase();
    let choice=null;
    for(const arr of mem.values()){
      const f=arr.find(it=>(`${it.name} ‚Äî ${it.line}`).toLowerCase()===val || it.name.toLowerCase()===val);
      if(f){ choice=f; break; }
    }
    outName.value = choice?choice.name:input.value;
    outAddr.value = choice?(choice.line||""):"";
    if(choice){
      if(outCP && choice.cp) outCP.value=choice.cp;
      if(outVille && choice.city) outVille.value=choice.city;
    }
  };
  input.addEventListener('input', ()=>{ clearTimeout(input._t); input._t=setTimeout(doSearch,300); });
  input.addEventListener('change', choose);
  input.addEventListener('blur', choose);
}
attachHospitalSearch('pec_hop_search','pecHopList','pec_hop_name','pec_hop_addr','pec_cp2','pec_ville2');
attachHospitalSearch('dest_hop_search','destHopList','dest_hop_name','dest_hop_addr','dest_cp2','dest_ville2');

/* ================== Toggles PEC / DEST ================== */
document.querySelectorAll('input[name="pecType"]').forEach(r=>{
  r.onchange=()=>{
    document.getElementById('pec_dom').style.display = (r.value==='dom')?'grid':'none';
    document.getElementById('pec_str').style.display = (r.value==='str')?'block':'none';
  };
});
document.querySelectorAll('input[name="destType"]').forEach(r=>{
  r.onchange=()=>{
    document.getElementById('dest_dom').style.display = (r.value==='dom')?'grid':'none';
    document.getElementById('dest_str').style.display = (r.value==='str')?'block':'none';
  };
});

/* ================== Rendu missions actives (EDITABLES) ================== */
function renderActive(){
  const box=document.getElementById('activeMissions'); box.innerHTML="";
  const actives = Object.entries(missions).filter(([,m])=>!m.done);
  if(!actives.length){ box.innerHTML = "<i>Aucune mission en cours</i>"; return; }

  actives.forEach(([id,m])=>{
    const div=document.createElement('div'); div.className="panel";
    const statusButtons = [...FLOW, ...EXTRAS].map(st=>{
      const active = Boolean(m.statuts && m.statuts[st]);
      return `<button ${active?'class="active"':''} onclick="setStatus('${id}','${st}')">${st}</button>`;
    }).join("");

    // petits helpers renforts
    const R=(s,k,def="")=>esc(m.renforts?.[s]?.[k]??def);
    const C=(s,k)=> (m.renforts?.[s]?.[k]??"")==="" ? "" : (m.renforts?.[s]?.[k]??"");

    const renfChk = (s)=> (m.renforts?.[s]?.enabled ? 'checked' : '');
    const setSel = (val, arr)=> arr.map(x=>`<option ${val===x?"selected":""}>${x}</option>`).join("");

    div.innerHTML = `
      <div class="row">
        <div><b>${esc(m.veh)}</b> ${m.attr?`<span class="badge">${esc(m.attr)}</span>`:""} ‚Äî 
          <select onchange="editField('${id}','type',this.value)">
            <option ${m.type===""?"selected":""} value="">‚Äî</option>
            <option ${m.type==="TMS"?"selected":""}>TMS</option>
            <option ${m.type==="112"?"selected":""}>112</option>
            <option ${m.type==="Pr√©vention"?"selected":""}>Pr√©vention</option>
            <option ${m.type==="Logistique"?"selected":""}>Logistique</option>
          </select>
        </div>
        <div style="text-align:right" class="small">Plaque: ${esc(m.plaque||getPlateByVeh(m.veh)||"‚Äî")}</div>
      </div>

      <label>Motif</label>
      <input value="${esc(m.motif||"")}" oninput="editField('${id}','motif',this.value)">

      <label>Commentaire mission</label>
      <textarea oninput="editField('${id}','comment',this.value)">${esc(m.comment||"")}</textarea>

      <fieldset>
        <legend>Adresse (lieu d‚Äôappel)</legend>
        <div class="grid">
          <div><label>Rue</label><input value="${esc(m.adresse?.rue||"")}" oninput="editAddr('${id}','rue',this.value)"></div>
          <div><label>Num√©ro / Bo√Æte</label><input value="${esc(m.adresse?.num||"")}" oninput="editAddr('${id}','num',this.value)"></div>
          <div><label>Code postal</label><input maxlength="4" value="${esc(m.adresse?.cp||"")}" oninput="editAddrCP('${id}',this.value)"></div>
          <div><label>Localit√©</label><input value="${esc(m.adresse?.ville||"")}" oninput="editAddr('${id}','ville',this.value)"></div>
        </div>
      </fieldset>

      ${m.type==="TMS" ? `
      <fieldset>
        <legend>PEC (TMS)</legend>
        <div class="renforts">
          <label><input type="radio" name="pec_${id}" value="dom" ${m.pec?.type!=='str'?'checked':''} onchange="togglePecType('${id}',this.value)"> Domicile</label>
          <label><input type="radio" name="pec_${id}" value="str" ${m.pec?.type==='str'?'checked':''} onchange="togglePecType('${id}',this.value)"> H√¥pital / MR(S)</label>
        </div>
        <div id="pec_dom_${id}" class="grid" style="margin-top:6px; ${m.pec?.type==='str'?'display:none':''}">
          <div><label>Rue</label><input value="${esc(m.pec?.rue||"")}" oninput="editPec('${id}','rue',this.value)"></div>
          <div><label>N¬∞</label><input value="${esc(m.pec?.num||"")}" oninput="editPec('${id}','num',this.value)"></div>
          <div><label>CP</label><input value="${esc(m.pec?.cp||"")}" maxlength="4" oninput="editPec('${id}','cp',this.value)"></div>
          <div><label>Localit√©</label><input value="${esc(m.pec?.ville||"")}" oninput="editPec('${id}','ville',this.value)"></div>
        </div>
        <div id="pec_str_${id}" style="margin-top:6px; ${m.pec?.type==='str'?'':'display:none'}">
          <div class="grid">
            <div><label>Nom</label><input value="${esc(m.pec?.name||"")}" oninput="editPec('${id}','name',this.value)"></div>
            <div><label>Adresse</label><input value="${esc(m.pec?.addr||"")}" oninput="editPec('${id}','addr',this.value)"></div>
            <div><label>CP</label><input value="${esc(m.pec?.cp||"")}" maxlength="4" oninput="editPec('${id}','cp',this.value)"></div>
            <div><label>Localit√©</label><input value="${esc(m.pec?.ville||"")}" oninput="editPec('${id}','ville',this.value)"></div>
          </div>
        </div>
      </fieldset>` : ``}

      <fieldset>
        <legend>Destination</legend>
        <div class="renforts">
          <label><input type="radio" name="dest_${id}" value="dom" ${m.destination?.type!=='str'?'checked':''} onchange="toggleDestType('${id}',this.value)"> Domicile</label>
          <label><input type="radio" name="dest_${id}" value="str" ${m.destination?.type==='str'?'checked':''} onchange="toggleDestType('${id}',this.value)"> H√¥pital / MR(S)</label>
        </div>
        <div id="dest_dom_${id}" class="grid" style="margin-top:6px; ${m.destination?.type==='str'?'display:none':''}">
          <div><label>Rue</label><input value="${esc(m.destination?.rue||"")}" oninput="editDest('${id}','rue',this.value)"></div>
          <div><label>N¬∞</label><input value="${esc(m.destination?.num||"")}" oninput="editDest('${id}','num',this.value)"></div>
          <div><label>CP</label><input value="${esc(m.destination?.cp||"")}" maxlength="4" oninput="editDest('${id}','cp',this.value)"></div>
          <div><label>Localit√©</label><input value="${esc(m.destination?.ville||"")}" oninput="editDest('${id}','ville',this.value)"></div>
        </div>
        <div id="dest_str_${id}" style="margin-top:6px; ${m.destination?.type==='str'?'':'display:none'}">
          <div class="grid">
            <div><label>Nom</label><input value="${esc(m.destination?.name||"")}" oninput="editDest('${id}','name',this.value)"></div>
            <div><label>Adresse</label><input value="${esc(m.destination?.addr||"")}" oninput="editDest('${id}','addr',this.value)"></div>
            <div><label>CP</label><input value="${esc(m.destination?.cp||"")}" maxlength="4" oninput="editDest('${id}','cp',this.value)"></div>
            <div><label>Localit√©</label><input value="${esc(m.destination?.ville||"")}" oninput="editDest('${id}','ville',this.value)"></div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Renforts (d√©taill√©s)</legend>
        <div class="subgrid">
          ${renderRenfortBlock(id,m,"Pompiers","p")}
          ${renderRenfortBlock(id,m,"RACS","r")}
          ${renderRenfortBlock(id,m,"SMUR","s")}
          ${renderRenfortBlock(id,m,"Ambu 112","a")}
          ${renderRenfortBlock(id,m,"Police","pol")}
        </div>
      </fieldset>

      ${m.type==="112" ? `
      <div id="blk112_${id}" style="margin-top:6px">
        <label>Centrale 112</label>
        <select onchange="editField('${id}','centrale',this.value)">
          ${["","Mons","Namur","Arlon","Li√®ge","Leuven","Bruxelles","Autres"].map(x=>`<option ${m.centrale===x?"selected":""} value="${x}">${x||"‚Äî"}</option>`).join("")}
        </select>
        <label>Num√©ro mission (4 derniers)</label>
        <input maxlength="4" value="${esc(m.num112||"")}" oninput="editField('${id}','num112',this.value)">
        <label>D√©part</label>
        <select onchange="editField('${id}','depart112',this.value)">
          ${["Normal","M√©dical"].map(x=>`<option ${m.depart112===x?"selected":""}>${x}</option>`).join("")}
        </select>
      </div>`:""}

      <div class="status-btns">${statusButtons}</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Kilom√©trage d√©part</label>
          <input type="number" id="kmdep_${id}" value="${esc(m.kmDep||"")}" oninput="updKm('${id}','dep',this.value)" placeholder="auto selon plaque">
        </div>
        <div>
          <label>Kilom√©trage retour</label>
          <input type="number" id="kmret_${id}" value="${esc(m.kmRet||"")}" oninput="updKm('${id}','ret',this.value)" placeholder="obligatoire avant cl√¥ture">
        </div>
      </div>

      <div style="text-align:right;margin-top:10px">
        <button class="secondary" onclick="closeMission('${id}')">Cl√¥turer mission</button>
      </div>
    `;
    box.appendChild(div);
  });
}

/* sous-rendu renforts */
function renderRenfortBlock(id,m,label,short){
  const r=m.renforts?.[label]||{};
  const chk = r.enabled ? "checked" : "";
  const appelOpts=["","Appel√©","Confirm√©","Refus√©","En route","Non dispo"].map(x=>`<option ${r.appel===x?"selected":""}>${x}</option>`).join("");
  const spOpts=["","Inconnu","Oui","Non"].map(x=>`<option ${r.sur_place===x?"selected":""}>${x}</option>`).join("");
  return `
  <div>
    <h4><label><input type="checkbox" ${chk} onchange="renfortToggle('${id}','${label}',this.checked)"> ${label}</label></h4>
    <label>Statut d‚Äôappel</label>
    <select onchange="renfortEdit('${id}','${label}','appel',this.value)">${appelOpts}</select>
    <label>Sur place</label>
    <select onchange="renfortEdit('${id}','${label}','sur_place',this.value)">${spOpts}</select>
    <label>Commentaire</label>
    <textarea oninput="renfortEdit('${id}','${label}','comment',this.value)">${esc(r.comment||"")}</textarea>
  </div>`;
}

/* Editions inline */
function editField(id,key,val){
  const m=missions[id]; if(!m) return;
  m[key]=val;
  if(key==="type"){
    // Affiche PEC si TMS
    setTimeout(()=>renderActive(),0);
  }
  saveMissions();
}
function editAddr(id,key,val){
  const m=missions[id]; if(!m) return;
  m.adresse = m.adresse||{}; m.adresse[key]=val;
  saveMissions();
}
function editAddrCP(id,val){
  const m=missions[id]; if(!m) return;
  m.adresse = m.adresse||{}; m.adresse.cp = val;
  if(CP_MAP[val]) m.adresse.ville = CP_MAP[val];
  saveMissions(); renderActive();
}
function updKm(id, which, val){
  const m=missions[id]; if(!m) return;
  if(which==="dep") m.kmDep = val;
  if(which==="ret") m.kmRet = val;
  saveMissions();
}

/* PEC / DEST edits */
function togglePecType(id,kind){
  const m=missions[id]; if(!m) return;
  m.pec = m.pec||{}; m.pec.type = kind;
  saveMissions(); renderActive();
}
function editPec(id,key,val){
  const m=missions[id]; if(!m) return;
  m.pec = m.pec||{type:'dom'}; m.pec[key]=val;
  saveMissions();
}
function toggleDestType(id,kind){
  const m=missions[id]; if(!m) return;
  m.destination = m.destination||{}; m.destination.type = kind;
  saveMissions(); renderActive();
}
function editDest(id,key,val){
  const m=missions[id]; if(!m) return;
  m.destination = m.destination||{type:'dom'}; m.destination[key]=val;
  saveMissions();
}

/* Renforts */
function renfortToggle(id,label,checked){
  const m=missions[id]; if(!m) return;
  m.renforts=m.renforts||{};
  m.renforts[label]=m.renforts[label]||{};
  m.renforts[label].enabled = !!checked;
  saveMissions(); renderActive();
}
function renfortEdit(id,label,key,val){
  const m=missions[id]; if(!m) return;
  m.renforts=m.renforts||{}; m.renforts[label]=m.renforts[label]||{};
  m.renforts[label][key]=val;
  // synchro rapide: si on met appel/sur place/comment, on consid√®re enabled
  if(key!=="comment" || val.trim()!=="") m.renforts[label].enabled = true;
  saveMissions();
}

/* ================== Actions de statut ================== */
function setStatus(id, st){
  const m = missions[id]; if(!m) return;
  if(!m.statuts) m.statuts = {};
  if(m.statuts[st]) return;
  m.statuts[st] = hhmm(now());

  if (st === "D√©vi√©"){
    const veh = m.veh;
    const plaque = m.plaque || getPlateByVeh(veh);
    const kmStart = bestKmForPlate(plaque);
    const newM = {
      id: String(Date.now()+1),
      day: todayKey(),
      veh, attr: (dispatchData[veh]?.attribution||m.attr||""),
      type: "", motif: "",
      plaque,
      comment:"",
      renforts: {},
      centrale: "", num112: "", depart112: "Normal",
      adresse: { rue:"", num:"", cp:"", ville:"" },
      destination: { type:'dom', rue:"", num:"", cp:"", ville:"" },
      statuts: { "D√©part": hhmm(now()) },
      kmDep: kmStart ? String(kmStart) : "",
      kmRet: "",
      done:false
    };
    missions[newM.id]=newM;
    dispatchData[veh] = dispatchData[veh]||{};
    dispatchData[veh].statut="Sorti";
    saveDispatch();
  }

  if (st === "Mise indispo"){
    const motif = prompt("Motif d'indisponibilit√© ?");
    if (motif===null){ delete m.statuts[st]; saveMissions(); renderActive(); return; }
    const v = m.veh;
    dispatchData[v] = dispatchData[v]||{};
    dispatchData[v].statut = "Indisponible";
    dispatchData[v].commentaire = motif.trim();
    saveDispatch();
  }

  if (st === "Annul√© par CU112" || st === "Retour au poste"){
    const v = m.veh;
    dispatchData[v] = dispatchData[v]||{};
    dispatchData[v].statut = "Disponible";
    saveDispatch();
  }

  saveMissions();
  renderActive();
}

/* ================== Cl√¥ture ================== */
function closeMission(id){
  const m = missions[id]; if(!m) return;
  const hasGuard = Object.keys(m.statuts||{}).some(s=>CLOSE_GUARDS.has(s));
  if(!hasGuard){
    alert("Impossible de cl√¥turer : activer l‚Äôun des statuts D√©vi√©, Mise indispo ou Retour au poste.");
    return;
  }
  const dep = parseInt(m.kmDep||"",10);
  const ret = parseInt(m.kmRet||"",10);
  if(!(dep>0 && ret>0)){
    alert("Impossible de cl√¥turer : indique les kilom√®tres d√©part et retour.");
    return;
  }
  m.diffKm = ret - dep;
  m.done = true;
  m.heures = { ...m.statuts };

  const v = m.veh;
  if(dispatchData[v]){
    dispatchData[v].km = String(ret);
    if (!m.statuts["Mise indispo"]) dispatchData[v].statut = "Disponible";
  }
  saveDispatch(); saveMissions();

  renderActive(); renderDone();
}

/* ================== Missions du jour ================== */
function formatRenforts(r){
  if(!r) return "‚Äî";
  const arr=[];
  for (const k of ["Pompiers","RACS","SMUR","Ambu 112","Police"]){
    if(r[k]?.enabled) arr.push(k);
  }
  return arr.length?arr.join(", "):"‚Äî";
}
function renderDone(){
  const tb = document.querySelector("#tableDone tbody");
  tb.innerHTML="";
  const today = todayKey();
  const done = Object.values(missions).filter(m=>m.done && m.day===today);
  done.sort((a,b)=> (b.statuts?.["D√©part"]||"") < (a.statuts?.["D√©part"]||"") ? -1 : 1);
  done.forEach(m=>{
    const heures = Object.entries(m.heures||{}).map(([k,v])=>`${esc(k)}: ${esc(v)}`).join("<br>");
    tb.insertAdjacentHTML("beforeend",`
      <tr>
        <td><input type="checkbox" class="selDone" data-id="${esc(m.id)}"></td>
        <td>${esc(m.veh)}</td>
        <td>${esc(m.attr||"‚Äî")}</td>
        <td>${esc(m.type||"‚Äî")}</td>
        <td>${esc(m.motif||"‚Äî")}${m.comment?`<br><span class="small">üí¨ ${esc(m.comment)}</span>`:""}</td>
        <td>${esc(formatRenforts(m.renforts))}</td>
        <td>${(m.diffKm??"")}</td>
        <td>${heures}</td>
      </tr>
    `);
  });
}

/* ================== Suppression/Archivage missions du jour ================== */
function deleteSelectedDone(){
  const pw = prompt("Mot de passe administrateur :");
  if (pw===null) return;
  if (pw !== ADMIN_PASSWORD){ alert("Mot de passe incorrect."); return; }
  const checks = Array.from(document.querySelectorAll(".selDone:checked"));
  if (!checks.length){ alert("S√©lectionne au moins une mission."); return; }
  let movedCount=0;
  checks.forEach(ch=>{
    const id = ch.dataset.id;
    const m = missions[id];
    if(!m) return;
    archive[id] = m;
    delete missions[id];
    movedCount++;
  });
  if (movedCount>0){ saveArchive(); saveMissions(); renderDone(); alert(`${movedCount} mission(s) d√©plac√©e(s) vers l‚Äôarchive.`); }
}

/* ================== Boot & Sync ================== */
window.onload=()=>{ loadAll(); populateVeh(); renderActive(); renderDone(); };
window.addEventListener("storage", e=>{
  if(e.key===DISPATCH_KEY){ dispatchData=JSON.parse(e.newValue||"{}"); populateVeh(); renderActive(); }
  if(e.key===MISSIONS_KEY){ missions=JSON.parse(e.newValue||"{}"); renderActive(); renderDone(); }
  if(e.key===MISSIONS_ARCHIVE_KEY){ archive=JSON.parse(e.newValue||"{}"); }
});
</script>
</body>
</html>
