<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Missions en cours</title>
<style>
:root{
  --bg:#0b0f14;--panel:#121821;--line:#223044;
  --text:#e8eef5;--muted:#93a7bf;--accent:#3a8bf2;--danger:#e74c3c;--ok:#27ae60;
}
html,body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Arial,sans-serif;}
h1{margin:16px;font-size:24px}
.toolbar{display:flex;gap:8px;margin:0 16px}
button{background:var(--accent);border:0;border-radius:8px;padding:8px 14px;color:#fff;cursor:pointer;font-weight:600}
button.secondary{background:#607d8b}
button.ghost{background:#0f1520;border:1px solid #2c3d52}
.panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;margin:16px;padding:16px}
label{display:block;font-size:12px;color:var(--muted);margin-top:8px}
input,select,textarea{width:100%;padding:6px;border-radius:6px;border:1px solid #2c3d52;background:#0f1520;color:#fff;box-sizing:border-box}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid var(--line);padding:6px;text-align:left;vertical-align:top}
th{background:#182030}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px}
fieldset{border:1px solid #2c3d52;border-radius:8px;margin-top:10px;padding:10px}
legend{color:var(--accent)}
.status-btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.status-btns button{flex:1;min-width:140px;background:#0f1520;border:1px solid #2c3d52}
.status-btns button.active{background:var(--accent)}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2c3d52;font-size:12px}
.row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media (max-width:900px){ .row{grid-template-columns:1fr} }
.small{font-size:12px;color:#cfe1ff}
.renforts{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}
.renforts label{margin:0;font-size:13px;color:#e8eef5;display:flex;gap:6px;align-items:center}
.thin{font-weight:400;opacity:.9}
</style>
</head>
<body>
<h1>Gestion des missions</h1>

<div class="toolbar">
  <button class="ghost" onclick="window.open('dispatch.html','_blank')">‚Ü©Ô∏è Retour dispatch</button>
  <button class="ghost" onclick="window.open('missions-passees.html','_blank')">üìö Missions pass√©es</button>
</div>

<div class="panel">
  <h2>Nouvelle mission</h2>
  <div class="grid">
    <div><label>V√©hicule</label><select id="mVeh"></select></div>
    <div><label>Attribution</label><input id="mAttr" readonly></div>
    <div>
      <label>Type</label>
      <select id="mType">
        <option value="">‚Äî</option><option>TMS</option><option>112</option><option>Pr√©vention</option><option>Logistique</option>
      </select>
    </div>
    <div id="zone112" style="display:none">
      <label>Centrale 112</label>
      <select id="mCentrale">
        <option value="">‚Äî</option><option>Mons</option><option>Namur</option><option>Arlon</option><option>Li√®ge</option><option>Leuven</option><option>Bruxelles</option><option>Autres</option>
      </select>
      <label>Num√©ro mission (4 derniers)</label>
      <input id="mNum112" maxlength="4" placeholder="xxxx">
      <label>D√©part</label>
      <select id="mDepart"><option>Normal</option><option>M√©dical</option></select>
    </div>
  </div>

  <label>Motif du transport</label>
  <input id="mMotif" placeholder="Ex: Malaise, dialyse, transfert‚Ä¶">

  <fieldset>
    <legend>Adresse</legend>
    <div class="grid">
      <div><label>Rue</label><input id="mRue"></div>
      <div><label>Num√©ro / Bo√Æte</label><input id="mNum"></div>
      <div><label>Code postal</label><input id="mCP" maxlength="4"></div>
      <div><label>Localit√©</label><input id="mLocalite" placeholder="Auto si CP connu"></div>
    </div>
  </fieldset>

  <div class="renforts">
    <span class="thin">Renforts :</span>
    <label><input type="checkbox" id="rfPompiers"> Pompiers</label>
    <label><input type="checkbox" id="rfPolice"> Police</label>
    <label><input type="checkbox" id="rfSmur"> SMUR</label>
  </div>

  <div class="small" id="kmHint" style="margin-top:6px;opacity:.9"></div>

  <div style="text-align:right;margin-top:10px">
    <button onclick="startMission()">D√©marrer la mission</button>
  </div>
</div>

<div class="panel">
  <h2>Missions en cours</h2>
  <div id="activeMissions"></div>
</div>

<div class="panel">
  <div class="row" style="align-items:center">
    <h2 style="margin:0">Missions du jour</h2>
    <div style="text-align:right">
      <button class="secondary" onclick="deleteSelectedDone()">üóë Supprimer la s√©lection (Admin)</button>
    </div>
  </div>
  <table id="tableDone">
    <thead>
      <tr>
        <th style="width:32px"></th>
        <th>V√©hicule</th><th>Attribution</th><th>Type</th><th>Motif</th>
        <th>Renforts</th><th>Œî km</th><th>Heures par statut</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- R√©f√©rentiel CP -> Ville (colle ici le JSON complet si tu l‚Äôas) -->
<script type="application/json" id="postalData">
{
  "1000":"Bruxelles","1310":"La Hulpe","1300":"Wavre","1330":"Rixensart","1340":"Ottignies",
  "1050":"Ixelles","1180":"Uccle","4020":"Li√®ge","4000":"Li√®ge","5000":"Namur","7000":"Mons"
}
</script>

<script>
/* ================== Cl√©s de stockage ================== */
const DISPATCH_KEY="dispatch_parc_vehicules";
const MISSIONS_KEY="dispatch_missions";
const MISSIONS_ARCHIVE_KEY="dispatch_missions_archive";
const ADMIN_PASSWORD="Admin01";

/* ================== Etats ================== */
let dispatchData={}, missions={}, archive={};

/* ================== Status ================== */
const FLOW = ["D√©part","Sur place","En charge","Arriv√© h√¥pital","Retour dispo","Rentr√© base"];
const EXTRAS = ["D√©vi√©","Mise indispo","Annul√© par CU112","Retour au poste"];
// Cl√¥ture: autoris√©e UNIQUEMENT si l‚Äôun de ces statuts est pr√©sent (Annul√© n‚Äôautorise PAS)
const CLOSE_GUARDS = new Set(["D√©vi√©","Mise indispo","Retour au poste"]);

/* ================== Utils ================== */
function loadAll(){
  dispatchData=JSON.parse(localStorage.getItem(DISPATCH_KEY)||"{}");
  missions=JSON.parse(localStorage.getItem(MISSIONS_KEY)||"{}");
  archive=JSON.parse(localStorage.getItem(MISSIONS_ARCHIVE_KEY)||"{}");
}
function saveMissions(){ localStorage.setItem(MISSIONS_KEY, JSON.stringify(missions)); }
function saveArchive(){ localStorage.setItem(MISSIONS_ARCHIVE_KEY, JSON.stringify(archive)); }
function saveDispatch(){ localStorage.setItem(DISPATCH_KEY, JSON.stringify(dispatchData)); }
function now(){ return new Date(); }
function todayKey(){ const d=now(); const z=n=>String(n).padStart(2,"0"); return `${d.getFullYear()}-${z(d.getMonth()+1)}-${z(d.getDate())}`; }
function hhmm(d){ const z=n=>String(n).padStart(2,"0"); return `${z(d.getHours())}:${z(d.getMinutes())}`; }
function esc(s){ return String(s??"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ================== CP -> Ville ================== */
let CP_MAP = {};
(function initCP(){
  try{ CP_MAP = JSON.parse(document.getElementById('postalData').textContent||"{}"); }catch{ CP_MAP = {}; }
  document.getElementById('mCP').addEventListener('input', e=>{
    const cp = (e.target.value||"").trim();
    if (CP_MAP[cp]) document.getElementById('mLocalite').value = CP_MAP[cp];
  });
})();

/* ================== Km d√©part auto (plaque) ================== */
function getPlateByVeh(v){ return dispatchData?.[v]?.plaque || ""; }

// Cherche le + grand km connu pour une plaque : dispatch + missions + archives
function bestKmForPlate(plaque){
  let best = 0;
  if (!plaque) return best;
  // dispatch
  const vehs = (dispatchData._settings?.vehs||[]).map(v=>v.id);
  vehs.forEach(id=>{
    const d=dispatchData[id]; if(d && d.plaque===plaque){
      const k=parseInt(d.km||"0",10); if(!isNaN(k) && k>best) best=k;
    }
  });
  // missions termin√©es (du store courant)
  Object.values(missions||{}).forEach(m=>{
    if(m && m.done && m.plaque===plaque){
      const k=parseInt(m.kmRet||m.kmret||"0",10); if(!isNaN(k) && k>best) best=k;
    }
  });
  // archives
  Object.values(archive||{}).forEach(m=>{
    if(m && m.plaque===plaque){
      const k=parseInt(m.kmRet||m.kmret||"0",10); if(!isNaN(k) && k>best) best=k;
    }
  });
  return best;
}

/* ================== UI Nouvelle mission ================== */
function populateVeh(){
  const sel=document.getElementById('mVeh'); sel.innerHTML="<option value=''>‚Äî</option>";
  const settings = dispatchData._settings?.vehs || [];
  settings.forEach(v=>{
    sel.insertAdjacentHTML("beforeend",`<option value="${esc(v.id)}">${esc(v.id)}</option>`);
  });
}
document.getElementById('mVeh').addEventListener('change', ()=>{
  const id = document.getElementById('mVeh').value;
  const d = dispatchData[id];
  const attr = d ? (d.attribution||"") : "";
  document.getElementById('mAttr').value = attr;

  // Km best pour la plaque
  const plate = getPlateByVeh(id);
  const best = bestKmForPlate(plate);
  document.getElementById('kmHint').textContent = plate ? `Km d√©part sugg√©r√© pour ${plate} : ${best}` : "";
});
document.getElementById('mType').addEventListener('change', ()=>{
  document.getElementById('zone112').style.display = (document.getElementById('mType').value==="112")? "block":"none";
});

/* ================== Cr√©ation ================== */
function startMission(){
  const veh = document.getElementById('mVeh').value;
  if(!veh) return alert("Choisis un v√©hicule.");
  const attr = document.getElementById('mAttr').value || "";
  const type = document.getElementById('mType').value || "";
  const motif= document.getElementById('mMotif').value.trim();
  if(!motif) return alert("Motif requis.");

  const plaque = getPlateByVeh(veh);
  const kmStart = bestKmForPlate(plaque); // km d√©part auto

  const renforts = {
    pompiers: document.getElementById('rfPompiers').checked,
    police: document.getElementById('rfPolice').checked,
    smur: document.getElementById('rfSmur').checked
  };

  const mission = {
    id: String(Date.now()),
    day: todayKey(),
    veh, attr, type, motif,
    plaque,
    renforts,
    centrale: (document.getElementById('mCentrale').value||""),
    num112: (document.getElementById('mNum112').value||""),
    depart112: (document.getElementById('mDepart').value||""),
    adresse: {
      rue: document.getElementById('mRue').value||"",
      num: document.getElementById('mNum').value||"",
      cp:  document.getElementById('mCP').value||"",
      ville: document.getElementById('mLocalite').value||""
    },
    statuts: { "D√©part": hhmm(now()) },   // D√©part fix√© √† la cr√©ation
    kmDep: kmStart ? String(kmStart) : "",
    kmRet: "",
    done: false
  };
  missions[mission.id] = mission;

  // v√©hicule -> Sorti
  if(!dispatchData[veh]) dispatchData[veh]={};
  dispatchData[veh].statut = "Sorti";
  saveMissions(); saveDispatch();

  renderActive(); alert("Mission d√©marr√©e.");
}

/* ================== Rendu missions actives (EDITABLES) ================== */
function renderActive(){
  const box=document.getElementById('activeMissions'); box.innerHTML="";
  const actives = Object.entries(missions).filter(([,m])=>!m.done);
  if(!actives.length){ box.innerHTML = "<i>Aucune mission en cours</i>"; return; }

  actives.forEach(([id,m])=>{
    const div=document.createElement('div'); div.className="panel";
    const statusButtons = [...FLOW, ...EXTRAS].map(st=>{
      const active = Boolean(m.statuts && m.statuts[st]);
      return `<button ${active?'class="active"':''} onclick="setStatus('${id}','${st}')">${st}</button>`;
    }).join("");
    const show112 = (m.type==="112");
    const renf = m.renforts||{pompiers:false,police:false,smur:false};

    div.innerHTML = `
      <div class="row">
        <div><b>${esc(m.veh)}</b> ${m.attr?`<span class="badge">${esc(m.attr)}</span>`:""} ‚Äî 
          <select onchange="editField('${id}','type',this.value)">
            <option ${m.type===""?"selected":""} value="">‚Äî</option>
            <option ${m.type==="TMS"?"selected":""}>TMS</option>
            <option ${m.type==="112"?"selected":""}>112</option>
            <option ${m.type==="Pr√©vention"?"selected":""}>Pr√©vention</option>
            <option ${m.type==="Logistique"?"selected":""}>Logistique</option>
          </select>
        </div>
        <div style="text-align:right" class="small">Plaque: ${esc(m.plaque||getPlateByVeh(m.veh)||"‚Äî")}</div>
      </div>

      <label>Motif</label>
      <input value="${esc(m.motif||"")}" oninput="editField('${id}','motif',this.value)">

      <fieldset>
        <legend>Adresse</legend>
        <div class="grid">
          <div><label>Rue</label><input value="${esc(m.adresse?.rue||"")}" oninput="editAddr('${id}','rue',this.value)"></div>
          <div><label>Num√©ro / Bo√Æte</label><input value="${esc(m.adresse?.num||"")}" oninput="editAddr('${id}','num',this.value)"></div>
          <div><label>Code postal</label><input maxlength="4" value="${esc(m.adresse?.cp||"")}" oninput="editAddrCP('${id}',this.value)"></div>
          <div><label>Localit√©</label><input value="${esc(m.adresse?.ville||"")}" oninput="editAddr('${id}','ville',this.value)"></div>
        </div>
      </fieldset>

      <div class="renforts">
        <span class="thin">Renforts :</span>
        <label><input type="checkbox" ${renf.pompiers?'checked':''} onchange="toggleRenfort('${id}','pompiers',this.checked)"> Pompiers</label>
        <label><input type="checkbox" ${renf.police?'checked':''} onchange="toggleRenfort('${id}','police',this.checked)"> Police</label>
        <label><input type="checkbox" ${renf.smur?'checked':''} onchange="toggleRenfort('${id}','smur',this.checked)"> SMUR</label>
      </div>

      <div id="blk112_${id}" style="${show112?'':'display:none'};margin-top:6px">
        <label>Centrale 112</label>
        <select onchange="editField('${id}','centrale',this.value)">
          ${["","Mons","Namur","Arlon","Li√®ge","Leuven","Bruxelles","Autres"].map(x=>`<option ${m.centrale===x?"selected":""} value="${x}">${x||"‚Äî"}</option>`).join("")}
        </select>
        <label>Num√©ro mission (4 derniers)</label>
        <input maxlength="4" value="${esc(m.num112||"")}" oninput="editField('${id}','num112',this.value)">
        <label>D√©part</label>
        <select onchange="editField('${id}','depart112',this.value)">
          ${["Normal","M√©dical"].map(x=>`<option ${m.depart112===x?"selected":""}>${x}</option>`).join("")}
        </select>
      </div>

      <div class="status-btns">${statusButtons}</div>

      <div class="row" style="margin-top:10px">
        <div>
          <label>Kilom√©trage d√©part</label>
          <input type="number" id="kmdep_${id}" value="${esc(m.kmDep||"")}" oninput="updKm('${id}','dep',this.value)" placeholder="auto selon plaque">
        </div>
        <div>
          <label>Kilom√©trage retour</label>
          <input type="number" id="kmret_${id}" value="${esc(m.kmRet||"")}" oninput="updKm('${id}','ret',this.value)" placeholder="obligatoire avant cl√¥ture">
        </div>
      </div>

      <div style="text-align:right;margin-top:10px">
        <button class="secondary" onclick="closeMission('${id}')">Cl√¥turer mission</button>
      </div>
    `;
    box.appendChild(div);
  });
}

/* Editions inline */
function editField(id,key,val){
  const m=missions[id]; if(!m) return;
  m[key]=val;
  if(key==="type"){
    const blk=document.getElementById('blk112_'+id);
    if(blk) blk.style.display = (val==="112")?"block":"none";
  }
  saveMissions();
}
function editAddr(id,key,val){
  const m=missions[id]; if(!m) return;
  m.adresse = m.adresse||{};
  m.adresse[key]=val;
  saveMissions();
}
function editAddrCP(id,val){
  const m=missions[id]; if(!m) return;
  m.adresse = m.adresse||{};
  m.adresse.cp = val;
  if(CP_MAP[val]) m.adresse.ville = CP_MAP[val];
  saveMissions();
  renderActive();
}
function toggleRenfort(id,key,checked){
  const m=missions[id]; if(!m) return;
  m.renforts=m.renforts||{pompiers:false,police:false,smur:false};
  m.renforts[key]=checked;
  saveMissions();
}

/* Km live */
function updKm(id, which, val){
  const m=missions[id]; if(!m) return;
  if(which==="dep") m.kmDep = val;
  if(which==="ret") m.kmRet = val;
  saveMissions();
}

/* ================== Actions de statut ================== */
function setStatus(id, st){
  const m = missions[id]; if(!m) return;
  if(!m.statuts) m.statuts = {};
  if(m.statuts[st]) return; // d√©j√† pos√©

  // Marque l'heure
  m.statuts[st] = hhmm(now());

  // Effets sp√©ciaux
  if (st === "D√©vi√©"){
    // M√™me ambulance, nouvelle mission √©ditable
    const veh = m.veh;
    const plaque = m.plaque || getPlateByVeh(veh);
    const kmStart = bestKmForPlate(plaque);
    const newM = {
      id: String(Date.now()+1),
      day: todayKey(),
      veh, attr: (dispatchData[veh]?.attribution||m.attr||""),
      type: "", motif: "",
      plaque,
      renforts: {pompiers:false,police:false,smur:false},
      centrale: "", num112: "", depart112: "Normal",
      adresse: { rue:"", num:"", cp:"", ville:"" },
      statuts: { "D√©part": hhmm(now()) },
      kmDep: kmStart ? String(kmStart) : "",
      kmRet: "",
      done:false
    };
    missions[newM.id]=newM;
    // s'assurer que le v√©hicule reste "Sorti"
    dispatchData[veh] = dispatchData[veh]||{};
    dispatchData[veh].statut="Sorti";
    saveDispatch();
  }

  if (st === "Mise indispo"){
    const motif = prompt("Motif d'indisponibilit√© ?");
    if (motif===null){ delete m.statuts[st]; saveMissions(); renderActive(); return; }
    const v = m.veh;
    dispatchData[v] = dispatchData[v]||{};
    dispatchData[v].statut = "Indisponible";
    dispatchData[v].commentaire = motif.trim();
    saveDispatch();
  }

  if (st === "Annul√© par CU112" || st === "Retour au poste"){
    const v = m.veh;
    dispatchData[v] = dispatchData[v]||{};
    dispatchData[v].statut = "Disponible";
    saveDispatch();
  }

  saveMissions();
  renderActive();
}

/* ================== Cl√¥ture ================== */
function closeMission(id){
  const m = missions[id]; if(!m) return;

  // Garde : statut autorisant la cl√¥ture (EXCLUT "Annul√© par CU112")
  const hasGuard = Object.keys(m.statuts||{}).some(s=>CLOSE_GUARDS.has(s));
  if(!hasGuard){
    alert("Impossible de cl√¥turer : activer l‚Äôun des statuts D√©vi√©, Mise indispo ou Retour au poste.");
    return;
  }
  // Garde : kms
  const dep = parseInt(m.kmDep||"",10);
  const ret = parseInt(m.kmRet||"",10);
  if(!(dep>0 && ret>0)){
    alert("Impossible de cl√¥turer : indique les kilom√®tres d√©part et retour.");
    return;
  }

  // Œî km & heures
  m.diffKm = ret - dep;
  m.done = true;
  m.heures = { ...m.statuts };

  // Dispatch : KM v√©hicule et dispo si pas indispo
  const v = m.veh;
  if(dispatchData[v]){
    dispatchData[v].km = String(ret);
    if (!m.statuts["Mise indispo"]) dispatchData[v].statut = "Disponible";
  }
  saveDispatch(); saveMissions();

  renderActive(); renderDone();
}

/* ================== Missions du jour ================== */
function formatRenforts(r){
  if(!r) return "‚Äî";
  const arr=[];
  if(r.pompiers) arr.push("Pompiers");
  if(r.police) arr.push("Police");
  if(r.smur) arr.push("SMUR");
  return arr.length?arr.join(", "):"‚Äî";
}

function renderDone(){
  const tb = document.querySelector("#tableDone tbody");
  tb.innerHTML="";
  const today = todayKey();
  const done = Object.values(missions).filter(m=>m.done && m.day===today);
  // ordre d√©croissant par heure "D√©part"
  done.sort((a,b)=> (b.statuts?.["D√©part"]||"") < (a.statuts?.["D√©part"]||"") ? -1 : 1);
  done.forEach(m=>{
    const heures = Object.entries(m.heures||{}).map(([k,v])=>`${esc(k)}: ${esc(v)}`).join("<br>");
    tb.insertAdjacentHTML("beforeend",`
      <tr>
        <td><input type="checkbox" class="selDone" data-id="${esc(m.id)}"></td>
        <td>${esc(m.veh)}</td>
        <td>${esc(m.attr||"‚Äî")}</td>
        <td>${esc(m.type||"‚Äî")}</td>
        <td>${esc(m.motif||"‚Äî")}</td>
        <td>${esc(formatRenforts(m.renforts))}</td>
        <td>${(m.diffKm??"")}</td>
        <td>${heures}</td>
      </tr>
    `);
  });
}

/* ================== Suppression/Archivage missions du jour ================== */
function deleteSelectedDone(){
  const pw = prompt("Mot de passe administrateur :");
  if (pw===null) return;
  if (pw !== ADMIN_PASSWORD){ alert("Mot de passe incorrect."); return; }

  const checks = Array.from(document.querySelectorAll(".selDone:checked"));
  if (!checks.length){ alert("S√©lectionne au moins une mission."); return; }

  let movedCount=0;
  checks.forEach(ch=>{
    const id = ch.dataset.id;
    const m = missions[id];
    if(!m) return;
    archive[id] = m;  // archive
    delete missions[id]; // retire du jour
    movedCount++;
  });
  if (movedCount>0){ saveArchive(); saveMissions(); renderDone(); alert(`${movedCount} mission(s) d√©plac√©e(s) vers l‚Äôarchive.`); }
}

/* ================== Boot & Sync ================== */
window.onload=()=>{ loadAll(); populateVeh(); renderActive(); renderDone(); };
window.addEventListener("storage", e=>{
  if(e.key===DISPATCH_KEY){ dispatchData=JSON.parse(e.newValue||"{}"); populateVeh(); renderActive(); }
  if(e.key===MISSIONS_KEY){ missions=JSON.parse(e.newValue||"{}"); renderActive(); renderDone(); }
  if(e.key===MISSIONS_ARCHIVE_KEY){ archive=JSON.parse(e.newValue||"{}"); }
});
</script>
</body>
</html>
