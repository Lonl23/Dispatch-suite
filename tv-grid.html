<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tableau de garde ‚Äì TV</title>
<style>
  :root {
    --bg:#0a0f16; --panel:#121821; --line:#1f2c3e; --text:#f1f5fa;
    --dispo:#1b5e20;   /* vert */
    --sorti:#1565c0;   /* bleu */
    --reserve:#f57c00; /* orange */
    --indispo:#b71c1c; /* rouge */
  }
  html, body {
    margin:0; padding:0; background:var(--bg); color:var(--text);
    font-family:Segoe UI, Inter, sans-serif; height:100vh; overflow:hidden;
  }
  .header {
    display:flex; justify-content:space-between; align-items:center;
    background:#111b2b; padding:10px 20px; border-bottom:2px solid var(--line);
  }
  .header h1 { font-size:26px; color:#cfe1ff; margin:0; }
  .header .right { display:flex; align-items:center; gap:20px; font-size:18px; }
  .meteo { font-size:18px; font-weight:600; }

  .roles {
    background:#121b2a; padding:8px 20px; border-bottom:2px solid var(--line);
    display:flex; flex-wrap:wrap; justify-content:center; gap:16px; text-align:center; font-size:16px;
  }
  .roles div {
    padding:6px 10px; border:1px solid var(--line);
    border-radius:8px; background:#1a2335; min-width:160px;
  }
  .roles span { display:block; color:#9bb5d3; font-size:13px; }

  .grid {
    display:grid; grid-template-columns:repeat(4,1fr);
    gap:10px; padding:10px 20px; height:calc(100vh - 210px); overflow:auto;
  }
  .col { background:#121b2a; border:1px solid var(--line); border-radius:8px; padding:8px; display:flex; flex-direction:column; }
  .col h2 {
    text-align:center; font-size:20px; margin:0 0 8px 0; color:#cfe1ff;
    border-bottom:2px solid var(--line); padding-bottom:6px;
  }

  .veh { border-radius:10px; padding:8px; margin-bottom:8px; text-align:center; color:#fff; }
  .veh h3 { margin:4px 0; font-size:18px; }
  .veh small { color:#e0e0e0; font-size:14px; }
  .veh .crew { font-size:14px; margin-top:4px; }
  .veh .km { font-size:14px; margin-top:4px; color:#e0e0e0; }
  .veh.dispo { background:var(--dispo); }
  .veh.sorti { background:var(--sorti); }
  .veh.reserve { background:var(--reserve); }
  .veh.indispo { background:var(--indispo); }

  /* Banni√®re fluide corrig√©e sans aucun saut */
  .banner{
    position:absolute; bottom:0; left:0; width:100%;
    height:44px; display:flex; align-items:center;
    background:#a00; color:#fff; border-top:2px solid #700;
    overflow:hidden; white-space:nowrap; font-size:22px; font-weight:600; padding:0 10px;
  }
  #marquee{
    display:inline-flex; flex-direction:row; will-change: transform;
    transform: translate3d(0,0,0);
  }
  #marquee .track{ flex:0 0 auto; padding-right:60px; }
</style>
</head>
<body>

<!-- Protection : n√©cessite une connexion -->
<script>
(function(){
  if(!localStorage.getItem("dispatch_idToken")){
    location.href="index.html";
  }
})();
</script>

<script src="store-bridge.js"></script>

<div class="header">
  <h1>Tableau de garde</h1>
  <div class="right">
    <div id="meteo" class="meteo">üå¶Ô∏è ‚Äî ¬∞C</div>
    <div id="datetime"></div>
  </div>
</div>

<div id="roles" class="roles">Chargement des r√¥les...</div>

<div class="grid">
  <div class="col"><h2>Sortis</h2><div id="sortis"></div></div>
  <div class="col"><h2>Disponibles</h2><div id="dispo"></div></div>
  <div class="col"><h2>R√©serve</h2><div id="reserve"></div></div>
  <div class="col"><h2>Indisponibles</h2><div id="indispo"></div></div>
</div>

<div class="banner">
  <div id="marquee"></div>
</div>

<script>
if(typeof readKey!=='function'){alert("store-bridge.js manquant");}

const STORAGE_KEY="dispatch_parc_vehicules";
let state={};

/* Tri par attribution */
const ORDER=["LH1","LH2","LH3","LH4","LH5","LH6","LH7","LH8","TMS","PREV","OFF"];
const rankMap=Object.fromEntries(ORDER.map((k,i)=>[k,i]));
function attribRank(str){ const k=(str||"").toUpperCase(); return k in rankMap?rankMap[k]:999; }
function sortVehs(vehs){
  return (vehs||[]).slice().sort((a,b)=>{
    const da=state[a.id]||{}, db=state[b.id]||{};
    const aKey=(da.attribution||a.attrib||"").toUpperCase();
    const bKey=(db.attribution||b.attrib||"").toUpperCase();
    const ra=attribRank(aKey), rb=attribRank(bKey);
    if(ra!==rb) return ra-rb;
    return (a.id||"").localeCompare(b.id||"");
  });
}

const roleMap={
  officier_semaine:"Officier de semaine",
  officier_garde:"Officier de garde",
  responsable_operations:"Resp. op√©rations",
  chef_groupe:"Chef de groupe",
  chef_poste:"Chef de poste",
  centraliste_1:"1er centraliste",
  centraliste_2:"2e centraliste"
};

/* Date + Heure */
function updateDate(){
  const d=new Date();
  const jours=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
  const mois=["janvier","f√©vrier","mars","avril","mai","juin","juillet","ao√ªt","septembre","octobre","novembre","d√©cembre"];
  document.getElementById("datetime").textContent=
    `${jours[d.getDay()]} ${d.getDate()} ${mois[d.getMonth()]} ${d.getFullYear()} ‚Äî ${d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
}
setInterval(updateDate,1000); updateDate();

/* M√©t√©o La Hulpe */
async function loadMeteo(){
  try{
    const res=await fetch("https://api.open-meteo.com/v1/forecast?latitude=50.73&longitude=4.48&current=temperature_2m,weather_code&timezone=Europe/Brussels");
    const js=await res.json();
    const temp=Math.round(js.current.temperature_2m);
    const code=js.current.weather_code;
    const map={0:"‚òÄÔ∏è",1:"üå§Ô∏è",2:"‚õÖ",3:"‚òÅÔ∏è",45:"üå´Ô∏è",48:"üå´Ô∏è",51:"üå¶Ô∏è",61:"üåßÔ∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",71:"üå®Ô∏è",95:"‚õàÔ∏è"};
    document.getElementById("meteo").textContent=`${map[code]||"‚òÅÔ∏è"} ${temp}¬∞C La Hulpe`;
  }catch(e){ console.log("Erreur m√©t√©o",e); }
}
loadMeteo(); setInterval(loadMeteo,600000);

/* Chargement principal */
async function refresh(){
  const d=await readKey(STORAGE_KEY)||{};
  state=d;
  renderRoles();
  renderColumns();
  updateBannerText(); // ne reconstruit l'animation que si le texte change
}

/* R√¥les */
function renderRoles(){
  const box=document.getElementById("roles");
  const r=state._roles||{};
  box.innerHTML=Object.entries(roleMap)
    .map(([k,label])=>`<div><span>${label}</span>${r[k]||"-"}</div>`).join("");
}

/* Colonnes (code couleur) */
function renderColumns(){
  ["sortis","dispo","reserve","indispo"].forEach(id=>document.getElementById(id).innerHTML="");
  const vehs=sortVehs(state._settings?.vehs||[]);
  vehs.forEach(v=>{
    const d=state[v.id]||{};
    let container, css="";
    if(d.statut==="Sorti"){container="sortis"; css="sorti";}
    else if(d.statut==="Disponible"){container="dispo"; css="dispo";}
    else if(d.statut==="R√©serve"){container="reserve"; css="reserve";}
    else if(d.statut==="Indisponible"){container="indispo"; css="indispo";}
    if(!container) return;
    const html=`
      <div class="veh ${css}">
        <h3>${d.name||v.id}</h3>
        <small>${(d.attribution||v.attrib)?`[${d.attribution||v.attrib}] `:""}${d.plaque||v.plaque||""}</small>
        <div class="crew">${d.XO||""} ${d.S?"/ "+d.S:""} ${d.PS?"/ "+d.PS:""}</div>
        <div class="km">${d.km?`${d.km} km`:""}</div>
      </div>`;
    document.getElementById(container).insertAdjacentHTML("beforeend",html);
  });
}

/* ===== BANNI√àRE ULTRA-FLUIDE (corrig√©e d√©finitivement) ===== */
let marqueeRAF=null, marqueeStart=0, marqueeWidth=0, marqueeSpeed=80;
let marqueeTextCache="", needMeasure=false, smoothOffset=0;

function buildBannerDOM(text){
  const m=document.getElementById("marquee");
  m.innerHTML="";
  const t1=document.createElement("span"); t1.className="track"; t1.textContent=text;
  const t2=document.createElement("span"); t2.className="track"; t2.textContent=text;
  m.appendChild(t1); m.appendChild(t2);
  needMeasure=true;
}

function updateBannerText(){
  const n=state._notes||{};
  const seg=[];
  if(n.materiel) seg.push(`‚ö†Ô∏è Mat√©riel : ${n.materiel}`);
  if(n.infos)    seg.push(`‚ÑπÔ∏è Infos : ${n.infos}`);
  (state._settings?.vehs||[]).forEach(v=>{
    const d=state[v.id];
    if(d?.statut==="Indisponible"){
      seg.push(`üöë ${d.name||v.id}${d.attribution?` [${d.attribution}]`:""} : ${d.commentaire||"Indispo"}`);
    }
  });
  const text=seg.length?seg.join("   ‚Ä¢   "):"Aucune information disponible actuellement.";

  if(text===marqueeTextCache) return; // pas de rebuild inutile (√©vite les ‚Äúsauts‚Äù)
  marqueeTextCache=text;
  buildBannerDOM(text);
  marqueeStart=performance.now();
  if(marqueeRAF) cancelAnimationFrame(marqueeRAF);
  marqueeRAF=requestAnimationFrame(marqueeTick);
}

function marqueeTick(now){
  if(needMeasure){
    const first=document.querySelector('#marquee .track');
    marqueeWidth=(first?first.scrollWidth:0)+60;
    if(marqueeWidth<10) marqueeWidth=1000;
    needMeasure=false;
    marqueeStart=performance.now();
    smoothOffset=0;
  }
  const m=document.getElementById("marquee");
  const elapsed=(now - marqueeStart)/1000; // sec
  const offset = (marqueeSpeed * elapsed) % marqueeWidth; // base
  // lissage sub-pixel pour supprimer tout snap visuel
  smoothOffset += (offset - smoothOffset) * 0.08;
  m.style.transform=`translate3d(${-smoothOffset}px,0,0)`;
  marqueeRAF=requestAnimationFrame(marqueeTick);
}

window.addEventListener('resize', ()=>{
  needMeasure=true;
  marqueeStart=performance.now();
});

/* Boucle auto */
refresh();
setInterval(refresh,5000);
</script>
</body>
</html>
