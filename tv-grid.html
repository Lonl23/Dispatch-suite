<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tableau de garde ‚Äì TV</title>
<style>
  :root{
    --bg:#0a0f16;--panel:#121821;--line:#1f2c3e;--text:#f1f5fa;
    --accent:#3a8bf2;--ok:#2e7d32;--warn:#f4b400;--bad:#e74c3c;
  }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font-family:Segoe UI,Inter,sans-serif;height:100vh;overflow:hidden}
  .header{display:flex;justify-content:space-between;align-items:center;
    background:#111b2b;padding:8px 20px;border-bottom:2px solid var(--line)}
  .header h1{font-size:28px;color:#cfe1ff;margin:0}
  .header .right{display:flex;align-items:center;gap:20px;font-size:18px}
  .meteo{font-size:18px;font-weight:600}
  .roles{background:#121b2a;padding:8px 20px;display:grid;
    grid-template-columns:repeat(3,1fr);gap:8px;text-align:center;font-size:17px}
  .roles div span{color:#9bb5d3;display:block;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
    gap:10px;padding:10px 20px;overflow:auto;height:calc(100vh - 210px);}
  .veh{background:#1a2436;border-radius:10px;padding:8px;border:1px solid var(--line);
    display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;}
  .veh h3{margin:6px 0 2px 0}
  .veh small{color:#9bb5d3;font-size:13px}
  .veh .stat{padding:4px 10px;border-radius:8px;font-weight:700;margin-top:4px;font-size:15px}
  .s-dispo{background:var(--ok)}
  .s-sorti{background:var(--accent)}
  .s-res{background:var(--warn);color:#000}
  .s-indispo{background:var(--bad)}
  /* Banni√®re d√©filement */
  .banner{position:absolute;bottom:0;left:0;width:100%;background:#a00;color:#fff;
    overflow:hidden;white-space:nowrap;font-size:22px;font-weight:600;padding:6px 0;}
  .banner span{display:inline-block;padding-right:50px;animation:scroll 40s linear infinite;}
  @keyframes scroll{
    0%{transform:translateX(0)}
    100%{transform:translateX(-50%)}
  }
</style>
</head>
<body>

<script src="store-bridge.js"></script>

<div class="header">
  <h1>Tableau de garde</h1>
  <div class="right">
    <div id="meteo" class="meteo">üå¶Ô∏è ‚Äî ¬∞C</div>
    <div id="datetime"></div>
  </div>
</div>

<div id="roles" class="roles">Chargement des r√¥les...</div>

<div id="grid" class="grid"></div>

<div class="banner"><span id="bannerText">Chargement des informations...</span></div>

<script>
if(typeof readKey!=='function'){alert("store-bridge.js manquant");}

const STORAGE_KEY="dispatch_parc_vehicules";
let state={};

const roleMap={
  officier_semaine:"Officier de semaine",
  officier_garde:"Officier de garde",
  responsable_operations:"Resp. op√©rations",
  chef_groupe:"Chef de groupe",
  chef_poste:"Chef de poste",
  centraliste_1:"1er centraliste",
  centraliste_2:"2e centraliste"
};

/* Mise √† jour heure/date */
function updateDate(){
  const d=new Date();
  const jours=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
  const mois=["janv.","f√©vr.","mars","avr.","mai","juin","juil.","ao√ªt","sept.","oct.","nov.","d√©c."];
  const txt=`${jours[d.getDay()]} ${d.getDate()} ${mois[d.getMonth()]} ${d.getFullYear()} ‚Äî ${d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
  document.getElementById("datetime").textContent=txt;
}
setInterval(updateDate,1000);updateDate();

/* M√©t√©o La Hulpe */
async function loadMeteo(){
  try{
    const res=await fetch("https://api.open-meteo.com/v1/forecast?latitude=50.73&longitude=4.48&current=temperature_2m,weather_code&timezone=Europe/Brussels");
    const js=await res.json();
    const temp=js.current.temperature_2m;
    const code=js.current.weather_code;
    const meteoMap={0:"‚òÄÔ∏è",1:"üå§Ô∏è",2:"‚õÖ",3:"‚òÅÔ∏è",45:"üå´Ô∏è",48:"üå´Ô∏è",51:"üå¶Ô∏è",61:"üåßÔ∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",71:"üå®Ô∏è",95:"‚õàÔ∏è"};
    document.getElementById("meteo").textContent=`${meteoMap[code]||"‚òÅÔ∏è"} ${temp}¬∞C La Hulpe`;
  }catch(e){console.log("M√©t√©o erreur",e);}
}
loadMeteo();setInterval(loadMeteo,600000);

/* Lecture Firebase + rendu */
async function refresh(){
  const d=await readKey(STORAGE_KEY)||{};
  state=d;
  renderRoles();
  renderVehs();
  renderBanner();
}

/* R√¥les */
function renderRoles(){
  const box=document.getElementById("roles");
  const r=state._roles||{};
  box.innerHTML=Object.entries(roleMap)
    .map(([k,label])=>`<div><span>${label}</span>${r[k]||"-"}</div>`).join("");
}

/* V√©hicules */
function renderVehs(){
  const box=document.getElementById("grid");
  const vehs=(state._settings?.vehs)||[];
  box.innerHTML=vehs.map(v=>{
    const d=state[v.id]||{};
    let c="s-dispo";
    if(d.statut==="Sorti")c="s-sorti";
    else if(d.statut==="R√©serve")c="s-res";
    else if(d.statut==="Indisponible")c="s-indispo";
    return `<div class="veh">
      <h3>${d.name||v.id}</h3>
      <small>${d.attribution?`[${d.attribution}] `:""}${d.plaque||""}</small>
      <div class="stat ${c}">${d.statut||"?"}</div>
      <div style="font-size:14px;margin-top:6px">${(d.XO||"")} ${d.S?`/ ${d.S}`:""} ${d.PS?`/ ${d.PS}`:""}</div>
    </div>`;
  }).join("");
}

/* Banni√®re fluide */
function renderBanner(){
  const n=state._notes||{};
  let t="";
  if(n.materiel) t+="‚ö†Ô∏è Mat√©riel : "+n.materiel+"‚ÄÉ‚ÄÉ";
  if(n.infos) t+="‚ÑπÔ∏è Infos : "+n.infos+"‚ÄÉ‚ÄÉ";
  (state._settings?.vehs||[]).forEach(v=>{
    const d=state[v.id];
    if(d?.statut==="Indisponible"){
      t+=`üöë ${d.name||v.id}${d.attribution?` [${d.attribution}]`:""} : ${d.commentaire||"Indispo"}‚ÄÉ‚ÄÉ`;
    }
  });
  if(!t) t="Aucune information disponible actuellement.";
  // doubler le texte pour continuit√© sans vide
  document.getElementById("bannerText").innerHTML=(t+"‚ÄÉ‚ÄÉ"+t);
}

/* Boucles */
refresh();
setInterval(refresh,5000);
</script>
</body>
</html>
