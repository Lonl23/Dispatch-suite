<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tableau de garde – TV</title>
<style>
  :root{
    --bg:#0a0f16; --panel:#121821; --line:#1f2c3e;
    --text:#f1f5fa; --muted:#9bb5d3;
    --ok-bg:#15351c;      /* vert foncé bloc entier = Disponible */
    --ok-bd:#2e7d32;
    --bad-bg:#3a1212;     /* rouge foncé bloc entier = Indisponible */
    --bad-bd:#e74c3c;
    --ticker-bg:#a00020; --ticker-fg:#fff;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font-family:Segoe UI,Inter,system-ui,sans-serif;overflow:hidden}

  /* Header compact */
  .header{display:flex;justify-content:space-between;align-items:center;
    padding:8px 16px;background:#0d1523;border-bottom:2px solid var(--line)}
  .header h1{margin:0;font-size:24px;color:#cfe1ff}
  .head-right{display:flex;gap:12px;align-items:center}
  .pill{background:#0f1624;border:1px solid #223146;border-radius:999px;
    padding:4px 10px;font-weight:600;font-size:14px}

  /* Roles bandeau compact */
  .roles{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;
    padding:6px 10px;background:#101a2a;border-bottom:1px solid #223146}
  .role{background:#142035;border:1px solid #223146;border-radius:8px;
    padding:4px 8px;min-width:140px;text-align:center;font-size:14px}
  .role span{display:block;color:#9bb5d3;font-size:11px}

  /* Split principal */
  .main{display:grid;grid-template-columns:1fr 1fr;gap:10px;
    height:calc(100vh - 140px);padding:10px;box-sizing:border-box;overflow:hidden}
  .leftPane,.rightPane{background:#0f1624;border:1px solid #223146;border-radius:12px;
    padding:8px;overflow:auto}

  /* Hall compact */
  .section-title{margin:0 0 6px 0;color:#cfe1ff;font-size:16px;text-align:center}
  .hall-frame{border:2px solid #33465f;border-radius:10px;padding:10px}
  .ext-row{display:flex;justify-content:center;margin-bottom:12px}
  .slot.ext{width:92%}

  .hall-grid{display:grid;grid-template-columns:1fr 1fr;column-gap:16px;row-gap:14px}
  .stack{display:flex;flex-direction:column;gap:14px}

  .slot{
    background:#121e31;border:2px solid #425672;border-radius:10px;
    padding:8px 10px;min-height:88px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center
  }
  /* cacher les libellés d’emplacement */
  .slot .code{display:none}
  .slot .veh{font-size:16px;font-weight:800}
  .slot .sub{font-size:12px;color:#b8c9e0;margin-top:2px}
  /* Couleur bloc ENTIER (pas de bord uniquement) */
  .slot.ok{ background:var(--ok-bg); border-color:var(--ok-bd); }
  .slot.bad{ background:var(--bad-bg); border-color:var(--bad-bd); }

  /* Colonnes (pas d’emplacement affiché) */
  .cols{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .col{background:#121b2a;border:1px solid #223146;border-radius:10px;display:flex;flex-direction:column;min-height:120px}
  .col h3{margin:0;padding:6px;text-align:center;border-bottom:1px solid #223146;color:#cfe1ff;font-size:15px}
  .list{padding:6px;display:flex;flex-direction:column;gap:6px}
  .vehCard{background:#1a2436;border:1px solid #2b3a51;border-radius:8px;padding:6px;text-align:center}
  .vehCard .name{font-weight:800}
  .vehCard .line{font-size:12px;color:#9bb5d3}

  /* Bannière */
  .banner{position:absolute;left:0;right:0;bottom:0;height:40px;background:var(--ticker-bg);
    color:var(--ticker-fg);display:flex;align-items:center;overflow:hidden;border-top:1px solid #7a0016}
  .track{display:flex;gap:48px;white-space:nowrap;will-change:transform}
  .scroll{animation:marq 45s linear infinite}
  @keyframes marq{from{transform:translateX(0)}to{transform:translateX(-50%)}}
  .chunk{display:flex;align-items:center;gap:10px}
  .tag{background:#7a0016;border:1px solid #ffb3c1;border-radius:6px;padding:2px 8px;font-weight:800}
</style>
</head>
<body>

<script src="store-bridge.js"></script>

<div class="header">
  <h1>Tableau de garde</h1>
  <div class="head-right">
    <div id="meteo" class="pill">🌦 — °C</div>
    <div id="datetime" class="pill">--:--</div>
  </div>
</div>

<div id="roles" class="roles">Chargement des rôles…</div>

<div class="main">
  <!-- GAUCHE : HALL DES DÉPARTS -->
  <div class="leftPane">
    <h2 class="section-title">Hall des départs</h2>
    <div class="hall-frame">
      <div class="ext-row">
        <div class="slot ext" id="slot-EXT">
          <div class="code">Extérieur</div>
          <div class="veh" style="opacity:.6">—</div>
        </div>
      </div>

      <div class="hall-grid">
        <!-- Colonne gauche : H6→H10 -->
        <div class="stack">
          <div class="slot" id="slot-H6"><div class="code">H6</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
          <div class="slot" id="slot-H7"><div class="code">H7</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
          <div class="slot" id="slot-H8"><div class="code">H8</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
          <div class="slot" id="slot-H9"><div class="code">H9</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
          <div class="slot" id="slot-H10"><div class="code">H10</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
        </div>
        <!-- Colonne droite : H5→H1 -->
        <div class="stack">
          <div class="slot" id="slot-H5"><div class="code">H5</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
          <div class="slot" id="slot-H4"><div class="code">H4</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
          <div class="slot" id="slot-H3"><div class="code">H3</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
          <div class="slot" id="slot-H2"><div class="code">H2</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
          <div class="slot" id="slot-H1"><div class="code">H1</div><div class="veh" style="opacity:.6">—</div><div class="sub"></div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- DROITE : COLONNES STATUTS (pas d’emplacements) -->
  <div class="rightPane">
    <div class="cols">
      <div class="col"><h3>Sortis</h3><div id="col-sortis" class="list"></div></div>
      <div class="col"><h3>Disponibles</h3><div id="col-dispo" class="list"></div></div>
      <div class="col"><h3>Réserve</h3><div id="col-reserve" class="list"></div></div>
      <div class="col"><h3>Indisponibles</h3><div id="col-indispo" class="list"></div></div>
    </div>
  </div>
</div>

<!-- Bannière -->
<div class="banner">
  <div class="track">
    <div id="band1" class="scroll"></div>
    <div id="band2" class="scroll" aria-hidden="true"></div>
  </div>
</div>

<script>
if(typeof readKey!=='function'){ alert("store-bridge.js manquant"); }

const KEY="dispatch_parc_vehicules";
let data={};

const $ = s => document.querySelector(s);
const esc = s => String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* date + heure */
function tick(){
  const d=new Date();
  const jours=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
  const mois=["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"];
  $('#datetime').textContent=
    `${jours[d.getDay()]} ${String(d.getDate()).padStart(2,'0')} ${mois[d.getMonth()]} ${d.getFullYear()} — `+
    d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'});
}
setInterval(tick,1000); tick();

/* météo La Hulpe */
async function meteo(){
  try{
    const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=50.73&longitude=4.48&current=temperature_2m,weather_code&timezone=Europe/Brussels",{cache:"no-store"});
    const j=await r.json(); const t=j.current?.temperature_2m; const c=j.current?.weather_code;
    const map={0:"☀️",1:"🌤️",2:"⛅",3:"☁️",45:"🌫️",48:"🌫️",51:"🌦️",53:"🌦️",61:"🌧️",63:"🌧️",65:"🌧️",71:"❄️",95:"⛈️"};
    $('#meteo').textContent=`${map[c]||"🌤️"} ${t}°C La Hulpe`;
  }catch{}
}
meteo(); setInterval(meteo, 10*60*1000);

/* rôles */
const roleLabels={
  officier_semaine:"Officier de semaine",
  officier_garde:"Officier de garde",
  responsable_operations:"Resp. opérations",
  chef_groupe:"Chef de groupe",
  chef_poste:"Chef de poste",
  centraliste_1:"1er centraliste",
  centraliste_2:"2e centraliste"
};
function renderRoles(){
  const r=data._roles||{};
  $('#roles').innerHTML = Object.entries(roleLabels)
    .map(([k,l])=>`<div class="role"><span>${l}</span>${esc(r[k]||"-")}</div>`).join("");
}

/* Hall — couleur bloc ENTIER: Dispo/Indispo seulement */
function slotClassForStatus(s){
  if(s==="Disponible") return "ok";
  if(s==="Indisponible") return "bad";
  return ""; // Sorti & Réserve : neutre
}
const H_SLOTS=["H6","H7","H8","H9","H10","H5","H4","H3","H2","H1"];
function clearHall(){
  const ext=$("#slot-EXT");
  ext.classList.remove("ok","bad");
  ext.querySelector('.veh').textContent="—";
  ext.querySelector('.sub').textContent="";
  H_SLOTS.forEach(h=>{
    const el=$(`#slot-${h}`);
    el.classList.remove("ok","bad");
    el.querySelector('.veh').textContent="—";
    const sub=el.querySelector('.sub'); if(sub) sub.textContent="";
  });
}
function renderHall(){
  clearHall();
  const list=(data._settings?.vehs)||[];
  list.forEach(v=>{
    const d=data[v.id]||{};
    const emp=(v.emplacement||"").trim();
    const target = /ext/i.test(emp) ? "#slot-EXT" : `#slot-${emp}`;
    const box=$(target);
    if(!box) return;
    const cl=slotClassForStatus(d.statut||"");
    box.classList.remove("ok","bad");
    if(cl) box.classList.add(cl);
    box.querySelector('.veh').textContent = (d.name||v.id);
    const sub = box.querySelector('.sub');
    if(sub) sub.textContent = `${d.attribution?`[${d.attribution}] `:""}${d.plaque||""}`;
  });
}

/* Colonnes à droite (sans emplacements) */
function renderCols(){
  $("#col-sortis").innerHTML="";
  $("#col-dispo").innerHTML="";
  $("#col-reserve").innerHTML="";
  $("#col-indispo").innerHTML="";
  const vehs=(data._settings?.vehs)||[];
  vehs.forEach(v=>{
    const d=data[v.id]||{};
    let colId=null;
    if(d.statut==="Sorti") colId="col-sortis";
    else if(d.statut==="Disponible") colId="col-dispo";
    else if(d.statut==="Réserve") colId="col-reserve";
    else if(d.statut==="Indisponible") colId="col-indispo";
    if(!colId) return;
    const html=`
      <div class="vehCard">
        <div class="name">${esc(d.name||v.id)}</div>
        <div class="line">${d.attribution?`[${esc(d.attribution)}] `:""}${esc(d.plaque||"")}</div>
      </div>`;
    $(`#${colId}`).insertAdjacentHTML('beforeend',html);
  });
}

/* Bannière fluide */
function buildBanner(){
  const notes=data._notes||{};
  const outs=[];
  (data._settings?.vehs||[]).forEach(v=>{
    const d=data[v.id]; if(d?.statut==="Indisponible"){
      let t= (d.name||v.id);
      if(d.attribution) t+=` [${d.attribution}]`;
      if(d.commentaire) t+=` — ${d.commentaire}`;
      outs.push(t);
    }
  });
  const chunks=[];
  if(outs.length) chunks.push(`<span class="tag">VÉHICULE OUT</span><span>${esc(outs.join("  •  "))}</span>`);
  if((notes.materiel||"").trim()) chunks.push(`<span class="tag">MATÉRIEL</span><span>${esc(notes.materiel.replace(/\s+/g,' ').trim())}</span>`);
  if((notes.infos||"").trim())    chunks.push(`<span class="tag">INFOS</span><span>${esc(notes.infos.replace(/\s+/g,' ').trim())}</span>`);
  const content = chunks.length ? chunks.map(c=>`<span class="chunk">${c}</span>`).join('<span class="chunk">|</span>') : `<span class="chunk">Aucune information</span>`;
  const doubled = content + content;
  document.getElementById('band1').innerHTML=doubled;
  document.getElementById('band2').innerHTML=doubled;
}

/* Refresh */
async function refresh(){
  try{
    data = await readKey(KEY) || {};
    renderRoles();
    renderHall();
    renderCols();
    buildBanner();
  }catch(e){ console.error(e); }
}
refresh(); setInterval(refresh, 5000);
window.addEventListener('storage', e=>{ if(e.key===KEY) refresh(); });
</script>
</body>
</html>
