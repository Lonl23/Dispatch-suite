<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Tableau de garde ‚Äî TV</title>
<style>
  :root{
    --bg:#0a0f16; --panel:#111826; --line:#1e2a3d;
    --text:#eaf1fb; --muted:#9bb2cd; --accent:#3a8bf2;
    --ok:#1b5e20; --ok-fg:#c8facc;
    --busy:#0d47a1; --busy-fg:#d7e9ff; /* mission active */
    --bad:#7f1d1d; --bad-fg:#ffd6d6;   /* indisponible */
    --empty:#2a3446; --empty-fg:#cbd5e1; /* emplacement vide */
    --ticker-bg:#a40000; --ticker-fg:#fff;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Inter,Segoe UI,Arial,sans-serif;overflow:hidden}

  /* Header */
  .header{display:flex;align-items:center;justify-content:space-between;padding:10px 18px;background:#0e1522;border-bottom:1px solid var(--line)}
  .title{font-size:26px;font-weight:800;color:#cfe1ff}
  .meta{display:flex;gap:14px;align-items:center}
  .pill{background:#0f1520;border:1px solid #2b3a50;border-radius:999px;padding:6px 12px;color:#d9e7ff;font-weight:600}

  /* Roles */
  .roles{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;padding:8px 12px;background:#0f1626;border-bottom:1px solid var(--line)}
  .role{background:#0f1520;border:1px solid #2b3a50;border-radius:10px;padding:6px 10px;min-width:160px;text-align:center}
  .role span{display:block;color:#9bb2cd;font-size:12px}

  /* Main grids container */
  .main{display:grid;grid-template-columns:1fr 1fr;gap:14px;padding:12px;height:calc(100vh - 48px - 44px - 48px); /* header + roles + ticker */}
  @media (max-width:1400px){ .main{grid-template-columns:1fr} }

  /* Hall des d√©parts */
  .section{background:var(--panel);border:1px solid var(--line);border-radius:14px;display:flex;flex-direction:column;min-height:0}
  .section h2{margin:0;padding:10px 12px;border-bottom:1px solid var(--line);font-size:18px;color:#cfe1ff}
  .hall{display:grid;grid-template-columns:repeat(6, 1fr);gap:8px;padding:10px;overflow:auto}
  @media (max-width:1400px){ .hall{grid-template-columns:repeat(4,1fr);} }

  /* Garage */
  .garage{display:grid;grid-template-columns:repeat(4,1fr);grid-auto-rows:1fr;gap:8px;padding:10px;overflow:auto}
  /* Approche ‚Äúplan‚Äù : on ajuste les hauteurs pour verticaux/horizontaux */
  .spot{border-radius:12px;border:1px solid #2a3a56;padding:8px;display:flex;flex-direction:column;justify-content:center}
  .spot.vertical{grid-row:span 2;}   /* G1, G6, G7, G8 */
  .spot.horizontal{grid-column:span 1;} /* G2‚ÄìG5 */
  .label{font-size:11px;color:#9bb2cd;margin-bottom:4px}

  /* Vehicle card inside a spot */
  .veh{
    border-radius:10px;padding:8px;
    display:flex;flex-direction:column;gap:3px;
    min-height:72px;
  }
  .veh .l1{font-weight:800}
  .veh .l2,.veh .l3{font-size:13px;color:#e7eefc}
  .empty{background:var(--empty);color:var(--empty-fg);text-align:center}
  .ok{background:var(--ok);color:var(--ok-fg)}
  .busy{background:var(--busy);color:var(--busy-fg)}
  .bad{background:var(--bad);color:var(--bad-fg)}

  /* Banner */
  .ticker{height:48px;background:var(--ticker-bg);color:var(--ticker-fg);display:flex;align-items:center;overflow:hidden;border-top:1px solid #7a0016}
  .marquee{white-space:nowrap;display:flex;gap:64px}
  .scroll{display:inline-block;will-change:transform}
  .scroll .chunk{display:inline-flex;gap:12px;align-items:center;margin-right:64px}
  .tag{background:#7a0016;border:1px solid #ffccd5;padding:2px 8px;border-radius:6px;font-weight:700}

  /* Smooth infinite loop: two identical tracks */
  @keyframes loop {
    from { transform: translateX(0); }
    to { transform: translateX(-50%); }
  }
  .track{
    display:inline-block;
    animation: loop 60s linear infinite;
  }
  .marquee:hover .track{ animation-play-state: paused; }
</style>
</head>
<body>

<!-- Firebase bridge -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="store-bridge.js"></script>

<div class="header">
  <div class="title">Tableau de garde</div>
  <div class="meta">
    <div class="pill" id="meteo">‚Äî</div>
    <div class="pill" id="clock">--:--</div>
  </div>
</div>

<div id="roles" class="roles">Chargement des r√¥les‚Ä¶</div>

<div class="main">
  <div class="section">
    <h2>Hall des d√©parts</h2>
    <div id="hall" class="hall"></div>
  </div>

  <div class="section">
    <h2>Garage</h2>
    <div id="garage" class="garage"></div>
  </div>
</div>

<div class="ticker">
  <div class="marquee">
    <div id="band1" class="track"></div>
    <div id="band2" class="track" aria-hidden="true"></div>
  </div>
</div>

<script>
/* ====== Keys ====== */
const DISPATCH_KEY = "dispatch_parc_vehicules";
const MISSIONS_KEY = "missions_actives";

/* ====== State ====== */
let dispatchData = {};
let vehList = [];            // _settings.vehs
let missionsByVeh = {};      // veh -> mission active payload(s)
let bannerText = "";

/* ====== Slots ====== */
const HALL_SLOTS = ["H1","H2","H3","H4","H5","H6","H7","H8","H9","H10","Ext√©rieur"];
const GARAGE_SLOTS = ["G1","G2","G3","G4","G5","G6","G7","G8"]; // supporte G1..G8

/* ====== UI helpers ====== */
const esc = s => String(s??"").replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
function z2(n){ return String(n).padStart(2,'0'); }

/* Header: clock + meteo */
function tickClock(){
  const d=new Date();
  const jours=["Dim","Lun","Mar","Mer","Jeu","Ven","Sam"];
  const mois=["janv","f√©vr","mars","avr","mai","juin","juil","ao√ªt","sept","oct","nov","d√©c"];
  document.getElementById("clock").textContent =
    `${jours[d.getDay()]} ${z2(d.getDate())} ${mois[d.getMonth()]} ${d.getFullYear()} ‚Äî ${z2(d.getHours())}:${z2(d.getMinutes())}`;
}
setInterval(tickClock, 1000); tickClock();
async function loadMeteo(){
  try{
    const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=50.73&longitude=4.48&current=temperature_2m,weather_code&timezone=Europe/Brussels");
    const j=await r.json();
    const t=j.current.temperature_2m, c=j.current.weather_code;
    const ico = ({0:"‚òÄÔ∏è",1:"üå§Ô∏è",2:"‚õÖ",3:"‚òÅÔ∏è",45:"üå´Ô∏è",48:"üå´Ô∏è",51:"üå¶Ô∏è",61:"üåßÔ∏è",63:"üåßÔ∏è",65:"üåßÔ∏è",71:"üå®Ô∏è",95:"‚õàÔ∏è"})[c]||"‚òÅÔ∏è";
    document.getElementById("meteo").textContent = `${ico} ${t}¬∞C La Hulpe`;
  }catch(e){ console.warn("M√©t√©o fail",e); }
}
loadMeteo(); setInterval(loadMeteo, 10*60*1000);

/* ====== Data to UI ====== */

/* Build index: emplacement => vehId */
function buildSlotMap(){
  const map = {};
  (vehList||[]).forEach(v=>{
    const id = v.id;
    const live = dispatchData[id]||{};
    const slot = v.emplacement || live.emplacement || "";
    if(slot) map[slot] = id;
  });
  return map;
}

/* Mission-aware color */
function colorClassForVeh(id){
  // Mission active ?
  if (missionsByVeh[id]) return "busy";
  // Indisponible ?
  const st = (dispatchData[id]?.statut)||"";
  if (st==="Indisponible") return "bad";
  // sinon disponible (ou autre) => vert
  return "ok";
}

/* Render a vehicle block for a spot */
function vehBlock(id){
  if(!id) return `<div class="veh empty"><div>(vide)</div></div>`;
  const def = (vehList||[]).find(v=>v.id===id) || {};
  const live = dispatchData[id] || {};
  const name = def.name || id;
  const attr = live.attribution || def.attribution || "";
  const plaque = def.plaque || "";
  const l1 = `${name}${attr?` (${esc(attr)})`:""}${plaque?` ‚Äî ${esc(plaque)}`:""}`;
  const crew = [live.XO, live.S, live.PS].filter(Boolean).join(" / ") || "‚Äî";
  const km = live.km ? `${esc(live.km)} km` : "‚Äî";
  const cls = colorClassForVeh(id);
  return `
    <div class="veh ${cls}">
      <div class="l1">${esc(l1)}</div>
      <div class="l2">${esc(crew)}</div>
      <div class="l3">${esc(km)}</div>
    </div>`;
}

/* Render hall */
function renderHall(){
  const slotMap = buildSlotMap();
  const box = document.getElementById("hall");
  box.innerHTML = "";
  HALL_SLOTS.forEach(s=>{
    const id = slotMap[s] || null;
    const spot = document.createElement('div');
    spot.className = "spot";
    spot.innerHTML = `
      <div class="label">${esc(s)}</div>
      ${vehBlock(id)}
    `;
    box.appendChild(spot);
  });
}

/* Render garage */
function renderGarage(){
  const slotMap = buildSlotMap();
  const box = document.getElementById("garage");
  box.innerHTML = "";

  // Placement : G1,G6,G7,G8 en "vertical", G2‚ÄìG5 en "horizontal"
  GARAGE_SLOTS.forEach(s=>{
    const id = slotMap[s] || null;
    const div = document.createElement('div');
    const vertical = (s==="G1"||s==="G6"||s==="G7"||s==="G8");
    div.className = `spot ${vertical?'vertical':'horizontal'}`;
    div.innerHTML = `
      <div class="label">${esc(s)}</div>
      ${vehBlock(id)}
    `;
    box.appendChild(div);
  });
}

/* Roles */
function renderRoles(){
  const r = dispatchData._roles || {};
  const roleMap = [
    ["Officier de semaine", r.officier_semaine],
    ["Officier de garde", r.officier_garde],
    ["Resp. op√©rations", r.responsable_operations],
    ["Chef de groupe", r.chef_groupe],
    ["Chef de poste", r.chef_poste],
    ["1er centraliste", r.centraliste_1],
    ["2e centraliste", r.centraliste_2],
  ];
  document.getElementById("roles").innerHTML =
    roleMap.map(([lbl,val])=>`<div class="role"><span>${esc(lbl)}</span>${esc(val||"-")}</div>`).join("");
}

/* Banner (one-line infinite) */
function renderBanner(){
  const notes = dispatchData._notes || {};
  // OUT vehicles
  const outs = [];
  (vehList||[]).forEach(v=>{
    const d = dispatchData[v.id];
    if(d?.statut==="Indisponible"){
      let t = (v.name||v.id);
      if (d.attribution) t+=` [${d.attribution}]`;
      if (d.commentaire) t+=` ‚Äî ${d.commentaire}`;
      outs.push(t);
    }
  });

  const chunks = [];
  if (outs.length) chunks.push(`<span class="tag">V√âHICULE OUT</span><span>${esc(outs.join(" ‚Ä¢ "))}</span>`);
  if ((notes.materiel||"").trim()) chunks.push(`<span class="tag">MAT√âRIEL</span><span>${esc(notes.materiel.replace(/\s+/g,' ').trim())}</span>`);
  if ((notes.infos||"").trim()) chunks.push(`<span class="tag">INFOS</span><span>${esc(notes.infos.replace(/\s+/g,' ').trim())}</span>`);

  const content = chunks.length ? chunks.map(c=>`<span class="chunk">${c}</span>`).join("") : `<span class="chunk"><span>Aucune information</span></span>`;

  const track = content + content + content; // triple pour √©viter tout ‚Äúblanc‚Äù per√ßu
  document.getElementById('band1').innerHTML = track;
  document.getElementById('band2').innerHTML = track;
}

/* ====== Subscriptions ====== */
subscribeKey(DISPATCH_KEY, snap=>{
  dispatchData = snap || {};
  vehList = Array.isArray(dispatchData?._settings?.vehs) ? dispatchData._settings.vehs : [];
  renderRoles();
  renderHall();
  renderGarage();
  renderBanner();
});

subscribeKey(MISSIONS_KEY, snap=>{
  missionsByVeh = {};
  Object.entries(snap||{}).forEach(([id, m])=>{
    if(!m || typeof m!=="object") return;
    const veh = m.vehicule || m.veh || "";
    if(!veh) return;
    missionsByVeh[veh] = m; // on note la derni√®re mission par v√©hicule
  });
  // Re-coloriser les blocs
  renderHall();
  renderGarage();
});

/* First render placeholders */
renderRoles();
renderHall();
renderGarage();
renderBanner();
</script>
</body>
</html>
