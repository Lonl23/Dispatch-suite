<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tableau de garde – TV</title>
<style>
  :root{
    --bg:#0a0f16; --panel:#121821; --line:#1f2c3e;
    --text:#f1f5fa; --muted:#9bb5d3; --accent:#3a8bf2;
    --ok:#2e7d32; --info:#1976d2; --warn:#f4b400; --bad:#e74c3c;
    --badge:#0f1624; --ticker-bg:#a00020; --ticker-fg:#fff;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:Segoe UI,Inter,system-ui,sans-serif;overflow:hidden}

  /* Header */
  .header{display:flex;justify-content:space-between;align-items:center;padding:10px 18px;background:#0d1523;border-bottom:2px solid var(--line)}
  .header h1{margin:0;font-size:26px;color:#cfe1ff}
  .head-right{display:flex;gap:16px;align-items:center}
  .pill{background:#0f1624;border:1px solid #223146;border-radius:999px;padding:6px 10px;font-weight:600}

  /* Roles strip */
  .roles{display:flex;flex-wrap:wrap;gap:12px;justify-content:center;padding:8px 16px;background:#101a2a;border-bottom:1px solid var(--line)}
  .role{background:#142035;border:1px solid #223146;border-radius:8px;padding:6px 10px;min-width:150px;text-align:center}
  .role span{display:block;color:var(--muted);font-size:12px}

  /* Main split: left hall / right columns */
  .main{display:grid;grid-template-columns:1fr 1fr;gap:12px;height:calc(100vh - 160px);padding:12px;box-sizing:border-box;overflow:hidden}
  .leftPane,.rightPane{background:#0f1624;border:1px solid #223146;border-radius:12px;padding:10px;overflow:auto}

  /* Hall title + frame */
  .section-title{margin:0 0 8px 0;color:#cfe1ff;font-size:18px;text-align:center}
  .hall-frame{border:2px solid #33465f;border-radius:12px;padding:12px}
  /* Extérieur box */
  .ext-row{display:flex;justify-content:center}
  .slot.ext{width:92%;}

  /* Two columns hall grid like the photo */
  .hall-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:12px}
  .slot{
    background:#121e31;border:2px solid #425672;border-radius:10px;padding:8px 10px;min-height:64px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center
  }
  .slot .code{color:var(--muted);font-weight:700;letter-spacing:.5px;margin-bottom:6px}
  .slot .veh{font-size:16px;font-weight:800}
  .slot .sub{font-size:12px;color:#b8c9e0}
  .slot.empty{opacity:.6}
  .slot.ok{box-shadow:0 0 0 2px rgba(46,125,50,.35) inset}
  .slot.info{box-shadow:0 0 0 2px rgba(25,118,210,.35) inset}
  .slot.bad{box-shadow:0 0 0 2px rgba(231,76,60,.45) inset}
  .slot.reserve{box-shadow:0 0 0 2px rgba(244,180,0,.45) inset}

  /* Right status columns */
  .cols{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .col{background:#121b2a;border:1px solid #223146;border-radius:10px;display:flex;flex-direction:column;min-height:140px}
  .col h3{margin:0;padding:8px 6px;text-align:center;border-bottom:1px solid #223146;color:#cfe1ff}
  .col h3.ok{background:rgba(46,125,50,.15)}
  .col h3.info{background:rgba(25,118,210,.15)}
  .col h3.reserve{background:rgba(244,180,0,.15)}
  .col h3.bad{background:rgba(231,76,60,.15)}
  .list{padding:8px;display:flex;flex-direction:column;gap:8px}
  .vehCard{background:#1a2436;border:1px solid #2b3a51;border-radius:10px;padding:8px;text-align:center}
  .vehCard .name{font-weight:800}
  .vehCard .line{font-size:12px;color:#9bb5d3}

  /* Bottom banner (seamless) */
  .banner{position:absolute;left:0;right:0;bottom:0;height:44px;background:var(--ticker-bg);color:var(--ticker-fg);display:flex;align-items:center;overflow:hidden;border-top:1px solid #7a0016}
  .track{display:flex;gap:64px;white-space:nowrap;will-change:transform}
  .scroll{animation:marq 45s linear infinite}
  @keyframes marq{from{transform:translateX(0)}to{transform:translateX(-50%)}}
  .chunk{display:flex;align-items:center;gap:10px}
  .tag{background:#7a0016;border:1px solid #ffb3c1;border-radius:6px;padding:2px 8px;font-weight:800}

  /* Small helpers */
  .mut{color:var(--muted)}
</style>
</head>
<body>

<script src="store-bridge.js"></script>

<!-- Header -->
<div class="header">
  <h1>Tableau de garde</h1>
  <div class="head-right">
    <div id="meteo" class="pill">🌦 — °C</div>
    <div id="datetime" class="pill">--:--</div>
  </div>
</div>

<!-- Roles -->
<div id="roles" class="roles">Chargement des rôles…</div>

<!-- Main split -->
<div class="main">
  <!-- LEFT: HALL DES DÉPARTS -->
  <div class="leftPane">
    <h2 class="section-title">Hall des départs</h2>
    <div class="hall-frame">
      <div class="ext-row">
        <div class="slot ext" id="slot-EXT">
          <div class="code">Extérieur</div>
          <div class="mut">—</div>
        </div>
      </div>

      <div class="hall-grid">
        <!-- Colonne gauche : H6→H10 -->
        <div class="stack">
          <div class="slot" id="slot-H6"><div class="code">H6</div><div class="mut">—</div></div>
          <div class="slot" id="slot-H7"><div class="code">H7</div><div class="mut">—</div></div>
          <div class="slot" id="slot-H8"><div class="code">H8</div><div class="mut">—</div></div>
          <div class="slot" id="slot-H9"><div class="code">H9</div><div class="mut">—</div></div>
          <div class="slot" id="slot-H10"><div class="code">H10</div><div class="mut">—</div></div>
        </div>
        <!-- Colonne droite : H5→H1 -->
        <div class="stack">
          <div class="slot" id="slot-H5"><div class="code">H5</div><div class="mut">—</div></div>
          <div class="slot" id="slot-H4"><div class="code">H4</div><div class="mut">—</div></div>
          <div class="slot" id="slot-H3"><div class="code">H3</div><div class="mut">—</div></div>
          <div class="slot" id="slot-H2"><div class="code">H2</div><div class="mut">—</div></div>
          <div class="slot" id="slot-H1"><div class="code">H1</div><div class="mut">—</div></div>
        </div>
      </div>
    </div>
  </div>

  <!-- RIGHT: STATUS COLUMNS -->
  <div class="rightPane">
    <div class="cols">
      <div class="col"><h3 class="info">Sortis</h3><div id="col-sortis" class="list"></div></div>
      <div class="col"><h3 class="ok">Disponibles</h3><div id="col-dispo" class="list"></div></div>
      <div class="col"><h3 class="reserve">Réserve</h3><div id="col-reserve" class="list"></div></div>
      <div class="col"><h3 class="bad">Indisponibles</h3><div id="col-indispo" class="list"></div></div>
    </div>
  </div>
</div>

<!-- Banner -->
<div class="banner">
  <div class="track">
    <div id="band1" class="scroll"></div>
    <div id="band2" class="scroll" aria-hidden="true"></div>
  </div>
</div>

<script>
if(typeof readKey!=='function'){ alert("store-bridge.js manquant"); }

const KEY="dispatch_parc_vehicules";
let data={};

/* lib */
const $ = s => document.querySelector(s);
const esc = s => String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* date + heure */
function tick(){
  const d=new Date();
  const jours=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
  const mois=["janvier","février","mars","avril","mai","juin","juillet","août","septembre","octobre","novembre","décembre"];
  $('#datetime').textContent=`${jours[d.getDay()]} ${String(d.getDate()).padStart(2,'0')} ${mois[d.getMonth()]} ${d.getFullYear()} — ${d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
}
setInterval(tick,1000); tick();

/* meteo La Hulpe */
async function meteo(){
  try{
    const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=50.73&longitude=4.48&current=temperature_2m,weather_code&timezone=Europe/Brussels",{cache:"no-store"});
    const j=await r.json(); const t=j.current?.temperature_2m; const c=j.current?.weather_code;
    const map={0:"☀️",1:"🌤️",2:"⛅",3:"☁️",45:"🌫️",48:"🌫️",51:"🌦️",53:"🌦️",61:"🌧️",63:"🌧️",65:"🌧️",71:"❄️",95:"⛈️"};
    $('#meteo').textContent=`${map[c]||"🌤️"} ${t}°C La Hulpe`;
  }catch(e){/* noop */}
}
meteo(); setInterval(meteo, 10*60*1000);

/* roles */
const roleLabels={
  officier_semaine:"Officier de semaine",
  officier_garde:"Officier de garde",
  responsable_operations:"Resp. opérations",
  chef_groupe:"Chef de groupe",
  chef_poste:"Chef de poste",
  centraliste_1:"1er centraliste",
  centraliste_2:"2e centraliste"
};
function renderRoles(){
  const r=data._roles||{};
  $('#roles').innerHTML = Object.entries(roleLabels)
    .map(([k,l])=>`<div class="role"><span>${l}</span>${esc(r[k]||"-")}</div>`).join("");
}

/* hall des départs */
const H_SLOTS=["H6","H7","H8","H9","H10","H5","H4","H3","H2","H1"];
function clearHall(){
  $("#slot-EXT").innerHTML = `<div class="code">Extérieur</div><div class="mut">—</div>`;
  H_SLOTS.forEach(h=>{
    const el=$(`#slot-${h}`);
    if(el) el.innerHTML = `<div class="code">${h}</div><div class="mut">—</div>`;
    el?.classList.remove("ok","info","bad","reserve","empty");
  });
}
function slotClassForStatus(s){
  if(s==="Disponible") return "ok";
  if(s==="Sorti") return "info";
  if(s==="Indisponible") return "bad";
  if(s==="Réserve") return "reserve";
  return "";
}
function renderHall(){
  clearHall();
  const list=(data._settings?.vehs)||[];
  list.forEach(v=>{
    const d=data[v.id]||{};
    const emp=(v.emplacement||"").trim();
    const target = emp.toUpperCase()==="EXTÉRIEUR" || emp.toUpperCase()==="EXTERIEUR" || emp.toUpperCase()==="EXTERIOR" || emp.toUpperCase()==="EXTERIEUR"
      ? "#slot-EXT"
      : `#slot-${emp}`;
    const box=$(target);
    if(!box) return;
    const cl=slotClassForStatus(d.statut||"");
    box.classList.remove("ok","info","bad","reserve","empty");
    if(cl) box.classList.add(cl);
    box.innerHTML = `
      <div class="code">${emp===""?"—":(emp==="Extérieur"?"Extérieur":esc(emp))}</div>
      <div class="veh">${esc(d.name||v.id)}</div>
      <div class="sub">${d.attribution?`[${esc(d.attribution)}] `:""}${esc(d.plaque||"")}</div>
    `;
  });
  /* marque les emplacements vides en gris léger */
  ["#slot-EXT",...H_SLOTS.map(h=>`#slot-${h}`)].forEach(sel=>{
    const el=$(sel);
    if(el && el.querySelector('.veh')===null){ el.classList.add('empty'); }
  });
}

/* right columns */
function renderCols(){
  ["sortis","dispo","reserve","indispo"].forEach(id=> $(`#col-${id}`).innerHTML="");
  const vehs=(data._settings?.vehs)||[];
  vehs.forEach(v=>{
    const d=data[v.id]||{};
    let colId=null;
    if(d.statut==="Sorti") colId="col-sortis";
    else if(d.statut==="Disponible") colId="col-dispo";
    else if(d.statut==="Réserve") colId="col-reserve";
    else if(d.statut==="Indisponible") colId="col-indispo";
    if(!colId) return;
    const html=`
      <div class="vehCard">
        <div class="name">${esc(d.name||v.id)}</div>
        <div class="line">${d.attribution?`[${esc(d.attribution)}] `:""}${esc(d.plaque||"")}</div>
        <div class="line">${esc(v.emplacement||"—")}</div>
      </div>`;
    $(`#${colId}`).insertAdjacentHTML('beforeend',html);
  });
}

/* banner (seamless, no jump) */
function buildBanner(){
  const notes=data._notes||{};
  const outs=[];
  (data._settings?.vehs||[]).forEach(v=>{
    const d=data[v.id]; if(d?.statut==="Indisponible"){
      let t= (d.name||v.id);
      if(d.attribution) t+=` [${d.attribution}]`;
      if(d.commentaire) t+=` — ${d.commentaire}`;
      outs.push(t);
    }
  });
  const chunks=[];
  if(outs.length) chunks.push(`<span class="tag">VÉHICULE OUT</span><span>${esc(outs.join("  •  "))}</span>`);
  if((notes.materiel||"").trim()) chunks.push(`<span class="tag">MATÉRIEL</span><span>${esc(notes.materiel.replace(/\s+/g,' ').trim())}</span>`);
  if((notes.infos||"").trim())    chunks.push(`<span class="tag">INFOS</span><span>${esc(notes.infos.replace(/\s+/g,' ').trim())}</span>`);
  const content = chunks.length ? chunks.map(c=>`<span class="chunk">${c}</span>`).join('<span class="chunk">|</span>') : `<span class="chunk">Aucune information</span>`;
  const doubled = content + content;
  $('#band1').innerHTML=doubled;
  $('#band2').innerHTML=doubled;
}

/* refresh */
async function refresh(){
  try{
    data = await readKey(KEY) || {};
    renderRoles();
    renderHall();
    renderCols();
    buildBanner();
  }catch(e){
    console.error(e);
  }
}
refresh(); setInterval(refresh, 5000);

/* react to other tabs */
window.addEventListener('storage', e=>{
  if(e.key===KEY){ refresh(); }
});
</script>
</body>
</html>
