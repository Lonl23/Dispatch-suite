<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tableau de garde â€“ TV</title>
<style>
  :root{
    --bg:#0a0f16; --panel:#121821; --line:#1f2c3e;
    --text:#f1f5fa; --muted:#9bb5d3;
    --dispo-bg:#15351c;  --dispo-bd:#2e7d32;
    --indispo-bg:#3a1212;--indispo-bd:#e74c3c;
    --depart-bg:#7a6200; --depart-bd:#f0c000;
    --surplace-bg:#7a3f00;--surplace-bd:#ff9800;
    --hopital-bg:#3a006e;--hopital-bd:#9c27b0;
    --route-bg:#00416a;  --route-bd:#2196f3;
    --ticker-bg:#a00020; --ticker-fg:#fff;
  }

  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font-family:Segoe UI,Inter,system-ui,sans-serif;overflow:hidden}

  .header{display:flex;justify-content:space-between;align-items:center;
    padding:8px 16px;background:#0d1523;border-bottom:2px solid var(--line)}
  .header h1{margin:0;font-size:24px;color:#cfe1ff}
  .head-right{display:flex;gap:12px;align-items:center}
  .pill{background:#0f1624;border:1px solid #223146;border-radius:999px;
    padding:4px 10px;font-weight:600;font-size:14px}

  .roles{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;
    padding:6px 10px;background:#101a2a;border-bottom:1px solid #223146}
  .role{background:#142035; border:1px solid #223146; border-radius:8px;
    padding:4px 8px; min-width:140px;text-align:center;font-size:14px}
  .role span{display:block;color:#9bb5d3;font-size:11px}

  .main{display:grid;grid-template-columns:1fr 1fr;gap:10px;
    height:calc(100vh - 140px);padding:10px;box-sizing:border-box;overflow:hidden}
  .leftPane,.rightPane{background:#0f1624;border:1px solid #223146;border-radius:12px;
    padding:8px;overflow:auto}

  .section-title{margin:0 0 6px 0;color:#cfe1ff;font-size:16px;text-align:center}
  .hall-frame{border:2px solid #33465f;border-radius:10px;padding:10px}
  .ext-row{display:flex;justify-content:center;margin-bottom:10px}
  .slot.ext{width:92%}

  .hall-grid{display:grid;grid-template-columns:1fr 1fr;column-gap:12px;row-gap:10px}
  .stack{display:flex;flex-direction:column;gap:10px}

  .slot{
    background:#121e31;border:2px solid #425672;border-radius:10px;
    padding:6px 10px;min-height:80px;
    display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center
  }
  .slot .code{display:none}
  .slot .veh{font-size:16px;font-weight:800}
  .slot .sub{font-size:12px;color:#b8c9e0;margin-top:2px}

  .slot.dispo{background:var(--dispo-bg);border-color:var(--dispo-bd);}
  .slot.indispo{background:var(--indispo-bg);border-color:var(--indispo-bd);}
  .slot.depart{background:var(--depart-bg);border-color:var(--depart-bd);}
  .slot.surplace{background:var(--surplace-bg);border-color:var(--surplace-bd);}
  .slot.route{background:var(--route-bg);border-color:var(--route-bd);}
  .slot.hopital{background:var(--hopital-bg);border-color:var(--hopital-bd);}

  .cols{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .col{background:#121b2a;border:1px solid #223146;border-radius:10px;
    display:flex;flex-direction:column;min-height:120px}
  .col h3{margin:0;padding:6px;text-align:center;border-bottom:1px solid #223146;color:#cfe1ff;font-size:15px}
  .list{padding:6px;display:flex;flex-direction:column;gap:6px}
  .vehCard{background:#1a2436;border:1px solid #2b3a51;border-radius:8px;padding:6px;text-align:center}
  .vehCard .name{font-weight:800}
  .vehCard .line{font-size:12px;color:#9bb5d3}

  .banner{position:absolute;left:0;right:0;bottom:0;height:40px;background:var(--ticker-bg);
    color:var(--ticker-fg);display:flex;align-items:center;overflow:hidden;border-top:1px solid #7a0016}
  .track{display:flex;gap:48px;white-space:nowrap;will-change:transform}
  .scroll{animation:marq 45s linear infinite}
  @keyframes marq{from{transform:translateX(0)}to{transform:translateX(-50%)}}
  .chunk{display:flex;align-items:center;gap:10px}
  .tag{background:#7a0016;border:1px solid #ffb3c1;border-radius:6px;padding:2px 8px;font-weight:800}
</style>
</head>
<body>

<script src="store-bridge.js"></script>

<div class="header">
  <h1>Tableau de garde</h1>
  <div class="head-right">
    <div id="meteo" class="pill">ðŸŒ¦ â€” Â°C</div>
    <div id="datetime" class="pill">--:--</div>
  </div>
</div>

<div id="roles" class="roles">Chargement des rÃ´lesâ€¦</div>

<div class="main">
  <div class="leftPane">
    <h2 class="section-title">Hall des dÃ©parts</h2>
    <div class="hall-frame">
      <div class="ext-row">
        <div class="slot ext" id="slot-EXT"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
      </div>
      <div class="hall-grid">
        <div class="stack">
          <div class="slot" id="slot-H6"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
          <div class="slot" id="slot-H7"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
          <div class="slot" id="slot-H8"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
          <div class="slot" id="slot-H9"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
          <div class="slot" id="slot-H10"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
        </div>
        <div class="stack">
          <div class="slot" id="slot-H5"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
          <div class="slot" id="slot-H4"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
          <div class="slot" id="slot-H3"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
          <div class="slot" id="slot-H2"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
          <div class="slot" id="slot-H1"><div class="veh" style="opacity:.6">â€”</div><div class="sub"></div></div>
        </div>
      </div>
    </div>
  </div>

  <div class="rightPane">
    <div class="cols">
      <div class="col"><h3>Sortis</h3><div id="col-sortis" class="list"></div></div>
      <div class="col"><h3>Disponibles</h3><div id="col-dispo" class="list"></div></div>
      <div class="col"><h3>RÃ©serve</h3><div id="col-reserve" class="list"></div></div>
      <div class="col"><h3>Indisponibles</h3><div id="col-indispo" class="list"></div></div>
    </div>
  </div>
</div>

<div class="banner">
  <div class="track">
    <div id="band1" class="scroll"></div>
    <div id="band2" class="scroll" aria-hidden="true"></div>
  </div>
</div>

<script>
if(typeof readKey!=='function'){ alert("store-bridge.js manquant"); }

const KEY="dispatch_parc_vehicules";
let data={};

const $ = s => document.querySelector(s);
const esc = s => String(s??"").replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

/* Date + heure */
function tick(){
  const d=new Date();
  const jours=["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
  const mois=["janvier","fÃ©vrier","mars","avril","mai","juin","juillet","aoÃ»t","septembre","octobre","novembre","dÃ©cembre"];
  $('#datetime').textContent=`${jours[d.getDay()]} ${String(d.getDate()).padStart(2,'0')} ${mois[d.getMonth()]} ${d.getFullYear()} â€” ${d.toLocaleTimeString('fr-FR',{hour:'2-digit',minute:'2-digit'})}`;
}
setInterval(tick,1000); tick();

/* MÃ©tÃ©o */
async function meteo(){
  try{
    const r=await fetch("https://api.open-meteo.com/v1/forecast?latitude=50.73&longitude=4.48&current=temperature_2m,weather_code&timezone=Europe/Brussels",{cache:"no-store"});
    const j=await r.json();
    const t=j.current?.temperature_2m; const c=j.current?.weather_code;
    const map={0:"â˜€ï¸",1:"ðŸŒ¤ï¸",2:"â›…",3:"â˜ï¸",45:"ðŸŒ«ï¸",48:"ðŸŒ«ï¸",51:"ðŸŒ¦ï¸",53:"ðŸŒ¦ï¸",61:"ðŸŒ§ï¸",63:"ðŸŒ§ï¸",65:"ðŸŒ§ï¸",71:"â„ï¸",95:"â›ˆï¸"};
    $('#meteo').textContent=`${map[c]||"ðŸŒ¤ï¸"} ${t}Â°C La Hulpe`;
  }catch{}
}
meteo(); setInterval(meteo, 10*60*1000);

/* RÃ´les */
const roleLabels={
  officier_semaine:"Officier de semaine",
  officier_garde:"Officier de garde",
  responsable_operations:"Resp. opÃ©rations",
  chef_groupe:"Chef de groupe",
  chef_poste:"Chef de poste",
  centraliste_1:"1er centraliste",
  centraliste_2:"2e centraliste"
};
function renderRoles(){
  const r=data._roles||{};
  $('#roles').innerHTML = Object.entries(roleLabels)
    .map(([k,l])=>`<div class="role"><span>${l}</span>${esc(r[k]||"-")}</div>`).join("");
}

/* Codes couleur statuts */
function slotClassForStatus(s){
  switch(s){
    case "Disponible": return "dispo";
    case "Indisponible": return "indispo";
    case "DÃ©part": return "depart";
    case "Sur place": return "surplace";
    case "En route vers hÃ´pital": return "route";
    case "Ã€ l'hÃ´pital": return "hopital";
    case "Retour disponible": return "dispo";
    case "Retour indisponible": return "indispo";
    default: return "";
  }
}

/* Hall */
function renderHall(){
  const all=["H1","H2","H3","H4","H5","H6","H7","H8","H9","H10","EXT"];
  all.forEach(h=>{
    const el=$(`#slot-${h}`); if(!el) return;
    el.className="slot"+(h==="EXT"?" ext":"");
    el.querySelector('.veh').textContent="â€”";
    const sub=el.querySelector('.sub'); if(sub) sub.textContent="";
  });

  const list=(data._settings?.vehs)||[];
  list.forEach(v=>{
    const d=data[v.id]||{};
    const emp=(v.emplacement||"").trim();
    const target = /ext/i.test(emp) ? "#slot-EXT" : `#slot-${emp}`;
    const box=$(target); if(!box) return;
    const cl=slotClassForStatus(d.statut||"");
    if(cl) box.classList.add(cl);
    box.querySelector('.veh').textContent = (d.name||v.id);
    const sub = box.querySelector('.sub');
    if(sub) sub.textContent = `${d.attribution?`[${d.attribution}] `:""}${d.plaque||""}`;
  });
}

/* Colonnes droites */
function renderCols(){
  $("#col-sortis").innerHTML="";
  $("#col-dispo").innerHTML="";
  $("#col-reserve").innerHTML="";
  $("#col-indispo").innerHTML="";
  const vehs=(data._settings?.vehs)||[];
  vehs.forEach(v=>{
    const d=data[v.id]||{};
    let colId=null;
    if(d.statut==="Sorti") colId="col-sortis";
    else if(d.statut==="Disponible") colId="col-dispo";
    else if(d.statut==="RÃ©serve") colId="col-reserve";
    else if(d.statut==="Indisponible") colId="col-indispo";
    if(!colId) return;
    const html=`
      <div class="vehCard">
        <div class="name">${esc(d.name||v.id)}</div>
        <div class="line">${d.attribution?`[${esc(d.attribution)}] `:""}${esc(d.plaque||"")}</div>
      </div>`;
    $(`#${colId}`).insertAdjacentHTML('beforeend',html);
  });
}

/* BanniÃ¨re */
function buildBanner(){
  const notes=data._notes||{};
  const outs=[];
  (data._settings?.vehs||[]).forEach(v=>{
    const d=data[v.id]; if(d?.statut==="Indisponible"){
      let t= (d.name||v.id);
      if(d.attribution) t+=` [${d.attribution}]`;
      if(d.commentaire) t+=` â€” ${d.commentaire}`;
      outs.push(t);
    }
  });
  const chunks=[];
  if(outs.length) chunks.push(`<span class="tag">VÃ‰HICULE OUT</span><span>${esc(outs.join("  â€¢  "))}</span>`);
  if((notes.materiel||"").trim()) chunks.push(`<span class="tag">MATÃ‰RIEL</span><span>${esc(notes.materiel.replace(/\s+/g,' ').trim())}</span>`);
  if((notes.infos||"").trim()) chunks.push(`<span class="tag">INFOS</span><span>${esc(notes.infos.replace(/\s+/g,' ').trim())}</span>`);
  const content = chunks.length ? chunks.map(c=>`<span class="chunk">${c}</span>`).join('<span class="chunk">|</span>') : `<span class="chunk">Aucune information</span>`;
  const doubled = content + content;
  document.getElementById('band1').innerHTML=doubled;
  document.getElementById('band2').innerHTML=doubled;
}

/* Refresh */
async function refresh(){
  try{
    data = await readKey(KEY) || {};
    renderRoles();
    renderHall();
    renderCols();
    buildBanner();
  }catch(e){ console.error(e); }
}
refresh(); setInterval(refresh, 5000);
window.addEventListener('storage', e=>{ if(e.key===KEY) refresh(); });
</script>
</body>
</html>
