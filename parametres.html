<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Paramétrages – Véhicules</title>
<style>
  :root{--bg:#071022;--panel:#0f1724;--line:#213243;--txt:#eef3fb;--mut:#9fb3d0;--accent:#2f7bf6}
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:Segoe UI,Inter,Arial,sans-serif}
  h1{margin:16px auto;text-align:center;color:#cfe1ff}
  .wrap{max-width:1100px;margin:0 auto;padding:12px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
  label{font-size:13px;color:var(--mut)}
  input,select{width:100%;box-sizing:border-box;padding:6px 8px;border-radius:8px;border:1px solid var(--line);background:#081427;color:#fff}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border:1px solid var(--line);padding:6px;text-align:center}
  th{background:#13233b}
  .row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
  .mut{color:var(--mut);font-size:12px}
  .btn{background:var(--accent);color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .danger{background:#b23b3b}
  .warn{color:#ffcc66;margin:6px 0}
</style>
</head>
<body>

<!-- Guard simple -->
<script>
(function ensureAuth(){
  if(!localStorage.getItem("dispatch_idToken")) location.href="index.html";
})();
</script>

<script src="store-bridge.js"></script>

<h1>Paramétrages – Véhicules</h1>
<div class="wrap">
  <p class="warn" id="roleWarn" style="display:none">⚠️ Vous n’êtes pas connecté en tant que <b>centrale@acsrs.be</b> (lecture seule). Les modifications peuvent être refusées par la base.</p>

  <div class="card">
    <h3 style="margin:0 0 8px">Ajouter / Modifier un véhicule</h3>
    <div class="row">
      <div><label>ID (unique) – ex: AS 55</label><input id="v_id" placeholder="AS 55"></div>
      <div><label>Nom affiché</label><input id="v_name" placeholder="Ambulance 55"></div>
      <div><label>Attribution (LH1…LH8, Prev, LOG, TMS, OFF)</label><input id="v_attrib" placeholder="LH1"></div>
      <div><label>Plaque</label><input id="v_plaque" placeholder="1-ABC-123"></div>
    </div>
    <div style="margin-top:8px">
      <button class="btn" onclick="saveVeh()">Enregistrer</button>
      <button class="btn danger" onclick="delVeh()">Supprimer</button>
      <span class="mut">Sélectionne dans la liste pour pré-remplir / éditer.</span>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">Véhicules enregistrés</h3>
    <table>
      <thead>
        <tr>
          <th>ID</th><th>Nom</th><th>Attribution</th><th>Plaque</th>
        </tr>
      </thead>
      <tbody id="list"></tbody>
    </table>
  </div>
</div>

<script>
const STORAGE_KEY="dispatch_parc_vehicules";
let data={};
const isCentral=(localStorage.getItem("dispatch_email")||"").toLowerCase()==="centrale@acsrs.be";
if(!isCentral) document.getElementById('roleWarn').style.display='block';

const $=id=>document.getElementById(id);

function ensure(){
  if(!data || typeof data!=='object') data={};
  if(!data._settings) data._settings={vehs:[]};
  if(!data._roles) data._roles={
    officier_semaine:"",officier_garde:"",responsable_operations:"",
    chef_groupe:"",chef_poste:"",centraliste_1:"",centraliste_2:""
  };
  if(!data._notes) data._notes={materiel:"",infos:""};
}

function renderList(){
  const tb=$('list'); tb.innerHTML="";
  (data._settings.vehs||[]).forEach(v=>{
    tb.insertAdjacentHTML('beforeend',`
      <tr data-id="${v.id}" style="cursor:pointer">
        <td>${v.id}</td>
        <td>${v.name||""}</td>
        <td>${v.attrib||""}</td>
        <td>${v.plaque||""}</td>
      </tr>
    `);
  });
  tb.querySelectorAll('tr').forEach(tr=>{
    tr.onclick=()=>{
      const id=tr.dataset.id;
      const v=(data._settings.vehs||[]).find(x=>x.id===id)||{};
      $('v_id').value=id;
      $('v_name').value=v.name||"";
      $('v_attrib').value=v.attrib||"";
      $('v_plaque').value=v.plaque||"";
    };
  });
}

async function saveVeh(){
  const id=$('v_id').value.trim();
  if(!id){ alert("ID requis"); return; }
  const name=$('v_name').value.trim();
  const attrib=$('v_attrib').value.trim();
  const plaque=$('v_plaque').value.trim();

  // liste
  const idx=(data._settings.vehs||[]).findIndex(x=>x.id===id);
  const item={id,name,attrib,plaque};
  if(idx>=0) data._settings.vehs[idx]=item; else data._settings.vehs.push(item);

  // fiche véhicule
  data[id]=data[id]||{XO:"",S:"",PS:"",km:"",statut:"Disponible",commentaire:""};
  data[id].name=name; data[id].attribution=attrib; data[id].plaque=plaque;

  try{
    await saveKey(STORAGE_KEY,data);
    renderList();
    alert("Enregistré ✅");
  }catch(e){
    console.warn("Save refused",e);
    alert("Échec de l’enregistrement (compte non autorisé ?)");
  }
}

async function delVeh(){
  const id=$('v_id').value.trim();
  if(!id) return;
  if(!confirm(`Supprimer ${id} ?`)) return;

  data._settings.vehs=(data._settings.vehs||[]).filter(x=>x.id!==id);
  delete data[id];

  try{
    await saveKey(STORAGE_KEY,data);
    $('v_id').value=$('v_name').value=$('v_attrib').value=$('v_plaque').value="";
    renderList();
    alert("Supprimé ✅");
  }catch(e){
    console.warn("Delete refused",e);
    alert("Échec de la suppression (compte non autorisé ?)");
  }
}

async function boot(){
  if(typeof readKey!=='function'){ alert("store-bridge.js manquant"); return; }
  data=await readKey(STORAGE_KEY)||{};
  ensure();
  renderList();
}
boot();
</script>
</body>
</html>
