<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Param√©trages ‚Äî Parc v√©hicules</title>
<style>
  :root{ --bg:#0b0f14; --panel:#121821; --line:#223044; --txt:#e8eef5; --mut:#93a7bf; --accent:#3a8bf2; }
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:Inter,Segoe UI,Arial,sans-serif}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#0d131c;border-bottom:1px solid var(--line)}
  header h1{margin:0;font-size:20px;color:#cfe1ff}
  header .right{display:flex;gap:8px}
  .btn{background:var(--accent);border:0;color:#fff;border-radius:8px;padding:8px 12px;cursor:pointer;font-weight:600}
  .btn.ghost{background:#0f1520;border:1px solid #2c3d52}
  .wrap{padding:16px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid var(--line);padding:8px;text-align:left}
  th{background:#182030}
  .mut{color:var(--mut);font-size:12px}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2c3d52;font-size:12px}
  .actions{display:flex;gap:8px}
  dialog{border:1px solid #2c3d52;border-radius:12px;background:#0f1520;color:#fff;padding:16px;max-width:520px}
  dialog::backdrop{background:rgba(0,0,0,.5)}
  label{font-size:12px;color:#9fb2c9;display:block;margin-top:10px}
  input,select{width:100%;padding:8px;border-radius:8px;border:1px solid #2c3d52;background:#0b1626;color:#fff;box-sizing:border-box}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  @media (max-width:800px){ .row{grid-template-columns:1fr} }
</style>
</head>
<body>

<!-- Auth (d√©sactive si non utilis√©) -->
<script>
  // if(!localStorage.getItem("dispatch_idToken")) location.href = "index.html";
</script>

<script src="store-bridge.js"></script>

<header>
  <h1>Param√©trages ‚Äî Parc v√©hicules</h1>
  <div class="right">
    <button class="btn ghost" onclick="window.open('dispatch.html','_blank')">‚Ü©Ô∏è Dispatch</button>
    <button class="btn ghost" onclick="window.open('tv-grid.html','_blank')">üì∫ TV Grid</button>
    <button class="btn" id="btnAdd">‚ûï Nouveau v√©hicule</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <div class="mut" id="status">Chargement‚Ä¶</div>
    <table style="margin-top:10px">
      <thead>
        <tr>
          <th>V√©hicule</th>
          <th>Plaque</th>
          <th>Attribution</th>
          <th>Emplacement</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<!-- Modal add/edit -->
<dialog id="vehDialog">
  <form id="vehForm" method="dialog">
    <h3 id="dlgTitle" style="margin:0 0 8px 0">Nouveau v√©hicule</h3>
    <div class="row">
      <div>
        <label>Nom / ID du v√©hicule (ex: AS 55)</label>
        <input id="f_id" placeholder="AS 55" required>
      </div>
      <div>
        <label>Plaque</label>
        <input id="f_plaque" placeholder="1-ABC-123">
      </div>
    </div>
    <div class="row">
      <div>
        <label>Attribution</label>
        <select id="f_attr">
          <option value="">‚Äî</option>
          <option>LH1</option><option>LH2</option><option>LH3</option><option>LH4</option>
          <option>LH5</option><option>LH6</option><option>LH7</option><option>LH8</option>
          <option>TMS</option><option>PREV</option><option>OFF</option>
        </select>
      </div>
      <div>
        <label>Emplacement</label>
        <select id="f_place"></select>
      </div>
    </div>

    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
      <button class="btn ghost" type="button" onclick="vehDialog.close()">Annuler</button>
      <button class="btn" type="submit">Enregistrer</button>
    </div>
    <input type="hidden" id="f_mode" value="add">
    <input type="hidden" id="f_origId" value="">
    <input type="hidden" id="f_origEmp" value="">
  </form>
</dialog>

<script>
/* ======== Constantes ======== */
const DISPATCH_KEY = "dispatch_parc_vehicules";

/* ======== √âtat ======== */
let state = {};          // document complet
let vehs  = [];          // state._settings.vehs : [{id, plaque, attribution, emplacement}]
const $ = sel => document.querySelector(sel);

/* ======== Helpers ======== */
function ensureSettings(){
  state._settings = state._settings || {};
  state._settings.vehs = state._settings.vehs || [];
  vehs = state._settings.vehs;
}
function setStatus(msg){ $('#status').textContent = msg; }
function emplacementOptions(){
  const opts = [];
  for(let i=1;i<=10;i++) opts.push(`H${i}`);
  for(let i=1;i<=8;i++) opts.push(`G${i}`);
  opts.push('Ext√©rieur');
  return opts;
}
function fillEmplacementSelect(selectEl, value){
  selectEl.innerHTML = `<option value="">‚Äî</option>` + emplacementOptions().map(v=>`<option ${v===value?'selected':''}>${v}</option>`).join("");
}
function escapeHTML(s){ return String(s??"").replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function findVehById(id){ return vehs.find(x=>x.id===id) || null; }
function findVehByEmplacement(emp, exceptId=null){
  if(!emp) return null;
  const e = emp.trim();
  return vehs.find(v => (v.emplacement||"").trim()===e && v.id!==exceptId) || null;
}

/* ======== Chargement ======== */
async function loadAll(){
  if(typeof readKey!=='function'){ alert("store-bridge.js manquant ou incomplet."); return; }
  try{
    state = await readKey(DISPATCH_KEY) || {};
    ensureSettings();
    renderTable();
    setStatus(`Charg√© ‚Äî ${vehs.length} v√©hicule(s)`);
  }catch(e){
    console.error(e);
    setStatus("Erreur de lecture.");
  }
}

/* ======== Rendu ======== */
function renderTable(){
  const tb = $('#tbody'); tb.innerHTML = "";
  vehs.forEach(v=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><span class="tag">${escapeHTML(v.id)}</span></td>
      <td>${escapeHTML(v.plaque||"")}</td>
      <td>${escapeHTML(v.attribution||"")}</td>
      <td>${escapeHTML(v.emplacement||"")}</td>
      <td class="actions">
        <button class="btn ghost" onclick="onEdit('${encodeURIComponent(v.id)}')">√âditer</button>
        <button class="btn ghost" onclick="onRemove('${encodeURIComponent(v.id)}')">Supprimer</button>
      </td>
    `;
    tb.appendChild(tr);
  });
}

/* ======== Actions ======== */
function onAdd(){
  $('#dlgTitle').textContent = "Nouveau v√©hicule";
  $('#f_mode').value = "add";
  $('#f_origId').value = "";
  $('#f_origEmp').value = "";
  $('#f_id').value = "";
  $('#f_plaque').value = "";
  $('#f_attr').value = "";
  fillEmplacementSelect($('#f_place'), "");
  vehDialog.showModal();
}

function onEdit(encId){
  const id = decodeURIComponent(encId);
  const v = findVehById(id); if(!v) return;
  $('#dlgTitle').textContent = "√âditer le v√©hicule";
  $('#f_mode').value = "edit";
  $('#f_origId').value = v.id;
  $('#f_origEmp').value = v.emplacement || "";
  $('#f_id').value = v.id;
  $('#f_plaque').value = v.plaque||"";
  $('#f_attr').value = v.attribution||"";
  fillEmplacementSelect($('#f_place'), v.emplacement||"");
  vehDialog.showModal();
}

async function onRemove(encId){
  const id = decodeURIComponent(encId);
  if(!confirm(`Supprimer ${id} ?`)) return;
  const idx = vehs.findIndex(x=>x.id===id);
  if(idx>=0) vehs.splice(idx,1);
  await saveAll();
  renderTable();
}

/* ======== Soumission (avec unicit√© & √©change) ======== */
$('#vehForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const mode = $('#f_mode').value;
  const origId = $('#f_origId').value;
  const origEmp = $('#f_origEmp').value || "";
  const obj = {
    id: $('#f_id').value.trim(),
    plaque: $('#f_plaque').value.trim(),
    attribution: $('#f_attr').value || "",
    emplacement: $('#f_place').value || ""
  };
  if(!obj.id){ alert("Nom / ID requis"); return; }

  // Unicit√© de l'ID
  if(mode==="add" && vehs.some(v=>v.id===obj.id)){
    alert("Un v√©hicule avec ce nom existe d√©j√†."); return;
  }
  if(mode==="edit" && obj.id!==origId && vehs.some(v=>v.id===obj.id)){
    alert("Un v√©hicule avec ce nom existe d√©j√†."); return;
  }

  // Unicit√© de l'emplacement + logique d'√©change
  const conflict = findVehByEmplacement(obj.emplacement, mode==="edit" ? origId : null);
  if(conflict && obj.emplacement){
    if(mode==="edit"){
      const wantSwap = confirm(`L'emplacement ${obj.emplacement} est d√©j√† attribu√© √† ${conflict.id}.\n\nSouhaitez-vous √âCHANGER les emplacements entre ${origId} et ${conflict.id} ?`);
      if(!wantSwap) return; // abandon
      // √âchange : conflict prend l'ancien emplacement de ce v√©hicule
      const conflictIdx = vehs.findIndex(v=>v.id===conflict.id);
      if(conflictIdx>=0) vehs[conflictIdx].emplacement = origEmp || "";
      // Le v√©hicule √©dit√© prendra obj.emplacement (voir plus bas)
    }else{ // add
      const takeOver = confirm(`L'emplacement ${obj.emplacement} est d√©j√† attribu√© √† ${conflict.id}.\n\nSouhaitez-vous le retirer de ${conflict.id} et l'attribuer √† ce nouveau v√©hicule ?`);
      if(!takeOver) return;
      // Nouveau v√©hicule prend l'emplacement ; l'autre est lib√©r√©
      const conflictIdx = vehs.findIndex(v=>v.id===conflict.id);
      if(conflictIdx>=0) vehs[conflictIdx].emplacement = "";
    }
  }

  if(mode==="add"){
    vehs.push(obj);
  }else{
    const i = vehs.findIndex(v=>v.id===origId);
    if(i<0){ alert("V√©hicule introuvable."); return; }
    // si renommage, migrer l‚Äô√©tat courant (state[vehId])
    if(state[origId] && obj.id!==origId){
      state[obj.id] = state[origId];
      delete state[origId];
    }
    vehs[i] = obj;
  }

  await saveAll();
  vehDialog.close();
  renderTable();
});

/* ======== Sauvegarde ======== */
async function saveAll(){
  ensureSettings();
  state._settings.vehs = vehs;
  setStatus("Sauvegarde‚Ä¶");
  try{
    if(typeof writeKey==='function'){
      await writeKey(DISPATCH_KEY, state);
    }else if(typeof patchKey==='function'){
      await patchKey(DISPATCH_KEY, state);
    }else{
      localStorage.setItem(DISPATCH_KEY, JSON.stringify(state));
    }
    setStatus("Sauvegard√© ‚úîÔ∏é");
  }catch(e){
    console.error(e);
    setStatus("Erreur de sauvegarde.");
  }
}

/* ======== Sync & Boot ======== */
document.getElementById('btnAdd').addEventListener('click', onAdd);
window.addEventListener('storage', (e)=>{
  if(e.key===DISPATCH_KEY){
    try{ state = JSON.parse(e.newValue||"{}"); ensureSettings(); renderTable(); setStatus(`Synchro ‚Äî ${vehs.length} v√©hicule(s)`); }catch{}
  }
});
loadAll();
</script>
</body>
</html>
