<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Accueil ‚Äì Dispatch</title>
<style>
  :root{--bg:#071022;--panel:#0f1724;--line:#213243;--txt:#eef3fb;--mut:#9fb3d0;--accent:#2f7bf6;--ok:#2e7d32}
  html,body{margin:0;background:var(--bg);color:var(--txt);font-family:Segoe UI,Inter,Arial,sans-serif}
  .wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .card{background:var(--panel);padding:22px;border-radius:14px;box-shadow:0 6px 30px rgba(0,0,0,.5);border:1px solid var(--line)}
  .hidden{display:none}
  h1{margin:0 0 12px;font-size:22px}
  label{font-size:13px;color:var(--mut)}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid var(--line);background:#081427;color:#fff;margin-top:6px;margin-bottom:12px}
  button,.btn{display:inline-block;text-decoration:none;text-align:center;cursor:pointer;background:var(--accent);color:#fff;border:0;border-radius:10px;padding:10px 14px;font-weight:700}
  .mut{color:var(--mut);font-size:13px}
  .menu{display:grid;grid-template-columns:1fr 1fr;gap:16px;max-width:740px;width:100%}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:16px}
  .panel h2{margin:0 0 10px;font-size:18px;color:#cfe1ff}
  .grid-btn{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
  .topbar{position:fixed;top:0;left:0;right:0;background:#0b1426;border-bottom:1px solid var(--line);padding:8px 14px;display:flex;justify-content:space-between;align-items:center}
  .topbar .right{display:flex;gap:8px;align-items:center}
  .logout{background:#b23b3b}
</style>
</head>
<body>

<!-- Firebase (compat pour simplicit√©) -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

<div id="topbar" class="topbar hidden">
  <div><b>Dispatch</b> ‚Äî connect√© : <span id="who"></span></div>
  <div class="right">
    <a class="btn" href="tv-grid.html" target="_blank">Ouvrir une TV</a>
    <button class="btn logout" onclick="logout()">D√©connexion</button>
  </div>
</div>

<div class="wrap">
  <!-- Carte de connexion -->
  <div id="loginCard" class="card" style="width:360px">
    <h1>Connexion</h1>
    <label>Email</label>
    <input id="email" type="email" value="centrale@acsrs.be" />
    <label>Mot de passe</label>
    <input id="password" type="password" value="Password01$" />
    <button id="btnLogin">Se connecter</button>
    <p id="msg" class="mut" style="margin-top:10px"></p>
  </div>

  <!-- Menu des modes (apr√®s login) -->
  <div id="menuCard" class="menu hidden">
    <div class="panel">
      <h2>üõ†Ô∏è Mode √âdition</h2>
      <div class="grid-btn">
        <a class="btn" href="dispatch.html">Tableau de garde</a>
        <a class="btn" href="missions.html">Missions</a>
        <a class="btn" href="parametres.html" target="_blank">Param√©trages (nouvel onglet)</a>
      </div>
      <p class="mut" style="margin-top:8px">√âdition = √©critures autoris√©es (Firebase rules). Param√©trages s'ouvre dans un nouvel onglet.</p>
    </div>
    <div class="panel">
      <h2>üì∫ Mode Affichage</h2>
      <div class="grid-btn">
        <a class="btn" href="tv-grid.html" target="_blank">TV V√©hicules</a>
        <a class="btn" href="tv-missions.html" target="_blank">TV Missions</a>
      </div>
      <p class="mut" style="margin-top:8px">Affichage = lecture seule (possible de cr√©er un compte ‚Äútv@‚Äù d√©di√©).</p>
    </div>
  </div>
</div>

<script>
/* 1) Config Firebase ‚Äî remplace par la tienne */
const firebaseConfig = {
  apiKey: "AIzaSyCP6ZClAectP8OPneAeoYGYdRYO0CvnbnQ",
  authDomain: "racs-dispatch.firebaseapp.com",
  databaseURL: "https://racs-dispatch-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "racs-dispatch",
  storageBucket: "racs-dispatch.firebasestorage.app",
  messagingSenderId: "589135271261",
  appId: "1:589135271261:web:d080a5da49a061929b84b4"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

const loginCard = document.getElementById('loginCard');
const menuCard  = document.getElementById('menuCard');
const msg       = document.getElementById('msg');
const whoSpan   = document.getElementById('who');
const topbar    = document.getElementById('topbar');

document.getElementById('btnLogin').onclick = async ()=>{
  msg.textContent = "Connexion‚Ä¶";
  try{
    const res = await auth.signInWithEmailAndPassword(
      document.getElementById('email').value.trim(),
      document.getElementById('password').value
    );
    const idToken = await res.user.getIdToken(true);
    localStorage.setItem("dispatch_idToken", idToken);
    localStorage.setItem("dispatch_uid", res.user.uid);
    showMenu(res.user);
  }catch(e){
    console.error(e);
    msg.textContent = e.message || "Erreur de connexion";
  }
};

function showMenu(user){
  whoSpan.textContent = user.email || user.uid;
  topbar.classList.remove('hidden');
  loginCard.classList.add('hidden');
  menuCard.classList.remove('hidden');
}

function showLogin(){
  topbar.classList.add('hidden');
  menuCard.classList.add('hidden');
  loginCard.classList.remove('hidden');
}

function logout(){
  localStorage.removeItem("dispatch_idToken");
  localStorage.removeItem("dispatch_uid");
  auth.signOut().finally(()=>location.reload());
}

/* 2) Si d√©j√† connect√©, montrer directement le menu (pas de redirection auto) */
auth.onAuthStateChanged(async user=>{
  if(user){
    const t = await user.getIdToken();
    localStorage.setItem("dispatch_idToken", t);
    localStorage.setItem("dispatch_uid", user.uid);
    showMenu(user);
  }else{
    showLogin();
  }
});
</script>
</body>
</html>
